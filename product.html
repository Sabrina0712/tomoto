<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¢å“å±¥æ­·è©³æƒ…</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #f4f6f8; margin: 0; padding-bottom: 50px; }
        
        .header { background: #00bfa5; padding: 20px; color: white; text-align: center; }
        .container { max-width: 600px; margin: -30px auto 0; padding: 20px; position: relative; }
        
        .product-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .product-img { width: 100%; height: 250px; object-fit: cover; border-radius: 10px; background: #eee; }
        
        h1 { margin: 15px 0 5px; color: #333; }
        .meta-info { color: #666; font-size: 0.9em; margin-bottom: 15px; }
        
        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-box { padding: 15px; border-radius: 8px; margin-top: 15px; text-align: left; }
        .status-safe { background: #e8f5e9; border-left: 5px solid #2e7d32; }
        .status-locked { background: #ffebee; border-left: 5px solid #c62828; }
        
        .timeline { margin-top: 30px; text-align: left; }
        .timeline-item { border-left: 2px solid #ddd; padding-left: 20px; margin-bottom: 20px; position: relative; }
        .timeline-item::before { content: ''; position: absolute; left: -6px; top: 0; width: 10px; height: 10px; background: #00bfa5; border-radius: 50%; }
        .date { font-size: 0.85em; color: #888; }
        .action { font-weight: bold; color: #333; font-size: 1.1em; }
        .note { color: #555; margin-top: 5px; background: #f9f9f9; padding: 8px; border-radius: 5px; }

        .loading { font-size: 1.2em; color: #666; margin-top: 50px; text-align: center; }
        .error-msg { color: #d32f2f; font-weight: bold; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="header">
        <h2>ğŸ“¦ ç”¢å“å±¥æ­·é€æ˜åŒ–æŸ¥è©¢</h2>
        <a href="index.html" style="color:white; text-decoration:underline;">å›é¦–é </a>
    </div>

    <div class="container">
        <div id="product-display" style="display:none;">
            <div class="product-card">
                <img id="p-photo" src="" class="product-img" onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'">
                <h1 id="p-name">è¼‰å…¥ä¸­...</h1>
                <p class="meta-info">
                    ğŸ“ ç”¢åœ°ï¼š<span id="p-loc"></span><br>
                    ğŸ‘¨â€ğŸŒ¾ ç”Ÿç”¢è€…ï¼š<span id="p-farmer"></span><br>
                    ğŸ·ï¸ æ‰¹è™Ÿ IDï¼š<span id="p-id"></span>
                </p>

                <div id="safety-status"></div>
            </div>

            <div class="timeline">
                <h3>ğŸ“œ ç”Ÿç”¢æ­·ç¨‹ç´€éŒ„</h3>
                <div id="history-list">
                    </div>
            </div>
        </div>

        <div id="loading-msg" class="loading">â³ æ­£åœ¨å¾å€å¡Šéˆè®€å–è³‡æ–™...</div>
        <div id="error-msg" class="error-msg" style="display:none;"></div>
    </div>

    <script>
        // ğŸ”¥ é‡è¦ï¼šè«‹ç¢ºä¿é€™è£¡çš„åœ°å€èˆ‡è¾²å¤«é é¢ (Farmer) å®Œå…¨ä¸€è‡´ï¼
        const contractAddress = "0xf7ACEF0084b480F240643eaF9e292E7dd4B46d8F"; 

        // æœ€æ–°ç‰ˆ ABI (åŒ…å« getProduct å›å‚³ 5 å€‹åƒæ•¸)
        const contractABI = [
            {"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"getProduct","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"getHistory","outputs":[{"components":[{"internalType":"string","name":"date","type":"string"},{"internalType":"string","name":"action","type":"string"},{"internalType":"string","name":"note","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct AgProduct.Record[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"}
        ];

        let web3;
        let contract;

        window.onload = async function() {
            // 1. æŠ“å–ç¶²å€åƒæ•¸ ?id=P005
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!productId) {
                showError("âŒ ç¶²å€éŒ¯èª¤ï¼šæ²’æœ‰æŒ‡å®šç”¢å“ ID");
                return;
            }

            // 2. åˆå§‹åŒ– Web3
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(contractABI, contractAddress);
                loadProductData(productId);
            } else {
                showError("è«‹å®‰è£ MetaMask éŒ¢åŒ…ä»¥ç€è¦½å€å¡Šéˆæ•¸æ“š");
            }
        };

        async function loadProductData(id) {
            try {
                // è®€å–åŸºæœ¬è³‡æ–™
                // p çµæ§‹: [0]name, [1]loc, [2]farmer, [3]photo, [4]earliestHarvestDate
                const p = await contract.methods.getProduct(id).call();

                if (!p[0]) throw new Error("æŸ¥ç„¡æ­¤ IDï¼Œè«‹ç¢ºèªæ˜¯å¦å·²è¨»å†Šã€‚");

                document.getElementById("p-id").innerText = id;
                document.getElementById("p-name").innerText = p[0];
                document.getElementById("p-loc").innerText = p[1];
                document.getElementById("p-farmer").innerText = p[2];
                document.getElementById("p-photo").src = p[3];

                // ğŸ”¥ è™•ç†å®‰å…¨æ¡æ”¶æœŸç‹€æ…‹
                const unlockTime = parseInt(p[4]);
                const now = Math.floor(Date.now() / 1000);
                const statusDiv = document.getElementById("safety-status");

                if (unlockTime > now) {
                    const waitDays = ((unlockTime - now) / 86400).toFixed(1);
                    statusDiv.innerHTML = `
                        <div class="status-box status-locked">
                            <h3 style="margin:0 0 5px 0; color:#d32f2f;">â›” è—¥æª¢ç®¡åˆ¶é–å®šä¸­ (LOCKED)</h3>
                            <p style="margin:0; color:#c62828;">æ­¤ç”¢å“å°šåœ¨å®‰å…¨æ¡æ”¶æœŸè¦ç¯„å…§ã€‚<br>è·é›¢è§£ç¦é‚„éœ€ç­‰å¾…ç´„ <b>${waitDays}</b> å¤©ã€‚</p>
                        </div>`;
                } else {
                    statusDiv.innerHTML = `
                        <div class="status-box status-safe">
                            <h3 style="margin:0 0 5px 0; color:#2e7d32;">âœ… å®‰å…¨å¯é£Ÿ (SAFE)</h3>
                            <p style="margin:0; color:#388e3c;">ç¶“å€å¡Šéˆè‡ªå‹•é©—è­‰ï¼Œè—¥ç‰©æ®˜ç•™æœŸå·²éï¼Œæˆ–ç„¡æ–½è—¥ç´€éŒ„ã€‚</p>
                        </div>`;
                }

                // è®€å–æ­·å²ç´€éŒ„
                const history = await contract.methods.getHistory(id).call();
                const listDiv = document.getElementById("history-list");
                listDiv.innerHTML = ""; // æ¸…ç©º

                if (history.length === 0) {
                    listDiv.innerHTML = "<p>æš«ç„¡ç”Ÿç”¢ç´€éŒ„</p>";
                } else {
                    // åè½‰é™£åˆ—ï¼Œè®“æœ€æ–°çš„é¡¯ç¤ºåœ¨ä¸Šé¢
                    [...history].reverse().forEach(rec => {
                        let icon = "ğŸŒ±";
                        if(rec.action.includes("æ–½è—¥")) icon = "ğŸ’‰";
                        if(rec.action.includes("æ¡æ”¶")) icon = "ğŸ§º";
                        if(rec.action.includes("æ–½è‚¥")) icon = "ğŸ’©";

                        listDiv.innerHTML += `
                            <div class="timeline-item">
                                <div class="date">${rec.date}</div>
                                <div class="action">${icon} ${rec.action}</div>
                                <div class="note">${rec.note || "ç„¡å‚™è¨»"}</div>
                            </div>
                        `;
                    });
                }

                // é¡¯ç¤ºä»‹é¢
                document.getElementById("loading-msg").style.display = "none";
                document.getElementById("product-display").style.display = "block";

            } catch (err) {
                console.error(err);
                let msg = "è®€å–å¤±æ•—";
                if (err.message.includes("revert")) msg = "âŒ å€å¡Šéˆä¸ŠæŸ¥ç„¡æ­¤ç”¢å“ ID (è«‹ç¢ºèªè¾²å¤«æ˜¯å¦å·²è¨»å†Š)";
                showError(msg);
            }
        }

        function showError(msg) {
            document.getElementById("loading-msg").style.display = "none";
            const errDiv = document.getElementById("error-msg");
            errDiv.innerText = msg;
            errDiv.style.display = "block";
        }
    </script>

</body>
</html>

