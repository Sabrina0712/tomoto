<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¢å“å±¥æ­·è©³æƒ…</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #f4f6f8; margin: 0; padding-bottom: 50px; }
        
        .header { background: #00bfa5; padding: 20px; color: white; text-align: center; }
        .container { max-width: 600px; margin: -30px auto 0; padding: 20px; position: relative; }
        
        .product-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        
        /* åœ–ç‰‡å®¹å™¨ï¼šé è¨­ç°è‰²ï¼Œè¼‰å…¥æˆåŠŸæ‰é¡¯ç¤ºåœ–ç‰‡ */
        .img-container {
            width: 100%; height: 250px; 
            background-color: #eee; 
            border-radius: 10px; 
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; margin-bottom: 15px;
            color: #aaa; font-weight: bold;
        }
        .product-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        
        h1 { margin: 10px 0; color: #333; }
        .meta-info { color: #666; font-size: 0.95em; line-height: 1.8; margin-bottom: 20px; text-align: left; padding: 0 10px; }
        
        /* ç‹€æ…‹å¡ç‰‡ */
        .status-box { padding: 15px; border-radius: 8px; margin-top: 15px; text-align: left; border: 1px solid transparent; }
        .status-safe { background: #e8f5e9; border-left: 5px solid #2e7d32; color: #2e7d32; }
        .status-locked { background: #ffebee; border-left: 5px solid #c62828; color: #c62828; }
        
        /* æ™‚é–“è»¸æ¨£å¼ */
        .timeline { margin-top: 30px; text-align: left; }
        .timeline-item { border-left: 2px solid #ddd; padding-left: 20px; margin-bottom: 20px; position: relative; }
        .timeline-item::before { content: ''; position: absolute; left: -6px; top: 0; width: 10px; height: 10px; background: #00bfa5; border-radius: 50%; }
        .date { font-size: 0.85em; color: #888; }
        .action { font-weight: bold; color: #333; font-size: 1.1em; }
        .note { color: #555; margin-top: 5px; background: #f9f9f9; padding: 8px; border-radius: 5px; font-size: 0.9em;}

        .loading { font-size: 1.2em; color: #666; margin-top: 50px; text-align: center; }
        .error-msg { color: #d32f2f; font-weight: bold; text-align: center; margin-top: 20px; padding: 20px; background: #ffebee; border-radius: 8px; display: none;}
    </style>
</head>
<body>

    <div class="header">
        <h2>ğŸ“¦ ç”¢å“å±¥æ­·é€æ˜åŒ–æŸ¥è©¢</h2>
        <a href="index.html" style="color:white; text-decoration:underline;">å›é¦–é </a>
    </div>

    <div class="container">
        <div id="loading-msg" class="loading">â³ æ­£åœ¨è®€å–å€å¡Šéˆè³‡æ–™...</div>
        <div id="error-msg" class="error-msg"></div>

        <div id="product-display" style="display:none;">
            <div class="product-card">
                <div class="img-container">
                    <span id="no-img-text">ç„¡ç”¢å“ç…§ç‰‡</span>
                    <img id="p-photo" src="" class="product-img" onload="this.style.display='block'; document.getElementById('no-img-text').style.display='none';">
                </div>

                <h1 id="p-name">è¼‰å…¥ä¸­...</h1>
                
                <div class="meta-info">
                    ğŸ“ ç”¢åœ°ï¼š<span id="p-loc" style="color:#333; font-weight:bold;"></span><br>
                    ğŸ‘¨â€ğŸŒ¾ ç”Ÿç”¢è€…ï¼š<span id="p-farmer" style="color:#333; font-weight:bold;"></span><br>
                    ğŸ·ï¸ æ‰¹è™Ÿ IDï¼š<span id="p-id" style="font-family:monospace; background:#eee; padding:2px 5px; border-radius:3px;"></span>
                </div>

                <div id="safety-status"></div>
            </div>

            <div class="timeline">
                <h3>ğŸ“œ ç”Ÿç”¢å±¥æ­·ç´€éŒ„</h3>
                <div id="history-list"></div>
            </div>
        </div>
    </div>

    <script>
        // ğŸ”¥ğŸ”¥ğŸ”¥ é€™è£¡ä¸€å®šè¦æ›æˆæ‚¨è¾²å¤«é é¢é‚£ä¸€ä¸²åœ°å€ï¼ï¼ ğŸ”¥ğŸ”¥ğŸ”¥
        const contractAddress = "0xf7ACEF0084b480F240643eaF9e292E7dd4B46d8F"; 

        const contractABI = [
            {"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"getProduct","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"getHistory","outputs":[{"components":[{"internalType":"string","name":"date","type":"string"},{"internalType":"string","name":"action","type":"string"},{"internalType":"string","name":"note","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct AgProduct.Record[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"}
        ];

        let web3;
        let contract;

        window.onload = async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!productId) {
                showError("âŒ ç¶²å€éŒ¯èª¤ï¼šç¼ºå°‘ ID (ä¾‹å¦‚ ?id=P999)");
                return;
            }

            if (window.ethereum) {
                try {
                    web3 = new Web3(window.ethereum);
                    contract = new web3.eth.Contract(contractABI, contractAddress);
                    loadProductData(productId);
                } catch (e) {
                    showError("Web3 åˆå§‹åŒ–å¤±æ•—ï¼š" + e.message);
                }
            } else {
                showError("æ‰¾ä¸åˆ°éŒ¢åŒ…ï¼Œè«‹å®‰è£ MetaMask");
            }
        };

        async function loadProductData(id) {
            try {
                // è®€å–è³‡æ–™ï¼šä¾åºå°æ‡‰ åç¨±, ç”¢åœ°, è¾²å¤«, ç…§ç‰‡, æ™‚é–“æˆ³
                const p = await contract.methods.getProduct(id).call();

                // æª¢æŸ¥æ˜¯å¦æœ‰åå­—ï¼Œè‹¥ç„¡å‰‡ä»£è¡¨æŸ¥ç„¡æ­¤äºº
                if (!p[0]) throw new Error("æŸ¥ç„¡æ­¤ ID (è³‡æ–™ç‚ºç©º)");

                // å¡«å…¥è³‡æ–™
                document.getElementById("p-id").innerText = id;
                document.getElementById("p-name").innerText = p[0];
                document.getElementById("p-loc").innerText = p[1];
                document.getElementById("p-farmer").innerText = p[2];
                
                // åœ–ç‰‡è™•ç†
                if(p[3] && p[3].startsWith("http")) {
                    document.getElementById("p-photo").src = p[3];
                }

                // å®‰å…¨æœŸè¨ˆç®—
                const unlockTime = parseInt(p[4]);
                const now = Math.floor(Date.now() / 1000);
                const statusDiv = document.getElementById("safety-status");

                if (unlockTime > now) {
                    const waitDays = ((unlockTime - now) / 86400).toFixed(1);
                    statusDiv.innerHTML = `
                        <div class="status-box status-locked">
                            <h3>â›” è—¥æª¢ç®¡åˆ¶é–å®šä¸­</h3>
                            <p>æ­¤ç”¢å“å°šåœ¨å®‰å…¨æ¡æ”¶æœŸè¦ç¯„å…§ã€‚<br>è·é›¢è§£ç¦é‚„éœ€ç­‰å¾…ç´„ <b>${waitDays}</b> å¤©ã€‚</p>
                        </div>`;
                } else {
                    statusDiv.innerHTML = `
                        <div class="status-box status-safe">
                            <h3>âœ… å®‰å…¨å¯é£Ÿ (Safe)</h3>
                            <p>ç¶“å€å¡Šéˆè‡ªå‹•é©—è­‰ï¼Œè—¥ç‰©æ®˜ç•™æœŸå·²éï¼Œæˆ–ç„¡æ–½è—¥ç´€éŒ„ã€‚</p>
                        </div>`;
                }

                // æ­·å²ç´€éŒ„
                const history = await contract.methods.getHistory(id).call();
                const listDiv = document.getElementById("history-list");
                listDiv.innerHTML = ""; 

                if (history.length === 0) {
                    listDiv.innerHTML = "<p style='color:#999;'>å°šç„¡ç”Ÿç”¢ç´€éŒ„</p>";
                } else {
                    [...history].reverse().forEach(rec => {
                        let icon = "ğŸŒ±";
                        if(rec.action.includes("æ–½è—¥")) icon = "ğŸ’‰";
                        if(rec.action.includes("æ¡æ”¶")) icon = "ğŸ§º";
                        
                        listDiv.innerHTML += `
                            <div class="timeline-item">
                                <div class="date">${rec.date}</div>
                                <div class="action">${icon} ${rec.action}</div>
                                <div class="note">${rec.note || ""}</div>
                            </div>
                        `;
                    });
                }

                document.getElementById("loading-msg").style.display = "none";
                document.getElementById("product-display").style.display = "block";

            } catch (err) {
                console.error(err);
                showError("âŒ è®€å–å¤±æ•—ï¼š<br>" + err.message);
            }
        }

        function showError(msg) {
            document.getElementById("loading-msg").style.display = "none";
            const errDiv = document.getElementById("error-msg");
            errDiv.innerHTML = msg;
            errDiv.style.display = "block";
        }
    </script>
</body>
</html>

