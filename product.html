<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¢å“å±¥æ­·è©³æƒ…</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #fafafa; padding: 20px; }
        .card { max-width: 600px; margin: 20px auto; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
        
        .product-img { width: 100%; height: 300px; object-fit: cover; background: #eee; }
        .content { padding: 25px; }
        
        h1 { margin: 0 0 10px 0; color: #333; }
        .badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-bottom: 15px; }
        .safe { background: #e8f5e9; color: #2e7d32; border: 1px solid #4caf50; }
        .danger { background: #ffebee; color: #c62828; border: 1px solid #ef5350; }

        .info-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .label { color: #666; font-weight: bold; }
        
        .loading { text-align: center; padding: 50px; font-size: 1.2em; color: #666; }
        .error-msg { text-align: center; color: red; padding: 20px; }
    </style>
</head>
<body>

<div id="loading" class="loading">
    æ­£åœ¨å¾å€å¡Šéˆè®€å–è³‡æ–™...<br>
    <small>è«‹ç¨å€™</small>
</div>

<div id="product-card" class="card" style="display: none;">
    <img id="p-photo" class="product-img" src="" alt="ç”¢å“ç…§ç‰‡">
    <div class="content">
        <div id="p-status" class="badge">æª¢æŸ¥ä¸­...</div>
        <h1 id="p-name">ç”¢å“åç¨±</h1>
        <p style="color:#888; margin-top:0;">ID: <span id="p-id"></span></p>

        <div class="info-row">
            <span class="label">ğŸ‘¨â€ğŸŒ¾ ç”Ÿç”¢è€…</span>
            <span id="p-farmer">--</span>
        </div>
        <div class="info-row">
            <span class="label">ğŸ“ ç”¢åœ°</span>
            <span id="p-location">--</span>
        </div>
        <div class="info-row">
            <span class="label">ğŸ“… æœ€å¾Œæ›´æ–°</span>
            <span id="p-time">å‰›å‰›</span>
        </div>
        
        <div style="margin-top:20px; text-align:center;">
            <a href="index.html" style="color:#2196f3; text-decoration:none;">â† å›åˆ°é¦–é </a>
        </div>
    </div>
</div>

<script>
    // 1. è¨­å®šåˆç´„ (å¿…é ˆèˆ‡è¾²å¤«ç«¯ä¸€è‡´)
    const contractAddress = "0xdA79a8FDFf7ff6AD187c679Df7d6519b45b6C52f"; 
    
    // åªéœ€è¦è®€å–åŠŸèƒ½ï¼ŒABI æ¯”è¼ƒç°¡å–®
    const contractABI = [
        {"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"getProduct","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    window.onload = async function() {
        // 2. å¾ç¶²å€å–å¾— ID (ä¾‹å¦‚ product.html?id=P006)
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        if (!productId) {
            document.getElementById('loading').innerHTML = "âŒ éŒ¯èª¤ï¼šç¶²å€æ²’æœ‰ ID<br><a href='index.html'>å›é¦–é </a>";
            return;
        }

        // 3. é€£æ¥å€å¡Šéˆ (è®€å–ä¸éœ€è¦éŒ¢åŒ…æˆæ¬Šï¼Œåªè¦æœ‰ Web3 å³å¯)
        // ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œæˆ‘å€‘ç›´æ¥ç”¨å…¬é–‹ç¯€é»æˆ–ç€è¦½å™¨çš„ Provider
        let web3;
        if (window.ethereum) {
            web3 = new Web3(window.ethereum);
        } else {
            // å¦‚æœæ²’è£éŒ¢åŒ…ï¼Œå¯ä»¥ç”¨å…¬é–‹ç¯€é» (é€™è£¡å…ˆå‡è¨­æœ‰è£)
            alert("è«‹å®‰è£ MetaMask ä»¥è®€å–è³‡æ–™");
            return;
        }

        const contract = new web3.eth.Contract(contractABI, contractAddress);

        try {
            console.log("æ­£åœ¨æŸ¥è©¢ ID:", productId);
            const data = await contract.methods.getProduct(productId).call();
            
            // data çµæ§‹: [0]ID, [1]Name, [2]Location, [3]Farmer, [4]UnlockTime
            
            if (!data[0]) {
                throw new Error("å€å¡Šéˆä¸Šæ‰¾ä¸åˆ°æ­¤ ID");
            }

            // ... å‰é¢çš„ code ...

            // 4. é¡¯ç¤ºè³‡æ–™ (ä¿®æ­£å¾Œçš„å°æ‡‰é †åº)
            
            // ID ç›´æ¥ç”¨ç¶²å€ä¸Šçš„åƒæ•¸ (productId)ï¼Œå› ç‚ºåˆç´„å›å‚³çš„ç¬¬ä¸€å€‹æ¬„ä½ä¼¼ä¹ä¸æ˜¯ ID
            document.getElementById('p-id').innerText = productId; 
            
            // æ ¹æ“šä½ çš„æˆªåœ–æ¨ç®—çš„æ­£ç¢ºé †åºï¼š
            document.getElementById('p-name').innerText = data[0];     // 0 æ˜¯ åç¨± (åŸæœ¬éŒ¯æ”¾åˆ°ID)
            document.getElementById('p-location').innerText = data[1]; // 1 æ˜¯ ç”¢åœ° (åŸæœ¬éŒ¯æ”¾åˆ°æ¨™é¡Œ)
            document.getElementById('p-farmer').innerText = data[2];   // 2 æ˜¯ ç”Ÿç”¢è€…
            
            // è™•ç†ç…§ç‰‡ (è®€å– data[3])
            // å¦‚æœ data[3] æœ‰å€¼å°±ç”¨å®ƒï¼Œæ²’æœ‰å°±ç”¨é è¨­åœ–
            if (data[3] && data[3].startsWith('http')) {
                document.getElementById('p-photo').src = data[3];
            } else {
                document.getElementById('p-photo').src = "https://images.unsplash.com/photo-1571771894821-ce9b6c11b08e?w=600";
            }

            // 5. åˆ¤æ–·è—¥æª¢ç‹€æ…‹ (æ™‚é–“é€šå¸¸æ˜¯æœ€å¾Œä¸€å€‹ï¼Œå‡è¨­æ˜¯ data[4])
            const unlockTime = parseInt(data[4]); 
            
            // ... å¾Œé¢çš„ code ...

            if (now < unlockTime) {
                const waitDays = ((unlockTime - now) / 86400).toFixed(1);
                statusBadge.innerHTML = `â›” è—¥æª¢ç®¡åˆ¶ä¸­ (å°šéœ€ ${waitDays} å¤©)`;
                statusBadge.className = "badge danger";
            } else {
                statusBadge.innerHTML = `âœ… å®‰å…¨å¯é£Ÿç”¨`;
                statusBadge.className = "badge safe";
            }

            // åˆ‡æ›é¡¯ç¤º
            document.getElementById('loading').style.display = 'none';
            document.getElementById('product-card').style.display = 'block';

        } catch (err) {
            console.error(err);
            document.getElementById('loading').innerHTML = `<div class='error-msg'>è®€å–å¤±æ•—<br>${err.message}</div>`;
        }
    };
</script>

</body>
</html>

