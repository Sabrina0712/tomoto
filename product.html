<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¢å“å±¥æ­·è©³æƒ…</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #fafafa; padding: 20px; }
        .card { max-width: 600px; margin: 20px auto; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
        
        .product-img { width: 100%; height: 300px; object-fit: cover; background: #eee; }
        .content { padding: 25px; }
        
        h1 { margin: 0 0 10px 0; color: #333; }
        .badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-bottom: 15px; }
        .safe { background: #e8f5e9; color: #2e7d32; border: 1px solid #4caf50; }
        .danger { background: #ffebee; color: #c62828; border: 1px solid #ef5350; }

        .info-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .label { color: #666; font-weight: bold; }
        
        .loading { text-align: center; padding: 50px; font-size: 1.2em; color: #666; }
        .error-msg { text-align: center; color: red; padding: 20px; }
    </style>
</head>
<body>

<div id="loading" class="loading">
    æ­£åœ¨å¾å€å¡Šéˆè®€å–è³‡æ–™...<br>
    <small>è«‹ç¨å€™</small>
</div>

<div id="product-card" class="card" style="display: none;">
    <img id="p-photo" class="product-img" src="" alt="ç”¢å“ç…§ç‰‡">
    <div class="content">
        <div id="p-status" class="badge">æª¢æŸ¥ä¸­...</div>
        
        <h1 id="p-name">--</h1>
        <p style="color:#888; margin-top:0;">ID: <span id="p-id"></span></p>

        <div class="info-row">
            <span class="label">ğŸ‘¨â€ğŸŒ¾ ç”Ÿç”¢è€…</span>
            <span id="p-farmer">--</span>
        </div>
        <div class="info-row">
            <span class="label">ğŸ“ ç”¢åœ°</span>
            <span id="p-location">--</span>
        </div>
        <div class="info-row">
            <span class="label">ğŸ“… è³‡æ–™æŸ¥è©¢æ™‚é–“</span>
            <span id="p-time">å‰›å‰›</span>
        </div>
        
        <div style="margin-top:20px; text-align:center;">
            <a href="index.html" style="color:#2196f3; text-decoration:none;">â† å›åˆ°é¦–é </a>
        </div>
    </div>
</div>

<script>
    // 1. è¨­å®šåˆç´„ (å¿…é ˆèˆ‡è¾²å¤«ç«¯ä¸€è‡´)
    const contractAddress = "0xdA79a8FDFf7ff6AD187c679Df7d6519b45b6C52f"; 
    
    // 2. åˆç´„ ABI
    const contractABI = [
        {"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"getProduct","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    window.onload = async function() {
        // 3. å¾ç¶²å€å–å¾— ID (ä¾‹å¦‚ product.html?id=P006)
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        // å¦‚æœç¶²å€æ²’å¸¶ IDï¼Œé¡¯ç¤ºéŒ¯èª¤
        if (!productId) {
            document.getElementById('loading').innerHTML = "âŒ éŒ¯èª¤ï¼šç¶²å€æ²’æœ‰ ID<br><a href='index.html'>å›é¦–é </a>";
            return;
        }

        // 4. åˆå§‹åŒ– Web3
        let web3;
        if (window.ethereum) {
            web3 = new Web3(window.ethereum);
        } else {
            // å¦‚æœæ˜¯åœ¨æ‰‹æ©Ÿæˆ–å…¶ä»–æ²’è£éŒ¢åŒ…çš„ç’°å¢ƒï¼Œå»ºè­°ä½¿ç”¨å…¬é–‹ç¯€é» (é€™è£¡å…ˆç”¨ alert æç¤º)
            alert("è«‹ç¢ºä¿ç€è¦½å™¨æœ‰å®‰è£ MetaMask æˆ–æ˜¯ Web3 ç’°å¢ƒ");
            web3 = new Web3(window.ethereum); // å˜—è©¦é€£ç·š
        }

        const contract = new web3.eth.Contract(contractABI, contractAddress);

        try {
            console.log("æ­£åœ¨æŸ¥è©¢ ID:", productId);
            
            // å‘¼å«åˆç´„
            const data = await contract.methods.getProduct(productId).call();
            
            // æª¢æŸ¥æ˜¯å¦å›å‚³ç©ºå€¼ (å¦‚æœåå­—ä¹Ÿæ˜¯ç©ºçš„ï¼Œä»£è¡¨æ²’é€™å€‹ç”¢å“)
            if (!data[0]) {
                throw new Error("å€å¡Šéˆä¸Šæ‰¾ä¸åˆ°æ­¤ ID");
            }

            // === é—œéµä¿®æ­£å€åŸŸ ===
            
            // 1. å®šç¾©æ™‚é–“ (è§£æ±º now is not defined éŒ¯èª¤)
            const now = Math.floor(Date.now() / 1000);
            const unlockTime = parseInt(data[4]); // å€å¡Šéˆå›å‚³çš„æ™‚é–“æˆ³è¨˜

            // 2. è³‡æ–™å¡«å…¥ (ä¿®æ­£æ¬„ä½å°æ‡‰é †åº)
            document.getElementById('p-id').innerText = productId;
            document.getElementById('p-name').innerText = data[0];      // åç¨±
            document.getElementById('p-location').innerText = data[1];  // ç”¢åœ°
            document.getElementById('p-farmer').innerText = data[2];    // ç”Ÿç”¢è€…

            // 3. åœ–ç‰‡è™•ç†
            if (data[3] && data[3].startsWith('http')) {
                document.getElementById('p-photo').src = data[3];
            } else {
                // é è¨­åœ–ç‰‡
                document.getElementById('p-photo').src = "https://images.unsplash.com/photo-1571771894821-ce9b6c11b08e?w=600";
            }

            // 4. è—¥æª¢ç‹€æ…‹åˆ¤æ–·é‚è¼¯
            const statusBadge = document.getElementById('p-status');

            if (now < unlockTime) {
                // é–å®šä¸­ (å±éšª)
                const waitDays = ((unlockTime - now) / 86400).toFixed(1);
                statusBadge.innerHTML = `â›” è—¥æª¢ç®¡åˆ¶ä¸­ (å°šéœ€ ${waitDays} å¤©)`;
                statusBadge.className = "badge danger";
            } else {
                // å·²è§£é– (å®‰å…¨)
                statusBadge.innerHTML = `âœ… å®‰å…¨å¯é£Ÿç”¨`;
                statusBadge.className = "badge safe";
            }

            // 5. é¡¯ç¤ºå¡ç‰‡ï¼Œéš±è— Loading
            document.getElementById('loading').style.display = 'none';
            document.getElementById('product-card').style.display = 'block';

        } catch (err) {
            console.error(err);
            document.getElementById('loading').innerHTML = `<div class='error-msg'>è®€å–å¤±æ•—<br>${err.message}</div>`;
        }
    };
</script>

</body>
</html>
