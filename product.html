<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾²ç”¢å“å®‰å¿ƒå±¥æ­· (å€å¡Šéˆç‰ˆ)</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
</head>
<body>

    <div class="container">
        <header>
            <img id="product-img" src="" alt="è®€å–ä¸­..." class="hero-img" style="display:none; max-width: 100%; height: auto;">
            <div class="status-badge">ç”¢éŠ·å±¥æ­·é©—è­‰ (å€å¡Šéˆå­˜è­‰)</div>
        </header>

        <main>
            <section class="info-card">
                <h1 id="product-name">æ­£åœ¨è®€å–å€å¡Šéˆè³‡æ–™...</h1>
                <p class="farmer">ğŸ‘¨â€ğŸŒ¾ ç”Ÿç”¢è€…ï¼š<span id="farmer-name">--</span></p>
                
                <div class="details-grid">
                    <div class="detail-item">
                        <span class="label">ç”¢åœ°</span>
                        <span class="value" id="location">--</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">æ‰¹æ¬¡ç·¨è™Ÿ</span>
                        <span class="value" id="batch-id">--</span>
                    </div>
                </div>
            </section>

            <section class="timeline-section">
                <h3>ğŸŒ± ç”Ÿç”¢ç´€éŒ„ (ä¸å¯ç¯¡æ”¹)</h3>
                <div class="timeline" id="timeline-box">
                    <p>è¼‰å…¥ä¸­...</p>
                </div>
            </section>
        </main>

    </div>

    <script>
        // â–¼â–¼â–¼ è«‹åœ¨é€™è£¡è²¼ä¸Šä½ çš„æ–°åˆç´„åœ°å€ â–¼â–¼â–¼
        const contractAddress = "0xB138FA386A0d043fd55Ea450Bc8D90e22D0d6C38"; 
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        // åˆç´„çš„èªªæ˜æ›¸ (ABI) - åŒ…å«ç…§ç‰‡åŠŸèƒ½
        const contractABI = [
            {
                "inputs": [{"internalType": "string","name": "_id","type": "string"}],
                "name": "getProduct",
                "outputs": [
                    {"internalType": "string","name": "","type": "string"}, // 0: Name
                    {"internalType": "string","name": "","type": "string"}, // 1: Location
                    {"internalType": "string","name": "","type": "string"}, // 2: Farmer
                    {"internalType": "string","name": "","type": "string"}  // 3: PhotoUrl
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "string","name": "_id","type": "string"}],
                "name": "getHistory",
                "outputs": [
                    {"internalType": "string[]","name": "","type": "string[]"}, // Dates
                    {"internalType": "string[]","name": "","type": "string[]"}  // Actions
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        let web3;
        let contract;

        window.addEventListener('load', async () => {
            // 1. æŠ“å–ç¶²å€ä¸Šçš„ ID (ä¾‹å¦‚ ?id=P001)
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            // é¡¯ç¤ºç›®å‰æŸ¥è©¢çš„ ID
            if(productId) {
                document.getElementById('batch-id').innerText = productId;
            } else {
                document.getElementById('product-name').innerText = "âŒ æœªæŒ‡å®šç”¢å“ç·¨è™Ÿ";
                return;
            }

            // 2. é€£æ¥å€å¡Šéˆ
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    contract = new web3.eth.Contract(contractABI, contractAddress);
                    console.log("å€å¡Šéˆé€£ç·šæˆåŠŸï¼Œé–‹å§‹æŠ“å–è³‡æ–™...");
                    await loadProductData(productId);
                } catch (error) {
                    console.error("é€£ç·šéŒ¯èª¤:", error);
                }
            } else {
                alert("è«‹å®‰è£ MetaMask éŒ¢åŒ…æ‰èƒ½è®€å–å€å¡Šéˆè³‡æ–™ï¼");
            }
        });

        async function loadProductData(id) {
            try {
                // --- A. è®€å–åŸºæœ¬è³‡æ–™ ---
                const product = await contract.methods.getProduct(id).call();

                // æª¢æŸ¥æ˜¯å¦æœ‰è³‡æ–™ (åå­—æ˜¯å¦ç‚ºç©º)
                if (!product[0]) {
                    document.getElementById('product-name').innerText = "æŸ¥ç„¡æ­¤ç”¢å“è³‡æ–™";
                    document.getElementById('timeline-box').innerHTML = "<p>å€å¡Šéˆä¸Šæ‰¾ä¸åˆ°ç·¨è™Ÿ <b>" + id + "</b> çš„ç´€éŒ„ã€‚</p>";
                    return;
                }

                // å¡«å…¥è³‡æ–™
                document.getElementById('product-name').innerText = product[0]; // åç¨±
                document.getElementById('location').innerText = product[1];     // ç”¢åœ°
                document.getElementById('farmer-name').innerText = product[2];  // è¾²å¤«

                // è™•ç†ç…§ç‰‡
                const imgElement = document.getElementById('product-img');
                if (product[3] && product[3].startsWith('http')) {
                    imgElement.src = product[3];
                    imgElement.style.display = 'block'; // æœ‰ç…§ç‰‡å°±é¡¯ç¤º
                } else {
                    imgElement.style.display = 'none';  // æ²’ç…§ç‰‡å°±éš±è—
                }

                // --- B. è®€å–å±¥æ­· ---
                const history = await contract.methods.getHistory(id).call();
                const dates = history[0];
                const actions = history[1];
                
                const timelineBox = document.getElementById('timeline-box');
                timelineBox.innerHTML = ""; // æ¸…ç©ºè¼‰å…¥ä¸­æ–‡å­—

                if (dates.length === 0) {
                    timelineBox.innerHTML = "<p>âš ï¸ ç›®å‰å°šç„¡ç”Ÿç”¢ç´€éŒ„</p>";
                } else {
                    // å»ºç«‹å±¥æ­·åˆ—è¡¨ (ä½¿ç”¨åŸæœ¬çš„ timeline æ¨£å¼ï¼Œé€™è£¡ç”¨ç°¡å–®çš„ div æ¨¡æ“¬)
                    let html = '<ul style="list-style: none; padding: 0;">';
                    for (let i = 0; i < dates.length; i++) {
                        html += `
                            <li style="margin-bottom: 15px; border-left: 3px solid #4CAF50; padding-left: 10px;">
                                <strong style="color: #2e7d32;">${dates[i]}</strong>
                                <div style="color: #555;">${actions[i]}</div>
                            </li>
                        `;
                    }
                    html += '</ul>';
                    timelineBox.innerHTML = html;
                }

            } catch (err) {
                console.error("è®€å–å¤±æ•—:", err);
                alert("è®€å–è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèªåˆç´„åœ°å€æ˜¯å¦æ­£ç¢ºï¼");
            }
        }
    </script>
</body>
</html>

