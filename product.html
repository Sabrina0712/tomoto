<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¢å“å±¥æ­·è©³æƒ…</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        
        /* --- å¡ç‰‡ä¸»é«” --- */
        .card { 
            max-width: 500px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            overflow: hidden; 
            padding: 30px;
        }

        /* --- é ‚éƒ¨ç”¢å“è³‡è¨Š --- */
        .header-section { text-align: center; margin-bottom: 25px; }
        .product-icon { width: 100px; height: 100px; object-fit: cover; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .product-name { font-size: 2em; color: #2e7d32; margin: 5px 0; font-weight: bold; }
        .farmer-name { color: #666; font-size: 1.1em; }

        /* --- ç‹€æ…‹è­¦å‘Šæ¡† --- */
        .status-box {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 25px;
            border: 2px solid #ddd;
        }
        /* å±éšªç‹€æ…‹ (ç´…) */
        .status-danger { background-color: #ffebee; border-color: #ef5350; color: #c62828; }
        .status-danger h3 { margin: 0 0 5px 0; font-size: 1.1em; }
        
        /* å®‰å…¨ç‹€æ…‹ (ç¶ ) */
        .status-safe { background-color: #e8f5e9; border-color: #4caf50; color: #2e7d32; }

        /* --- è³‡è¨Šæ ¼ç‹€æ’ç‰ˆ --- */
        .info-grid { display: flex; gap: 15px; margin-bottom: 30px; }
        .info-item {
            flex: 1; 
            background: #f1f8e9;
            padding: 15px;
            border-radius: 10px;
        }
        .info-label { font-size: 0.85em; color: #777; display: block; margin-bottom: 5px; }
        .info-value { font-size: 1.1em; font-weight: bold; color: #333; }

        /* --- ç”Ÿç”¢å±¥æ­·ç´€éŒ„ (æ™‚é–“è»¸æ ¸å¿ƒæ¨£å¼) --- */
        .timeline-section { margin-top: 20px; }
        .timeline-header { font-size: 1.2em; font-weight: bold; margin-bottom: 20px; display: flex; align-items: center; }
        .timeline-header::before { content: "ğŸŒ±"; margin-right: 8px; }

        .timeline {
            position: relative;
            padding-left: 20px; /* å·¦é‚Šç•™ç©ºçµ¦åœ“é» */
            border-left: 3px solid #eee; /* ç°è‰²çš„ç›´ç·š */
            margin-left: 10px;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            padding-left: 15px;
        }
        
        /* ç¹ªè£½åœ“é» */
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px; /* èª¿æ•´åœ“é»ä½ç½®ä»¥å°é½Šç›´ç·š */
            top: 6px;
            width: 12px;
            height: 12px;
            background: #ccc; /* é è¨­ç°è‰² */
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 2px #eee;
        }

        /* æ´»èºç‹€æ…‹çš„åœ“é» (æœ€æ–°ä¸€ç­†) */
        .timeline-item.active::before {
            background: #ef5350; /* ç´…è‰² */
            width: 14px;
            height: 14px;
            left: -25px;
            box-shadow: 0 0 0 3px #ffebee;
        }
        /* å®‰å…¨ç‹€æ…‹çš„åœ“é» (ç¶ è‰²) */
        .timeline-item.safe-active::before {
            background: #4caf50;
            box-shadow: 0 0 0 3px #e8f5e9;
        }

        .t-date { font-size: 0.85em; color: #999; margin-bottom: 5px; display: block; }
        .t-title { font-size: 1.1em; font-weight: bold; color: #444; }
        .t-desc { font-size: 0.9em; color: #666; margin-top: 3px; }

        /* --- Loading --- */
        .loading { text-align: center; padding: 50px; color: #666; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="loading" class="loading">
    æ­£åœ¨è®€å–å€å¡Šéˆè³‡æ–™...
</div>

<div id="product-card" class="card hidden">
    <div class="header-section">
        <img id="p-photo" class="product-icon" src="" alt="ç”¢å“">
        <h1 id="p-name" class="product-name">--</h1>
        <div class="farmer-name">ğŸ‘¨â€ğŸŒ¾ ç”Ÿç”¢è€…ï¼š<span id="p-farmer">--</span></div>
    </div>

    <div id="status-container" class="status-box">
        è®€å–ä¸­...
    </div>

    <div class="info-grid">
        <div class="info-item">
            <span class="info-label">ç”¢åœ° Location</span>
            <div id="p-location" class="info-value">--</div>
        </div>
        <div class="info-item">
            <span class="info-label">æ‰¹æ¬¡ ID</span>
            <div id="p-id" class="info-value">--</div>
        </div>
    </div>

    <div class="timeline-section">
        <div class="timeline-header">ç”Ÿç”¢å±¥æ­·ç´€éŒ„</div>
        <div class="timeline">
            
            <div class="timeline-item">
                <span class="t-date">2026-01-22</span>
                <span class="t-title">ç¨®æ¤</span>
                <div class="t-desc">å®Œæˆå¹¼è‹—å®šæ¤ä½œæ¥­</div>
            </div>

            <div class="timeline-item">
                <span class="t-date">2026-01-23</span>
                <span class="t-title">æ–½è‚¥</span>
                <div class="t-desc">ä½¿ç”¨æœ‰æ©Ÿè¤‡åˆè‚¥æ–™</div>
            </div>

            <div id="timeline-latest" class="timeline-item active">
                <span id="record-date" class="t-date">--</span>
                <span id="record-action" class="t-title">è®€å–ä¸­...</span>
                <div id="record-desc" class="t-desc">--</div>
            </div>

        </div>
    </div>
</div>

<script>
    const contractAddress = "0xdA79a8FDFf7ff6AD187c679Df7d6519b45b6C52f"; 
    const contractABI = [
        {"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"getProduct","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    window.onload = async function() {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        if (!productId) {
            document.getElementById('loading').innerHTML = "âŒ ç¶²å€ç¼ºå°‘ ID";
            return;
        }

        let web3;
        if (window.ethereum) {
            web3 = new Web3(window.ethereum);
        } else {
            // å…¬é–‹ç¯€é»å‚™ç”¨ (å»ºè­°ç”¨è‡ªå·±çš„ç¯€é»æˆ–å¼·åˆ¶å®‰è£ MetaMask)
            alert("è«‹ç¢ºä¿ç€è¦½å™¨æœ‰å®‰è£ MetaMask");
            web3 = new Web3(window.ethereum);
        }

        const contract = new web3.eth.Contract(contractABI, contractAddress);

        try {
            const data = await contract.methods.getProduct(productId).call();
            if (!data[0]) throw new Error("ç„¡æ­¤ç”¢å“è³‡æ–™");

            // --- 1. å®šç¾©è®Šæ•¸ ---
            const now = Math.floor(Date.now() / 1000);
            const unlockTime = parseInt(data[4]);
            
            // --- 2. å¡«å…¥æ–‡å­—è³‡æ–™ ---
            document.getElementById('p-id').innerText = productId;
            document.getElementById('p-name').innerText = data[0];
            document.getElementById('p-location').innerText = data[1];
            document.getElementById('p-farmer').innerText = data[2];

            // --- 3. è™•ç†åœ–ç‰‡ ---
            if (data[3] && data[3].startsWith('http')) {
                document.getElementById('p-photo').src = data[3];
            } else {
                document.getElementById('p-photo').src = "https://cdn-icons-png.flaticon.com/512/2909/2909808.png";
            }

            // --- 4. è™•ç†è—¥æª¢ç‹€æ…‹èˆ‡æ™‚é–“è»¸ ---
            const statusContainer = document.getElementById('status-container');
            const timelineLatest = document.getElementById('timeline-latest');
            const recordAction = document.getElementById('record-action');
            const recordDesc = document.getElementById('record-desc');
            const recordDate = document.getElementById('record-date');

            // è¨­å®šä»Šå¤©æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            recordDate.innerText = today;

            if (now < unlockTime) {
                // === å±éšªç‹€æ…‹ (ç®¡åˆ¶ä¸­) ===
                const waitDays = ((unlockTime - now) / 86400).toFixed(1);
                
                // å¤§æ¡†æ¡†è¨­å®š
                statusContainer.className = "status-box status-danger";
                statusContainer.innerHTML = `
                    <h3>â›” æ­¤ç”¢å“è™•æ–¼è—¥æª¢ç®¡åˆ¶æœŸ</h3>
                    <p>é‚„æœ‰ ${waitDays} å¤©æ‰å¯å®‰å…¨æ¡æ”¶</p>
                `;

                // æ™‚é–“è»¸è¨­å®š (ç´…è‰²)
                timelineLatest.className = "timeline-item active"; // active å°æ‡‰ç´…è‰²
                recordAction.innerText = "æ–½è—¥ï¼šç´ä¹ƒå¾— (ç®¡åˆ¶ä¸­)";
                recordAction.style.color = "#c62828";
                recordDesc.innerText = "å·²ä¸Šå‚³è—¥æª¢æ•¸æ“šè‡³å€å¡Šéˆ";

            } else {
                // === å®‰å…¨ç‹€æ…‹ (å¯é£Ÿç”¨) ===
                
                // å¤§æ¡†æ¡†è¨­å®š
                statusContainer.className = "status-box status-safe";
                statusContainer.innerHTML = `
                    <h3>âœ… å®‰å…¨å¯é£Ÿç”¨</h3>
                    <p>è—¥æª¢æœŸå·²éï¼Œè«‹å®‰å¿ƒäº«ç”¨</p>
                `;

                // æ™‚é–“è»¸è¨­å®š (ç¶ è‰²)
                timelineLatest.className = "timeline-item safe-active"; // safe-active å°æ‡‰ç¶ è‰²
                recordAction.innerText = "æª¢é©—åˆæ ¼ (å¯æ¡æ”¶)";
                recordAction.style.color = "#2e7d32";
                recordDesc.innerText = "ç¬¦åˆå®‰å…¨æ¡æ”¶æ¨™æº–";
            }

            // --- 5. é¡¯ç¤ºç•«é¢ ---
            document.getElementById('loading').style.display = 'none';
            document.getElementById('product-card').style.display = 'block';

        } catch (err) {
            console.error(err);
            document.getElementById('loading').innerText = "è®€å–å¤±æ•—ï¼š" + err.message;
        }
    };
</script>

</body>
</html>
