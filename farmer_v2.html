<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¨â€ğŸŒ¾ è¾²å¤«ç”Ÿç”¢ç®¡ç† (å«è—¥æª¢é–å®š)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #f1f8e9; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: #2e7d32; margin-bottom: 10px; }
        .wallet-bar { text-align: center; margin-bottom: 30px; }
        .status-badge { background: #ffebee; color: #c62828; padding: 8px 15px; border-radius: 20px; font-weight: bold; display: inline-block; }
        .status-badge.connected { background: #e8f5e9; color: #2e7d32; }

        h3 { border-left: 5px solid #4caf50; padding-left: 12px; color: #388e3c; margin-top: 40px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        
        label { display: block; margin: 8px 0 5px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        input:focus { border-color: #4caf50; outline: none; }

        button { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: 0.3s; }
        .btn-green { background: #2e7d32; color: white; }
        .btn-green:hover { background: #1b5e20; }
        .btn-blue { background: #1565c0; color: white; }
        .btn-blue:hover { background: #0d47a1; }
        .btn-orange { background: #f57c00; color: white; }

        /* æ–½è—¥è­¦ç¤ºå€å¡Š */
        .pesticide-box { 
            display: none; 
            background: #ffebee; 
            border: 2px solid #ef5350; 
            padding: 20px; 
            border-radius: 8px; 
            margin-top: 15px;
        }
        .warning-text { color: #d32f2f; font-size: 0.9em; margin-top: 5px; }

        .result-box { margin-top: 20px; padding: 15px; background: #fafafa; border-radius: 8px; display: none; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ‘¨â€ğŸŒ¾ è¾²å¤«ç”Ÿç”¢ç®¡ç† (å«è—¥æª¢é–å®š)</h1>
    
    <div class="wallet-bar">
        <span id="wallet-status" class="status-badge">ğŸ”´ éŒ¢åŒ…æœªé€£ç·š</span>
        <button onclick="checkConnection()" style="width: auto; padding: 5px 15px; margin-left: 10px; font-size: 0.9em;">ğŸ”— æ‰‹å‹•é€£ç·š</button>
    </div>

    <h3>1. è¨»å†Šæ–°ç”¢å“</h3>
    <div class="form-grid">
        <div><label>ç”¢å“ ID</label><input type="text" id="p-id" placeholder="ä¾‹å¦‚: P005"></div>
        <div><label>ç”¢å“åç¨±</label><input type="text" id="p-name" placeholder="ä¾‹å¦‚: ç‰å¥³ç•ªèŒ„"></div>
        <div><label>ç”¢åœ°</label><input type="text" id="p-location" value="å˜‰ç¾©ç¸£å¤ªä¿å¸‚"></div>
        <div><label>ç”Ÿç”¢è€…</label><input type="text" id="p-farmer" value="é™³å¤§è¾²"></div>
        <div class="full-width">
            <label>ç…§ç‰‡é€£çµ</label>
            <input type="text" id="p-photo" placeholder="è«‹è²¼ä¸Š https://... çµå°¾æ˜¯jpg/pngçš„çŸ­ç¶²å€">
        </div>
    </div>
    <button class="btn-green" onclick="registerProduct()">âœ… è¨»å†Šç”¢å“åˆ°å€å¡Šéˆ</button>

    <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

    <h3>2. æ–°å¢ç”Ÿç”¢ / æ–½è—¥ç´€éŒ„</h3>
    <div class="form-grid">
        <div class="full-width"><label>ç”¢å“ ID</label><input type="text" id="rec-id" placeholder="è¼¸å…¥è¦æ“ä½œçš„ç”¢å“ ID"></div>
        
        <div>
            <label>ä½œæ¥­ç¨®é¡</label>
            <select id="rec-process" onchange="handleProcessChange()">
                <option value="è€•åœ°ç®¡ç†">è€•åœ°ç®¡ç†</option>
                <option value="ç¨®æ¤">ç¨®æ¤</option>
                <option value="æ–½è‚¥">æ–½è‚¥</option>
                <option value="æ–½è—¥">â˜ ï¸ æ–½è—¥ (Pesticide Application)</option>
                <option value="æ¡æ”¶">æ¡æ”¶</option>
            </select>
        </div>
        <div><label>æ—¥æœŸ</label><input type="date" id="rec-date"></div>
    </div>

    <div id="normal-inputs" style="margin-top: 15px;">
        <label>è©³ç´°å…§å®¹</label>
        <input type="text" id="rec-detail" placeholder="ä¾‹å¦‚: ä½¿ç”¨æœ‰æ©Ÿè‚¥">
    </div>

    <div id="pesticide-inputs" class="pesticide-box">
        <h4 style="margin:0 0 10px 0; color:#c62828;">âš ï¸ æ–½è—¥ç®¡åˆ¶è³‡æ–™ (å°‡å•Ÿå‹•æ™ºèƒ½åˆç´„é–å®š)</h4>
        <div class="form-grid">
            <div><label>è¾²è—¥åç¨±</label><input type="text" id="pest-name" placeholder="ä¾‹å¦‚: ç´ä¹ƒå¾—"></div>
            <div><label>ç¨€é‡‹å€æ•¸</label><input type="text" id="pest-dose" placeholder="ä¾‹å¦‚: 1000å€"></div>
            <div class="full-width">
                <label>å®‰å…¨æ¡æ”¶æœŸ (PHIå¤©æ•¸)</label>
                <input type="number" id="pest-phi" placeholder="è¼¸å…¥ 7 ä»£è¡¨é–å®š7å¤©">
                <div class="warning-text">æ³¨æ„ï¼šè¼¸å…¥å¾Œï¼Œå€å¡Šéˆå°‡è‡ªå‹•é–å®šè©²ç”¢å“ï¼ŒæœŸé™å…§ç„¡æ³•é¡¯ç¤ºç‚ºå®‰å…¨ã€‚</div>
            </div>
        </div>
    </div>

    <div style="margin-top: 15px;">
        <label>å‚™è¨»</label>
        <input type="text" id="rec-note" placeholder="å…¶ä»–è£œå……èªªæ˜...">
    </div>

    <button class="btn-blue" onclick="addRecord()">â• æ–°å¢ç´€éŒ„ (MetaMask)</button>

    <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

    <h3>3. ç‹€æ…‹æŸ¥è©¢ (è—¥æª¢é–å®šæª¢æŸ¥)</h3>
    <div style="display:flex; gap:10px;">
        <input type="text" id="query-id" placeholder="è¼¸å…¥ ID æŸ¥è©¢ç‹€æ…‹">
        <button class="btn-orange" style="width: 150px; margin:0;" onclick="checkStatus()">ğŸ” æŸ¥è©¢</button>
    </div>
    <div id="status-result" class="result-box"></div>
</div>

<script>
    // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
    // é—œéµï¼šè«‹åœ¨é€™è£¡è²¼ä¸Šä½  Remix æœ€æ–°çš„åˆç´„åœ°å€ï¼
    const contractAddress = "0xdA79a8FDFf7ff6AD187c679Df7d6519b45b6C52f"; 
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    // V4 åˆç´„ ABI (åŒ…å« PHI åŠŸèƒ½)
    const contractABI = [
        {"inputs":[{"internalType":"string","name":"_id","type":"string"},{"internalType":"string","name":"_name","type":"string"},{"internalType":"string","name":"_location","type":"string"},{"internalType":"string","name":"_farmer","type":"string"},{"internalType":"string","name":"_photoUrl","type":"string"}],"name":"registerProduct","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"string","name":"_id","type":"string"},{"internalType":"string","name":"_date","type":"string"},{"internalType":"string","name":"_action","type":"string"},{"internalType":"string","name":"_note","type":"string"},{"internalType":"uint256","name":"_phi","type":"uint256"}],"name":"addHistory","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"getProduct","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    // å…¨åŸŸè®Šæ•¸å®£å‘Š
    let web3;
    let contract;

    // 1. åˆå§‹åŒ–èˆ‡é€£ç·šæª¢æŸ¥
    async function checkConnection() {
        // å¦‚æœå·²ç¶“æœ‰ web3 ç‰©ä»¶ï¼Œæª¢æŸ¥æ˜¯å¦çœŸçš„é€£ä¸Š
        if (window.ethereum) {
            try {
                // å»ºç«‹ Web3 å¯¦ä¾‹
                if (!web3) {
                    web3 = new Web3(window.ethereum);
                }
                
                // è«‹æ±‚ç”¨æˆ¶æˆæ¬Šé€£ç·š
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // å–å¾—å¸³è™Ÿ
                const accounts = await web3.eth.getAccounts();
                
                // è¨­å®šåˆç´„
                contract = new web3.eth.Contract(contractABI, contractAddress);
                
                // æ›´æ–°ä»‹é¢ç‹€æ…‹
                const statusBadge = document.getElementById('wallet-status');
                statusBadge.innerText = "ğŸŸ¢ å·²é€£ç·š: " + accounts[0].substring(0,6) + "...";
                statusBadge.className = "status-badge connected";
                
                return true;
            } catch (error) {
                console.error(error);
                alert("é€£ç·šå¤±æ•—æˆ–æ˜¯æ‚¨æ‹’çµ•äº†é€£ç·šè«‹æ±‚ã€‚");
                return false;
            }
        } else {
            alert("âš ï¸ æ‰¾ä¸åˆ° MetaMaskï¼è«‹å…ˆå®‰è£å°ç‹ç‹¸éŒ¢åŒ…æ“´å……åŠŸèƒ½ã€‚");
            return false;
        }
    }

    // 2. è¨»å†Šç”¢å“
    async function registerProduct() {
        // å…ˆæª¢æŸ¥é€£ç·šï¼Œå¦‚æœæ²’é€£ç·šæœƒè‡ªå‹•è·³å‡º MetaMask
        if (!await checkConnection()) return;

        const id = document.getElementById("p-id").value;
        const name = document.getElementById("p-name").value;
        const location = document.getElementById("p-location").value;
        const farmer = document.getElementById("p-farmer").value;
        const photo = document.getElementById("p-photo").value;
        
        if(!id || !name) return alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™");

        try {
            const accounts = await web3.eth.getAccounts();
            // ç™¼é€äº¤æ˜“
            await contract.methods.registerProduct(id, name, location, farmer, photo)
                .send({ from: accounts[0] });
            
            alert("âœ… ç”¢å“è¨»å†ŠæˆåŠŸï¼è³‡æ–™å·²å¯«å…¥å€å¡Šéˆã€‚");
        } catch (err) {
            console.error(err);
            alert("äº¤æ˜“å¤±æ•—ï¼š" + err.message);
        }
    }

    // 3. æ–°å¢ç´€éŒ„ (å«æ–½è—¥é‚è¼¯)
    async function addRecord() {
        if (!await checkConnection()) return;

        const id = document.getElementById("rec-id").value;
        const type = document.getElementById("rec-process").value;
        const date = document.getElementById("rec-date").value;
        const noteRaw = document.getElementById("rec-note").value;
        
        if(!id || !date) return alert("è«‹è¼¸å…¥ç”¢å“ ID èˆ‡æ—¥æœŸ");

        let actionStr = "";
        let phi = 0;

        // åˆ¤æ–·æ˜¯å¦ç‚ºæ–½è—¥
        if (type === "æ–½è—¥") {
            const pName = document.getElementById("pest-name").value;
            const pDose = document.getElementById("pest-dose").value;
            const pPhi = document.getElementById("pest-phi").value;
            
            if(!pName || !pPhi) return alert("æ–½è—¥è³‡æ–™è«‹å¡«å¯«å®Œæ•´ (åŒ…å« PHI å¤©æ•¸)");
            
            actionStr = `æ–½è—¥: ${pName} (${pDose})`;
            phi = parseInt(pPhi); 
        } else {
            const detail = document.getElementById("rec-detail").value;
            actionStr = `${type}: ${detail}`;
            phi = 0;
        }

        try {
            const accounts = await web3.eth.getAccounts();
            console.log("æ­£åœ¨å¯«å…¥ç´€éŒ„...", id, date, actionStr, noteRaw, phi);
            
            await contract.methods.addHistory(id, date, actionStr, noteRaw, phi)
                .send({ from: accounts[0] });
            
            alert("âœ… ç´€éŒ„æ–°å¢æˆåŠŸï¼");
            
            // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById("rec-detail").value = "";
            document.getElementById("rec-note").value = "";
            document.getElementById("pest-name").value = "";
            document.getElementById("pest-phi").value = "";
        } catch (err) {
            console.error(err);
            alert("äº¤æ˜“å¤±æ•—ï¼š" + err.message);
        }
    }

    // 4. æŸ¥è©¢ç‹€æ…‹ (æ¸¬è©¦ç”¨)
    async function checkStatus() {
        if (!await checkConnection()) return;

        const id = document.getElementById("query-id").value;
        if(!id) return alert("è«‹è¼¸å…¥ ID");

        try {
            const p = await contract.methods.getProduct(id).call();
            const resultBox = document.getElementById("status-result");
            resultBox.style.display = "block";

            // p[4] æ˜¯ EarliestHarvestDate (æ™‚é–“æˆ³è¨˜)
            const now = Math.floor(Date.now() / 1000);
            const unlockTime = parseInt(p[4]);
            
            let statusHtml = "";
            if (unlockTime > now) {
                const waitDays = ((unlockTime - now) / 86400).toFixed(1);
                statusHtml = `<div style="color:red; font-weight:bold;">â›” è—¥æª¢ç®¡åˆ¶ä¸­ (é‚„æœ‰ ${waitDays} å¤©)</div>`;
            } else {
                statusHtml = `<div style="color:green; font-weight:bold;">âœ… å®‰å…¨å¯æ¡æ”¶</div>`;
            }

            resultBox.innerHTML = `
                <p><b>ç”¢å“:</b> ${p[0]} (${p[1]})</p>
                <p><b>ç”Ÿç”¢è€…:</b> ${p[2]}</p>
                <hr>
                ${statusHtml}
            `;

        } catch (e) {
            console.error(e);
            alert("æŸ¥ç„¡æ­¤ ID æˆ–è®€å–éŒ¯èª¤");
        }
    }

    // ä»‹é¢åˆ‡æ›é‚è¼¯
    function handleProcessChange() {
        const type = document.getElementById("rec-process").value;
        const pestBox = document.getElementById("pesticide-inputs");
        const normalBox = document.getElementById("normal-inputs");
        
        if (type === "æ–½è—¥") {
            pestBox.style.display = "block";
            normalBox.style.display = "none";
        } else {
            pestBox.style.display = "none";
            normalBox.style.display = "block";
        }
    }

    // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¨­å®šæ—¥æœŸç‚ºä»Šå¤©
    window.onload = function() {
        document.getElementById('rec-date').valueAsDate = new Date();
    }
</script>

</body>
</html>
