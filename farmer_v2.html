<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾²å¤«ç”Ÿç”¢ç®¡ç†ç³»çµ± </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 10px; flex-wrap: wrap; }
        .tab-btn { flex: 1; padding: 12px; cursor: pointer; background: #f0f0f0; border: none; border-radius: 8px 8px 0 0; font-weight: bold; font-size: 1rem; color: #555; transition: 0.3s; min-width: 150px; }
        .tab-btn:hover { background: #e0e0e0; }
        .tab-btn.active { background: #2e7d32; color: white; transform: translateY(2px); }

        .form-section { display: none; animation: fadeIn 0.4s; }
        .form-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { margin-top: 0; color: #2e7d32; border-left: 5px solid #2e7d32; padding-left: 10px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; margin-top: 15px; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        
        button.action-btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 1.1rem; cursor: pointer; font-weight: bold; margin-top: 20px; transition: 0.2s; }
        .btn-green { background: #2e7d32; color: white; }
        .btn-green:hover { background: #1b5e20; }
        .btn-blue { background: #1565c0; color: white; }
        
        .status-badge { padding: 5px 10px; border-radius: 20px; float: right; cursor: pointer; background: #eee; }
        .status-badge.connected { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        
        .pesticide-box { background: #ffebee; padding: 15px; border-radius: 8px; border: 1px solid #ffcdd2; display: none; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div id="wallet-status" class="status-badge" onclick="checkConnection()">ğŸ”´ é»æ“Šé€£ç·šéŒ¢åŒ…</div>
    
    <div class="tab-buttons">
        <button class="tab-btn active" onclick="switchTab(this, 'profile')">1. è¨­å®šå…¬å¸æª”æ¡ˆ</button>
        <button class="tab-btn" onclick="switchTab(this, 'product')">2. å»ºç«‹æ–°ç”¢å“</button>
        <button class="tab-btn" onclick="switchTab(this, 'record')">3. æ–°å¢ç”Ÿé•·ç´€éŒ„</button>
        <button class="tab-btn" onclick="switchTab(this, 'check')">4. ç‹€æ…‹æŸ¥è©¢</button>
    </div>

    <div id="section-profile" class="form-section active">
        <h2>ğŸ¢ è¨­å®šå…¬å¸æª”æ¡ˆ</h2>
        <p style="color:#666; font-size:0.9em; background:#e3f2fd; padding:10px; border-radius:5px;">
            <i class="fas fa-info-circle"></i> æ­¤è™•è³‡æ–™å°‡æ°¸ä¹…å¯«å…¥å€å¡Šéˆï¼Œæ¶ˆè²»è€…æœå°‹æ‚¨çš„å…¬å¸æ™‚å¯çœ‹åˆ°ä»‹ç´¹ã€‚
        </p>

        <label>å…¬å¸/å“ç‰Œåç¨±</label>
        <input type="text" id="f-brand" placeholder="ä¾‹å¦‚: å¿«æ¨‚è¾²å ´">

        <label>è¯çµ¡é›»è©±</label>
        <input type="text" id="f-contact" placeholder="ä¾‹å¦‚: 0912-345-678">

        <label>è¾²å ´/å…¬å¸ç°¡ä»‹</label>
        <textarea id="f-bio" rows="3" placeholder="ä¾‹å¦‚: æˆ‘å€‘è‡´åŠ›æ–¼æœ‰æ©Ÿç¨®æ¤ï¼Œæä¾›æœ€å¥åº·çš„è”¬èœ..."></textarea>

        <label>è¾²å ´ç…§ç‰‡/Logo ç¶²å€</label>
        <input type="text" id="f-photo" placeholder="https://...">

        <button class="action-btn btn-green" onclick="updateCompanyProfile()">å„²å­˜æª”æ¡ˆä¸Šéˆ</button>
    </div>

    <div id="section-product" class="form-section">
        <h2>ğŸŒ± è¨»å†Šæ–°ç”¢å“</h2>
        
        <label>æ‰€å±¬å…¬å¸ (è‡ªå‹•å¸¶å…¥)</label>
        <input type="text" id="p-company" placeholder="è«‹å…ˆè‡³ã€Œè¨­å®šæª”æ¡ˆã€è¼¸å…¥å…¬å¸åç¨±" readonly style="background:#eee; color:#555; cursor:not-allowed;">
        
        <label>ç”¢å“ ID (å”¯ä¸€ç·¨è™Ÿ)</label>
        <input type="text" id="p-id" placeholder="ä¾‹å¦‚: P001">

        <label>ç”¢å“åç¨±</label>
        <input type="text" id="p-name" placeholder="ä¾‹å¦‚: é«˜å±±é«˜éº—èœ">

        <label>ç”¢åœ°</label>
        <input type="text" id="p-location" placeholder="ä¾‹å¦‚: å°ä¸­å¸‚">
        
        <label>ç”¢å“ç…§ç‰‡ç¶²å€</label>
        <input type="text" id="p-photo" placeholder="https://...">

        <button class="action-btn btn-green" onclick="registerProduct()">è¨»å†Šç”¢å“ä¸Šéˆ</button>
    </div>

    <div id="section-record" class="form-section">
        <h2>ğŸ“ æ–°å¢ç”Ÿé•·ç´€éŒ„</h2>
        <label>ç”¢å“ ID</label>
        <input type="text" id="rec-id" placeholder="è¼¸å…¥ç”¢å“ ID">

        <label>åŸ·è¡Œå‹•ä½œ</label>
        <select id="rec-process" onchange="handleProcessChange()">
            <option value="è€•åœ°ç®¡ç†">è€•åœ°ç®¡ç†</option>
            <option value="ç¨®æ¤">ç¨®æ¤ / è‚²è‹—</option>
            <option value="æ–½è‚¥">æ–½è‚¥</option>
            <option value="æ–½è—¥">â˜ ï¸ æ–½è—¥</option>
            <option value="æ¡æ”¶">æ¡æ”¶</option>
            <option value="åŠ å·¥/åŒ…è£">åŠ å·¥ / åŒ…è£</option>
        </select>

        <label>åŸ·è¡Œæ—¥æœŸ</label>
        <input type="date" id="rec-date">
        <small id="date-hint" style="color:#666;">ä¸€èˆ¬ä½œæ¥­åƒ…é™è£œç™» 14 å¤©å…§</small>

        <div id="normal-inputs" style="margin-top: 15px;">
            <label>ä½œæ¥­å…§å®¹</label>
            <input type="text" id="rec-detail" placeholder="ä¾‹å¦‚: ä½¿ç”¨æœ‰æ©Ÿè‚¥æ–™">
        </div>

        <div id="pesticide-inputs" class="pesticide-box">
            <h4 style="margin:0 0 10px 0; color:#c62828;"><i class="fas fa-skull-crossbones"></i> æ–½è—¥ç®¡åˆ¶è³‡æ–™</h4>
            <label>è¾²è—¥åç¨±</label><input type="text" id="pest-name" placeholder="ä¾‹å¦‚: ç´ä¹ƒå¾—">
            <label>åŠ‘é‡/å€æ•¸</label><input type="text" id="pest-dose" placeholder="ä¾‹å¦‚: 1000å€">
            <label>å®‰å…¨æ¡æ”¶æœŸ (PHI å¤©æ•¸)</label>
            <input type="number" id="pest-phi" placeholder="ä¾‹å¦‚: 7">
        </div>

        <label>å‚™è¨» (é¸å¡«)</label>
        <input type="text" id="rec-note" placeholder="å…¶ä»–è£œå……äº‹é …...">

        <button class="action-btn btn-blue" onclick="addRecord()">â• æ–°å¢ç´€éŒ„</button>
    </div>

    <div id="section-check" class="form-section">
        <h2>ğŸ” æŸ¥è©¢èˆ‡ç¢ºèª</h2>
        <div style="display:flex; gap:10px;">
            <input type="text" id="query-id" placeholder="è¼¸å…¥ç”¢å“ ID (ä¾‹å¦‚: P001)" style="flex:1;">
            <button onclick="checkStatus()" style="padding:10px 20px; background:#666; color:white; border:none; border-radius:6px; cursor:pointer;">æŸ¥è©¢</button>
        </div>
        <div id="status-result" style="margin-top:20px; padding:20px; background:#f9f9f9; display:none; border-radius:8px; border:1px solid #ddd;"></div>
    </div>
</div>

<script>
    // ğŸ”¥ æ‚¨çš„ V3 æ–°åˆç´„åœ°å€
    const contractAddress = "0x842ae6a239902C5ccb0b71EF01D3c4c6B21816F3"

    // ğŸ”¥ V3 åˆç´„ ABI (å« updateCompanyProfile)
    const contractABI = [
        { "inputs": [ { "internalType": "string", "name": "_id", "type": "string" }, { "internalType": "string", "name": "_date", "type": "string" }, { "internalType": "string", "name": "_transporter", "type": "string" }, { "internalType": "string", "name": "_action", "type": "string" }, { "internalType": "string", "name": "_note", "type": "string" }, { "internalType": "uint256", "name": "_phi", "type": "uint256" }, { "internalType": "uint256", "name": "_manualTimestamp", "type": "uint256" } ], "name": "addHistory", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
        { "inputs": [ { "internalType": "string", "name": "_id", "type": "string" }, { "internalType": "string", "name": "_name", "type": "string" }, { "internalType": "string", "name": "_loc", "type": "string" }, { "internalType": "string", "name": "_companyName", "type": "string" }, { "internalType": "string", "name": "_photoUrl", "type": "string" } ], "name": "registerProduct", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
        { "inputs": [ { "internalType": "string", "name": "_name", "type": "string" }, { "internalType": "string", "name": "_contact", "type": "string" }, { "internalType": "string", "name": "_bio", "type": "string" }, { "internalType": "string", "name": "_photoUrl", "type": "string" } ], "name": "updateCompanyProfile", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
        { "inputs": [ { "internalType": "string", "name": "_id", "type": "string" } ], "name": "getProduct", "outputs": [ { "internalType": "string", "name": "", "type": "string" }, { "internalType": "string", "name": "", "type": "string" }, { "internalType": "string", "name": "", "type": "string" }, { "internalType": "string", "name": "", "type": "string" }, { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" },
        { "inputs": [ { "internalType": "string", "name": "_name", "type": "string" } ], "name": "getCompanyInfo", "outputs": [ { "internalType": "string", "name": "", "type": "string" }, { "internalType": "string", "name": "", "type": "string" }, { "internalType": "string", "name": "", "type": "string" }, { "internalType": "bool", "name": "", "type": "bool" } ], "stateMutability": "view", "type": "function" }
    ];

    let web3, contract, userAccount;
    // ç”¨ä¾†æš«å­˜å…¬å¸åç¨± (æå‡ UX)
    let currentCompanyName = "";

  window.onload = function() { 
        setGeneralDateLimit(); // åˆå§‹åŒ–æ—¥æœŸé™åˆ¶
    }

    // ğŸŸ¢ ä¿®æ­£ï¼šä¸€èˆ¬ä½œæ¥­è£œç™» (14å¤©å…§)
    function setGeneralDateLimit() {
        const d = document.getElementById("rec-date");
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];

        // è¨ˆç®— 14 å¤©å‰
        const pastDate = new Date();
        pastDate.setDate(today.getDate() - 14);
        const minDateStr = pastDate.toISOString().split('T')[0];

        d.max = todayStr;
        d.min = minDateStr; // è¨­å®šæœ€å°å€¼ï¼Œæ—¥æ›†ä¸Š14å¤©å‰æœƒè®Šç°
        d.value = todayStr;
        d.disabled = false;
        document.getElementById("date-hint").innerHTML = "ä¸€èˆ¬ä½œæ¥­å¯è£œç™» <span style='color:blue'>14 å¤©å…§</span> ç´€éŒ„";
    }

    // ğŸ”´ ä¿®æ­£ï¼šæ–½è—¥ä½œæ¥­ (é™ç•¶å¤©)
    function setPesticideDateLimit() {
        const d = document.getElementById("rec-date");
        const todayStr = new Date().toISOString().split('T')[0];
        
        d.value = todayStr; // å¼·åˆ¶å¡«å…¥ä»Šå¤©
        d.disabled = true;  // é–å®šï¼Œä¸è®“ä½¿ç”¨è€…æ”¹
        document.getElementById("date-hint").innerHTML = "<b style='color:red'><i class='fas fa-exclamation-triangle'></i> æ–½è—¥ä½œæ¥­å¿…é ˆç•¶æ—¥ç”³å ±</b>";
    }

    function handleProcessChange() {
        const t = document.getElementById("rec-process").value;
        if(t.includes("æ–½è—¥")) {
            document.getElementById("pesticide-inputs").style.display = "block";
            document.getElementById("normal-inputs").style.display = "none";
            setPesticideDateLimit(); // å‘¼å«é–å®šå‡½å¼
        } else {
            document.getElementById("pesticide-inputs").style.display = "none";
            document.getElementById("normal-inputs").style.display = "block";
            setGeneralDateLimit();   // å‘¼å«ä¸€èˆ¬é™åˆ¶å‡½å¼
        }
    }

    function switchTab(btn, tabName) {
        document.querySelectorAll('.form-section').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('section-' + tabName).style.display = 'block';
        if(btn) btn.classList.add('active');
        
        if(tabName === 'product') {
            if(currentCompanyName) {
                document.getElementById('p-company').value = currentCompanyName;
            } else if(document.getElementById('f-brand').value) {
                document.getElementById('p-company').value = document.getElementById('f-brand').value;
            }
        }
        if(tabName === 'record') {
            const lastId = document.getElementById('p-id').value;
            if(lastId) document.getElementById('rec-id').value = lastId;
        }
    }

    async function checkConnection() {
        if (window.ethereum) {
            web3 = new Web3(window.ethereum);
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];
                contract = new web3.eth.Contract(contractABI, contractAddress);
                document.getElementById('wallet-status').innerText = "ğŸŸ¢ å·²é€£ç·š: " + userAccount.substring(0,6) + "...";
                document.getElementById('wallet-status').classList.add('connected');
                return true;
            } catch (e) { alert("é€£ç·šå¤±æ•—"); return false; }
        } else { alert("è«‹å®‰è£ MetaMask"); return false; }
    }

    async function updateCompanyProfile() {
        if (!await checkConnection()) return;
        const name = document.getElementById('f-brand').value;
        const contact = document.getElementById('f-contact').value;
        const bio = document.getElementById('f-bio').value;
        const photo = document.getElementById('f-photo').value;

        if(!name) return alert("å…¬å¸/å“ç‰Œåç¨±ç‚ºå¿…å¡«ï¼");

        try {
            await contract.methods.updateCompanyProfile(name, contact, bio, photo).send({ from: userAccount });
            alert("âœ… å…¬å¸æª”æ¡ˆå·²ä¸ŠéˆæˆåŠŸï¼");
            currentCompanyName = name; 
            switchTab(null, 'product');
        } catch (e) { alert("ä¸Šå‚³å¤±æ•—: " + e.message); }
    }

    async function registerProduct() {
        if (!await checkConnection()) return;
        const id = document.getElementById("p-id").value;
        const name = document.getElementById("p-name").value;
        const loc = document.getElementById("p-location").value;
        const company = document.getElementById("p-company").value;
        const photo = document.getElementById("p-photo").value;

        if(!id || !company) return alert("ç”¢å“IDèˆ‡å…¬å¸åç¨±ç‚ºå¿…å¡«");

        try {
            await contract.methods.registerProduct(id, name, loc, company, photo).send({ from: userAccount });
            alert("âœ… ç”¢å“ " + id + " è¨»å†ŠæˆåŠŸï¼");
        } catch (e) { alert("éŒ¯èª¤: " + e.message); }
    }

    async function addRecord() {
        if (!await checkConnection()) return;
        const id = document.getElementById("rec-id").value;
        const type = document.getElementById("rec-process").value;
        let dateVal = document.getElementById("rec-date").value; // é€™è£¡æœƒæŠ“åˆ°é–å®šçš„æ—¥æœŸ
        const note = document.getElementById("rec-note").value;
        let actionStr = "", phi = 0;

        if (type.includes("æ–½è—¥")) {
            // å‰ç«¯äºŒæ¬¡é©—è­‰ï¼šå¦‚æœæ˜¯æ–½è—¥ï¼Œå¼·åˆ¶ä½¿ç”¨ç•¶ä¸‹æ™‚é–“ï¼Œä¸ç®¡ input å€¼ç‚ºä½• (é˜²æ­¢é§­å®¢ä¿®æ”¹ HTML)
            dateVal = new Date().toISOString().split('T')[0];
            const pName = document.getElementById("pest-name").value;
            const pDose = document.getElementById("pest-dose").value;
            phi = parseInt(document.getElementById("pest-phi").value) || 0;
            actionStr = `æ–½è—¥: ${pName} / åŠ‘é‡: ${pDose}`;
        } else {
            if(!dateVal) return alert("è«‹é¸æ“‡æ—¥æœŸ");
            const detail = document.getElementById("rec-detail").value;
            actionStr = `${type}: ${detail}`;
        }

        const timestamp = Math.floor(new Date(dateVal).getTime() / 1000);

        try {
            await contract.methods.addHistory(id, dateVal, "", actionStr, note, phi, timestamp).send({ from: userAccount });
            alert("âœ… ç´€éŒ„æ–°å¢æˆåŠŸï¼");
        } catch (e) { alert("éŒ¯èª¤: " + e.message); }
    }

    async function checkStatus() {
        if (!await checkConnection()) return;
        const id = document.getElementById('query-id').value;
        const resultDiv = document.getElementById('status-result');
        resultDiv.style.display = 'none';

        try {
            const p = await contract.methods.getProduct(id).call();
            if (!p[0]) { alert("æŸ¥ç„¡æ­¤ ID"); return; }
            const c = await contract.methods.getCompanyInfo(p[3]).call();

            resultDiv.innerHTML = `
                <h3 style="margin-top:0; color:#2e7d32"><i class="fas fa-check-circle"></i> ç”¢å“å­˜åœ¨æ–¼å€å¡Šéˆ</h3>
                <div style="display:flex; gap:20px; align-items:start;">
                    <img src="${p[4]}" style="width:100px; height:100px; object-fit:cover; border-radius:10px; border:1px solid #ddd;" onerror="this.style.display='none'">
                    <div>
                        <p><strong>ç”¢å“åç¨±:</strong> ${p[1]}</p>
                        <p><strong>ç”¢å“ ID:</strong> ${p[0]}</p>
                        <p><strong>æ‰€å±¬å…¬å¸:</strong> ${p[3]}</p>
                    </div>
                </div>
                <hr>
                <div style="background:#e8f5e9; padding:15px; border-radius:8px;">
                    <strong><i class="fas fa-building"></i> å…¬å¸æª”æ¡ˆ:</strong><br>
                    ${c[3] ? `é›»è©±: ${c[0]}<br>ç°¡ä»‹: ${c[1]}` : 'ç„¡è©³ç´°è³‡æ–™'}
                </div>
            `;
            resultDiv.style.display = 'block';
        } catch (e) {
            console.error(e);
            alert("æŸ¥è©¢å¤±æ•—");
        }
    }
</script>
</body>
</html>
