<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ğŸ‘¨â€ğŸŒ¾ è¾²å¤«ç”Ÿç”¢ç®¡ç†ç³»çµ± (Web3ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <style>
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background: #e8f5e9; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2e7d32; }
        h3 { border-left: 5px solid #43a047; padding-left: 10px; color: #2e7d32; margin-top: 30px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        
        button { width: 100%; padding: 12px; background: #2e7d32; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; margin-top: 10px; }
        button:hover { background: #1b5e20; }
        
        /* æ–½è—¥å°ˆç”¨å€å¡Šæ¨£å¼ */
        .pesticide-box { 
            display: none; 
            background: #ffebee; 
            border: 2px solid #ef5350; 
            padding: 15px; 
            border-radius: 8px; 
            margin-top: 10px; 
        }
        .status-box { background: #f1f8e9; padding: 15px; border-radius: 5px; margin-top: 20px; display: none; }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ‘¨â€ğŸŒ¾ è¾²å¤«ç”Ÿç”¢ç®¡ç† (å€å¡Šéˆè—¥æª¢é–å®š)</h1>
    <div style="text-align:center; margin-bottom:20px;">
        <span id="wallet-status" style="background:#ddd; padding:5px 10px; border-radius:20px;">ğŸ”´ éŒ¢åŒ…æœªé€£ç·š</span>
    </div>

    <h3>1. è¨»å†Šæ–°ç”¢å“</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div><label>ç”¢å“ ID (ä¾‹å¦‚: P001)</label><input type="text" id="p-id" placeholder="è‡ªè¡Œè¨­å®šID"></div>
        <div><label>ç”¢å“åç¨±</label><input type="text" id="p-name" placeholder="ä¾‹å¦‚: ç‰å¥³ç•ªèŒ„"></div>
        <div><label>ç”¢åœ°</label><input type="text" id="p-location" value="å˜‰ç¾©ç¸£å¤ªä¿å¸‚"></div>
        <div><label>ç”Ÿç”¢è€…</label><input type="text" id="p-farmer" value="é™³å¤§è¾²"></div>
        <div style="grid-column: span 2;"><label>ç…§ç‰‡é€£çµ</label><input type="text" id="p-photo" placeholder="https://imgur.com/..."></div>
    </div>
    <button onclick="registerProduct()">âœ… è¨»å†Šç”¢å“åˆ°å€å¡Šéˆ</button>

    <hr>

    <h3>2. æ–°å¢ç”Ÿç”¢ / æ–½è—¥ç´€éŒ„</h3>
    <div class="form-group"><label>ç”¢å“ ID</label><input type="text" id="rec-id" placeholder="è¼¸å…¥ ID (ä¾‹å¦‚: P001)"></div>

    <div class="form-group">
        <label>ä½œæ¥­ç¨®é¡</label>
        <select id="rec-process" onchange="handleProcessChange()">
            <option value="è€•åœ°ç®¡ç†">è€•åœ°ç®¡ç†</option>
            <option value="ç¨®æ¤">ç¨®æ¤</option>
            <option value="æ–½è‚¥">æ–½è‚¥</option>
            <option value="æ–½è—¥">â˜ ï¸ æ–½è—¥ (Pesticide Application)</option>
            <option value="æ¡æ”¶">æ¡æ”¶</option>
        </select>
    </div>

    <div class="form-group">
        <label>ä½œæ¥­æ—¥æœŸ</label>
        <input type="date" id="rec-date">
        <small id="date-hint" style="color:#666;">ä¸€èˆ¬ä½œæ¥­å¯è£œç™»ï¼›æ–½è—¥å»ºè­°ç•¶æ—¥ã€‚</small>
    </div>

    <div id="pesticide-inputs" class="pesticide-box">
        <h4 style="margin-top:0; color:#c62828;">âš ï¸ æ–½è—¥ç®¡åˆ¶è³‡æ–™ (å°‡å•Ÿå‹•æ™ºèƒ½åˆç´„é–å®š)</h4>
        <div class="form-group"><label>è¾²è—¥åç¨±</label><input type="text" id="pest-name" placeholder="ä¾‹å¦‚: ç´ä¹ƒå¾—"></div>
        <div class="form-group"><label>ç¨€é‡‹å€æ•¸/åŠ‘é‡</label><input type="text" id="pest-dose" placeholder="ä¾‹å¦‚: 1000å€"></div>
        <div class="form-group">
            <label>å®‰å…¨æ¡æ”¶æœŸ (PHI) - å¤©æ•¸</label>
            <input type="number" id="pest-phi" placeholder="ä¾‹å¦‚: 7 (ä»£è¡¨7å¤©å…§ç¦æ­¢æ¡æ”¶)">
            <small style="color:#d32f2f;">æ³¨æ„ï¼šè¼¸å…¥å¾Œå€å¡Šéˆå°‡è‡ªå‹•é–å®šï¼Œ${PHI} å¤©å…§ç„¡æ³•é€²è¡Œæ¡æ”¶ç™»éŒ„ã€‚</small>
        </div>
    </div>

    <div class="form-group" id="normal-inputs">
        <label>è©³ç´°å…§å®¹</label><input type="text" id="rec-detail" placeholder="ä¾‹å¦‚: ä½¿ç”¨æœ‰æ©Ÿè‚¥">
    </div>
    
    <div class="form-group"><label>å‚™è¨»</label><input type="text" id="rec-note"></div>

    <button onclick="addRecord()" style="background: #1565c0;">â• æ–°å¢ç´€éŒ„ (MetaMask)</button>

    <hr>

    <h3>3. ç‹€æ…‹æŸ¥è©¢ (è—¥æª¢é–å®šæª¢æŸ¥)</h3>
    <div style="display:flex; gap:10px;">
        <input type="text" id="query-id" placeholder="è¼¸å…¥ ID æŸ¥è©¢">
        <button onclick="checkStatus()" style="margin:0; width:150px; background:#f57c00;">ğŸ” æŸ¥è©¢ç‹€æ…‹</button>
    </div>
    <div id="status-result" class="status-box"></div>
</div>

<script>
    // â˜…â˜…â˜… è«‹æ›¿æ›æˆä½ æ–°éƒ¨ç½²çš„ V4 åˆç´„åœ°å€ â˜…â˜…â˜…
    const contractAddress = "0xdA79a8FDFf7ff6AD187c679Df7d6519b45b6C52f";
    
    // å°æ‡‰ V4 åˆç´„çš„ ABI
    const contractABI = [
        {"inputs":[{"internalType":"string","name":"_id","type":"string"},{"internalType":"string","name":"_name","type":"string"},{"internalType":"string","name":"_location","type":"string"},{"internalType":"string","name":"_farmer","type":"string"},{"internalType":"string","name":"_photoUrl","type":"string"}],"name":"registerProduct","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"string","name":"_id","type":"string"},{"internalType":"string","name":"_date","type":"string"},{"internalType":"string","name":"_action","type":"string"},{"internalType":"string","name":"_note","type":"string"},{"internalType":"uint256","name":"_phi","type":"uint256"}],"name":"addHistory","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"getProduct","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    let web3;
    let contract;

    // 1. åˆå§‹åŒ–èˆ‡é€£ç·š
    window.addEventListener('load', async () => {
        if (window.ethereum) {
            web3 = new Web3(window.ethereum);
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                contract = new web3.eth.Contract(contractABI, contractAddress);
                
                const accounts = await web3.eth.getAccounts();
                document.getElementById('wallet-status').innerText = "ğŸŸ¢ å·²é€£ç·š: " + accounts[0].substring(0,6) + "...";
                document.getElementById('wallet-status').style.background = "#c8e6c9";
                
                // é è¨­æ—¥æœŸç‚ºä»Šå¤©
                document.getElementById("rec-date").valueAsDate = new Date();

            } catch (error) {
                console.error(error);
                alert("è«‹å…è¨± MetaMask é€£ç·šï¼");
            }
        } else {
            alert("è«‹å®‰è£ MetaMask éŒ¢åŒ…ï¼");
        }
    });

    // 2. åˆ‡æ›æ–½è—¥/ä¸€èˆ¬æ¨¡å¼çš„ UI é¡¯ç¤º
    function handleProcessChange() {
        const type = document.getElementById("rec-process").value;
        const pestBox = document.getElementById("pesticide-inputs");
        const normalBox = document.getElementById("normal-inputs");
        
        if (type === "æ–½è—¥") {
            pestBox.style.display = "block";
            normalBox.style.display = "none";
            document.getElementById("rec-date").valueAsDate = new Date(); // æ–½è—¥å»ºè­°å¸¶å…¥ä»Šå¤©
        } else {
            pestBox.style.display = "none";
            normalBox.style.display = "block";
        }
    }

    // 3. è¨»å†Šç”¢å“
    async function registerProduct() {
        const id = document.getElementById("p-id").value;
        const name = document.getElementById("p-name").value;
        const location = document.getElementById("p-location").value;
        const farmer = document.getElementById("p-farmer").value;
        const photo = document.getElementById("p-photo").value;
        
        if(!id || !name) return alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™");

        try {
            const accounts = await web3.eth.getAccounts();
            await contract.methods.registerProduct(id, name, location, farmer, photo)
                .send({ from: accounts[0] });
            alert("âœ… ç”¢å“è¨»å†ŠæˆåŠŸï¼");
        } catch (err) {
            alert("äº¤æ˜“å¤±æ•—ï¼š" + err.message);
        }
    }

    // 4. æ–°å¢ç´€éŒ„ (æ ¸å¿ƒé‚è¼¯)
    async function addRecord() {
        const id = document.getElementById("rec-id").value;
        const type = document.getElementById("rec-process").value;
        const date = document.getElementById("rec-date").value;
        const noteRaw = document.getElementById("rec-note").value;
        
        let actionStr = "";
        let phi = 0;

        // åˆ¤æ–·æ˜¯å¦ç‚ºæ–½è—¥
        if (type === "æ–½è—¥") {
            const pName = document.getElementById("pest-name").value;
            const pDose = document.getElementById("pest-dose").value;
            const pPhi = document.getElementById("pest-phi").value;
            
            if(!pName || !pPhi) return alert("æ–½è—¥è³‡æ–™è«‹å¡«å¯«å®Œæ•´");
            
            actionStr = `æ–½è—¥: ${pName} (${pDose})`;
            phi = parseInt(pPhi); // é€™æ˜¯è¦å‚³çµ¦åˆç´„è¨ˆç®—é–å®šæ™‚é–“çš„é—œéµæ•¸å­—
        } else {
            const detail = document.getElementById("rec-detail").value;
            actionStr = `${type}: ${detail}`;
            phi = 0;
        }

        // å¦‚æœæ˜¯æ¡æ”¶ï¼Œå…ˆå‰ç«¯æª¢æŸ¥ä¸€ä¸‹æœ‰æ²’æœ‰è¢«é–å®š (é›–ç„¶å¾Œç«¯åˆç´„å¯ä»¥ä¸æ“‹ï¼Œä½†å‰ç«¯æç¤ºæ¯”è¼ƒå‹å–„)
        if (type === "æ¡æ”¶") {
            try {
                const product = await contract.methods.getProduct(id).call();
                const unlockTime = product[4]; // ç¬¬5å€‹å›å‚³å€¼æ˜¯æ™‚é–“æˆ³
                const now = Math.floor(Date.now() / 1000);
                
                if (unlockTime > now) {
                    const waitDays = ((unlockTime - now) / 86400).toFixed(1);
                    const confirmHarvest = confirm(`âš ï¸ è­¦å‘Šï¼ç›®å‰è™•æ–¼ã€Œè—¥æª¢é–å®šå®‰å…¨æœŸã€ã€‚\né‚„æœ‰ ${waitDays} å¤©æ‰è§£é–ã€‚\n\næ‚¨ç¢ºå®šè¦å¼·åˆ¶æ¡æ”¶å—ï¼Ÿ(é€™å°‡é•åå®‰å…¨è¦ç¯„)`);
                    if (!confirmHarvest) return;
                }
            } catch(e) { console.log("æª¢æŸ¥é–å®šå¤±æ•—", e); }
        }

        try {
            const accounts = await web3.eth.getAccounts();
            // å‘¼å«åˆç´„: å‚³å…¥ PHI åƒæ•¸
            await contract.methods.addHistory(id, date, actionStr, noteRaw, phi)
                .send({ from: accounts[0] });
            
            alert("âœ… ç´€éŒ„å·²ä¸Šéˆï¼" + (phi > 0 ? `\nğŸ”’ ç”¢å“å·²é–å®š ${phi} å¤©` : ""));
            // æ¸…ç©ºè¼¸å…¥
            document.getElementById("rec-detail").value = "";
            document.getElementById("rec-note").value = "";
        } catch (err) {
            alert("äº¤æ˜“å¤±æ•—ï¼š" + err.message);
        }
    }

    // 5. æŸ¥è©¢ç‹€æ…‹ (Lock Check)
    async function checkStatus() {
        const id = document.getElementById("query-id").value;
        try {
            const p = await contract.methods.getProduct(id).call();
            const resultBox = document.getElementById("status-result");
            resultBox.style.display = "block";

            // p[0]:Name, p[4]:EarliestHarvestDate (timestamp)
            const now = Math.floor(Date.now() / 1000);
            const unlockTime = p[4];
            let statusHtml = "";

            if (unlockTime > now) {
                const waitSeconds = unlockTime - now;
                const waitDays = (waitSeconds / 86400).toFixed(1);
                statusHtml = `
                    <div style="color:red; font-weight:bold; font-size:1.2em; border: 2px solid red; padding:10px; border-radius:5px;">
                        â›” è—¥æª¢é–å®šä¸­ (Safety Lock Active)<br>
                        <span style="font-size:0.8em; color:black">é‚„æœ‰ ${waitDays} å¤©æ‰å¯å®‰å…¨æ¡æ”¶</span>
                    </div>`;
            } else {
                statusHtml = `
                    <div style="color:green; font-weight:bold; font-size:1.2em; border: 2px solid green; padding:10px; border-radius:5px;">
                        âœ… å®‰å…¨æ¡æ”¶æœŸ (Safe to Harvest)<br>
                        <span style="font-size:0.8em; color:black">ç›®å‰ç„¡è—¥ç‰©æ®˜ç•™é¢¨éšª</span>
                    </div>`;
            }

            resultBox.innerHTML = `
                <p><b>ç”¢å“åç¨±:</b> ${p[0]}</p>
                <p><b>ç”¢åœ°:</b> ${p[1]}</p>
                <hr>
                ${statusHtml}
            `;

        } catch (e) {
            alert("æŸ¥ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèª ID æ­£ç¢º");
        }
    }
</script>
</body>
</html>