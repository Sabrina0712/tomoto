<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ğŸ‘¨â€ğŸŒ¾ è¾²å¤«ç”Ÿç”¢ç®¡ç† (Web3 ç©©å®šç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <style>
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background: #e8f5e9; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2e7d32; }
        h3 { border-left: 5px solid #43a047; padding-left: 10px; color: #2e7d32; margin-top: 30px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        
        button { width: 100%; padding: 12px; background: #2e7d32; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; margin-top: 10px; }
        button:hover { background: #1b5e20; }
        
        /* æ–½è—¥å°ˆç”¨å€å¡Šæ¨£å¼ */
        .pesticide-box { 
            display: none; 
            background: #ffebee; 
            border: 2px solid #ef5350; 
            padding: 15px; 
            border-radius: 8px; 
            margin-top: 10px; 
        }
        .status-box { background: #f1f8e9; padding: 15px; border-radius: 5px; margin-top: 20px; display: none; }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ‘¨â€ğŸŒ¾ è¾²å¤«ç”Ÿç”¢ç®¡ç† (å«è—¥æª¢é–å®š)</h1>
    <div style="text-align:center; margin-bottom:20px;">
        <span id="wallet-status" style="background:#ddd; padding:5px 10px; border-radius:20px;">ğŸ”´ éŒ¢åŒ…æœªé€£ç·š</span>
    </div>

    <h3>1. è¨»å†Šæ–°ç”¢å“</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div><label>ç”¢å“ ID (ä¾‹å¦‚: P001)</label><input type="text" id="p-id" placeholder="è‡ªè¡Œè¨­å®šID"></div>
        <div><label>ç”¢å“åç¨±</label><input type="text" id="p-name" placeholder="ä¾‹å¦‚: ç‰å¥³ç•ªèŒ„"></div>
        <div><label>ç”¢åœ°</label><input type="text" id="p-location" value="å˜‰ç¾©ç¸£å¤ªä¿å¸‚"></div>
        <div><label>ç”Ÿç”¢è€…</label><input type="text" id="p-farmer" value="é™³å¤§è¾²"></div>
        <div style="grid-column: span 2;"><label>ç…§ç‰‡é€£çµ</label><input type="text" id="p-photo" placeholder="è«‹è²¼ä¸Š https://... çµå°¾æ˜¯jpg/pngçš„çŸ­ç¶²å€"></div>
    </div>
    <button onclick="registerProduct()">âœ… è¨»å†Šç”¢å“åˆ°å€å¡Šéˆ</button>

    <hr>

    <h3>2. æ–°å¢ç”Ÿç”¢ / æ–½è—¥ç´€éŒ„</h3>
    <div class="form-group"><label>ç”¢å“ ID</label><input type="text" id="rec-id" placeholder="è¼¸å…¥ ID (ä¾‹å¦‚: P001)"></div>

    <div class="form-group">
        <label>ä½œæ¥­ç¨®é¡</label>
        <select id="rec-process" onchange="handleProcessChange()">
            <option value="è€•åœ°ç®¡ç†">è€•åœ°ç®¡ç†</option>
            <option value="ç¨®æ¤">ç¨®æ¤</option>
            <option value="æ–½è‚¥">æ–½è‚¥</option>
            <option value="æ–½è—¥">â˜ ï¸ æ–½è—¥ (Pesticide Application)</option>
            <option value="æ¡æ”¶">æ¡æ”¶</option>
        </select>
    </div>

    <div class="form-group">
        <label>ä½œæ¥­æ—¥æœŸ</label>
        <input type="date" id="rec-date">
    </div>

    <div id="pesticide-inputs" class="pesticide-box">
        <h4 style="margin-top:0; color:#c62828;">âš ï¸ æ–½è—¥ç®¡åˆ¶è³‡æ–™ (å°‡å•Ÿå‹•æ™ºèƒ½åˆç´„é–å®š)</h4>
        <div class="form-group"><label>è¾²è—¥åç¨±</label><input type="text" id="pest-name" placeholder="ä¾‹å¦‚: ç´ä¹ƒå¾—"></div>
        <div class="form-group"><label>ç¨€é‡‹å€æ•¸/åŠ‘é‡</label><input type="text" id="pest-dose" placeholder="ä¾‹å¦‚: 1000å€"></div>
        <div class="form-group">
            <label>å®‰å…¨æ¡æ”¶æœŸ (PHI) - å¤©æ•¸</label>
            <input type="number" id="pest-phi" placeholder="ä¾‹å¦‚: 7 (ä»£è¡¨7å¤©å…§ç¦æ­¢æ¡æ”¶)">
            <small style="color:#d32f2f;">æ³¨æ„ï¼šè¼¸å…¥å¾Œå€å¡Šéˆå°‡è‡ªå‹•é–å®šï¼Œ${PHI} å¤©å…§ç„¡æ³•é€²è¡Œæ¡æ”¶ç™»éŒ„ã€‚</small>
        </div>
    </div>

    <div class="form-group" id="normal-inputs">
        <label>è©³ç´°å…§å®¹</label><input type="text" id="rec-detail" placeholder="ä¾‹å¦‚: ä½¿ç”¨æœ‰æ©Ÿè‚¥">
    </div>
    
    <div class="form-group"><label>å‚™è¨»</label><input type="text" id="rec-note"></div>

    <button onclick="addRecord()" style="background: #1565c0;">â• æ–°å¢ç´€éŒ„ (MetaMask)</button>

    <hr>

    <h3>3. ç‹€æ…‹æŸ¥è©¢ (è—¥æª¢é–å®šæª¢æŸ¥)</h3>
    <div style="display:flex; gap:10px;">
        <input type="text" id="query-id" placeholder="è¼¸å…¥ ID æŸ¥è©¢">
        <button onclick="checkStatus()" style="margin:0; width:150px; background:#f57c00;">ğŸ” æŸ¥è©¢ç‹€æ…‹</button>
    </div>
    <div id="status-result" class="status-box"></div>
</div>

<script>
    // â–¼â–¼â–¼ è«‹å‹™å¿…å°‡æ­¤è™•æ›æˆä½  Remix ä¸Šæœ€æ–°çš„åˆç´„åœ°å€ â–¼â–¼â–¼
    const contractAddress = "0xdA79a8FDFf7ff6AD187c679Df7d6519b45b6C52f"; 
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    // V4 åˆç´„ ABI (å« PHI åŠŸèƒ½)
    const contractABI = [
        {"inputs":[{"internalType":"string","name":"_id","type":"string"},{"internalType":"string","name":"_name","type":"string"},{"internalType":"string","name":"_location","type":"string"},{"internalType":"string","name":"_farmer","type":"string"},{"internalType":"string","name":"_photoUrl","type":"string"}],"name":"registerProduct","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"string","name":"_id","type":"string"},{"internalType":"string","name":"_date","type":"string"},{"internalType":"string","name":"_action","type":"string"},{"internalType":"string","name":"_note","type":"string"},{"internalType":"uint256","name":"_phi","type":"uint256"}],"name":"addHistory","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"getProduct","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    let web3;
    let contract;

    // 1. æ ¸å¿ƒåŠŸèƒ½ï¼šæª¢æŸ¥é€£ç·š (å¦‚æœæ²’é€£ç·šï¼Œæœƒè‡ªå‹•é€£)
    async function checkConnection() {
        // å¦‚æœ web3 é‚„æ²’è¨­å®šï¼Œæˆ–æ˜¯åˆç´„é‚„æ²’è¼‰å…¥
        if (!web3 || !contract) {
            if (window.ethereum) {
                try {
                    web3 = new Web3(window.ethereum);
                    // è«‹æ±‚ç”¨æˆ¶æˆæ¬Š
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    // åˆå§‹åŒ–åˆç´„
                    contract = new web3.eth.Contract(contractABI, contractAddress);
                    
                    // æ›´æ–° UI é¡¯ç¤º
                    const accounts = await web3.eth.getAccounts();
                    document.getElementById('wallet-status').innerText = "ğŸŸ¢ å·²é€£ç·š: " + accounts[0].substring(0,6) + "...";
                    document.getElementById('wallet-status').style.background = "#c8e6c9";
                    return true;
                } catch (error) {
                    console.error("User denied account access or error occurred", error);
                    alert("é€£ç·šå¤±æ•—ï¼š" + error.message);
                    return false;
                }
            } else {
                alert("æ‰¾ä¸åˆ° MetaMaskï¼è«‹å…ˆå®‰è£å°ç‹ç‹¸éŒ¢åŒ…æ“´å……åŠŸèƒ½ã€‚");
                return false;
            }
        }
        return true; // å·²ç¶“é€£ç·šéäº†
    }

    // é é¢è¼‰å…¥æ™‚å˜—è©¦é€£ç·šä¸€æ¬¡ (ä¸åšå¼·åˆ¶ï¼Œå¤±æ•—å°±ç®—äº†)
    window.addEventListener('load', async () => {
        document.getElementById("rec-date").valueAsDate = new Date(); // é è¨­ä»Šå¤©
        if(window.ethereum) {
            await checkConnection();
        }
    });

    // 2. åˆ‡æ›ä½œæ¥­ç¨®é¡ UI
    function handleProcessChange() {
        const type = document.getElementById("rec-process").value;
        const pestBox = document.getElementById("pesticide-inputs");
        const normalBox = document.getElementById("normal-inputs");
        
        if (type === "æ–½è—¥") {
            pestBox.style.display = "block";
            normalBox.style.display = "none";
            document.getElementById("rec-date").valueAsDate = new Date();
        } else {
            pestBox.style.display = "none";
            normalBox.style.display = "block";
        }
    }

    // 3. è¨»å†Šç”¢å“ (å«é€£ç·šæª¢æŸ¥)
    async function registerProduct() {
        const isConnected = await checkConnection();
        if (!isConnected) return; // å¦‚æœé€£ç·šå¤±æ•—å°±åœæ­¢

        const id = document.getElementById("p-id").value;
        const name = document.getElementById("p-name").value;
        const location = document.getElementById("p-location").value;
        const farmer = document.getElementById("p-farmer").value;
        const photo = document.getElementById("p-photo").value;
        
        if(!id || !name) return alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™");

        try {
            const accounts = await web3.eth.getAccounts();
            // ç™¼é€äº¤æ˜“
            await contract.methods.registerProduct(id, name, location, farmer, photo)
                .send({ from: accounts[0] });
            
            alert("âœ… ç”¢å“è¨»å†ŠæˆåŠŸï¼");
        } catch (err) {
            console.error(err);
            alert("äº¤æ˜“å¤±æ•—ï¼š" + err.message);
        }
    }

    // 4. æ–°å¢ç´€éŒ„ (å«é€£ç·šæª¢æŸ¥)
    async function addRecord() {
        const isConnected = await checkConnection();
        if (!isConnected) return;

        const id = document.getElementById("rec-id").value;
        const type = document.getElementById("rec-process").value;
        const date = document.getElementById("rec-date").value;
        const noteRaw = document.getElementById("rec-note").value;
        
        let actionStr = "";
        let phi = 0;

        // åˆ¤æ–·æ˜¯å¦ç‚ºæ–½è—¥
        if (type === "æ–½è—¥") {
            const pName = document.getElementById("pest-name").value;
            const pDose = document.getElementById("pest-dose").value;
            const pPhi = document.getElementById("pest-phi").value;
            
            if(!pName || !pPhi) return alert("æ–½è—¥è³‡æ–™è«‹å¡«å¯«å®Œæ•´");
            
            actionStr = `æ–½è—¥: ${pName} (${pDose})`;
            phi = parseInt(pPhi); 
        } else {
            const detail = document.getElementById("rec-detail").value;
            actionStr = `${type}: ${detail}`;
            phi = 0;
        }

        try {
            const accounts = await web3.eth.getAccounts();
            await contract.methods.addHistory(id, date, actionStr, noteRaw, phi)
                .send({ from: accounts[0] });
            
            alert("âœ… ç´€éŒ„å·²ä¸Šéˆï¼");
            
            // æ¸…ç©ºæ¬„ä½
            document.getElementById("rec-detail").value = "";
            document.getElementById("rec-note").value = "";
        } catch (err) {
            console.error(err);
            alert("äº¤æ˜“å¤±æ•—ï¼š" + err.message);
        }
    }

    // 5. æŸ¥è©¢ç‹€æ…‹ (Lock Check)
    async function checkStatus() {
        const isConnected = await checkConnection();
        if (!isConnected) return;

        const id = document.getElementById("query-id").value;
        try {
            const p = await contract.methods.getProduct(id).call();
            const resultBox = document.getElementById("status-result");
            resultBox.style.display = "block";

            // p[4] æ˜¯ EarliestHarvestDate (timestamp)
            const now = Math.floor(Date.now() / 1000);
            const unlockTime = p[4];
            let statusHtml = "";

            if (unlockTime > now) {
                const waitDays = ((unlockTime - now) / 86400).toFixed(1);
                statusHtml = `
                    <div style="color:red; font-weight:bold; font-size:1.2em; border: 2px solid red; padding:10px; border-radius:5px;">
                        â›” è—¥æª¢é–å®šä¸­ (Safety Lock Active)<br>
                        <span style="font-size:0.8em; color:black">é‚„æœ‰ ${waitDays} å¤©æ‰å¯å®‰å…¨æ¡æ”¶</span>
                    </div>`;
            } else {
                statusHtml = `
                    <div style="color:green; font-weight:bold; font-size:1.2em; border: 2px solid green; padding:10px; border-radius:5px;">
                        âœ… å®‰å…¨æ¡æ”¶æœŸ (Safe to Harvest)<br>
                        <span style="font-size:0.8em; color:black">ç›®å‰ç„¡è—¥ç‰©æ®˜ç•™é¢¨éšª</span>
                    </div>`;
            }

            resultBox.innerHTML = `
                <p><b>ç”¢å“åç¨±:</b> ${p[0]}</p>
                <p><b>ç”¢åœ°:</b> ${p[1]}</p>
                <hr>
                ${statusHtml}
            `;

        } catch (e) {
            console.error(e);
            alert("æŸ¥ç„¡è³‡æ–™ (æˆ–é€£ç·šéŒ¯èª¤)");
        }
    }
</script>
</body>
</html>
