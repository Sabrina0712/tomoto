<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾²å¤«ç”Ÿç”¢ç®¡ç†ç³»çµ± (New Contract)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 10px; flex-wrap: wrap; }
        .tab-btn { flex: 1; padding: 12px; cursor: pointer; background: #f0f0f0; border: none; border-radius: 8px 8px 0 0; font-weight: bold; transition: 0.3s; min-width: 150px; }
        .tab-btn.active { background: #2e7d32; color: white; transform: translateY(2px); }
        .form-section { display: none; }
        .form-section.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        label { font-weight: bold; display: block; margin-bottom: 5px; margin-top: 15px; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button.action-btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 1.1rem; cursor: pointer; font-weight: bold; margin-top: 20px; color: white; transition: 0.2s; }
        .btn-green { background: #2e7d32; } .btn-green:hover { background: #1b5e20; }
        .btn-blue { background: #1565c0; } .btn-blue:hover { background: #0d47a1; }
        .status-badge { padding: 5px 10px; border-radius: 20px; float: right; cursor: pointer; background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .status-badge.connected { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .pesticide-box { background: #fff3e0; padding: 15px; border-radius: 8px; border: 1px solid #ffe0b2; display: none; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div id="wallet-status" class="status-badge" onclick="checkConnection()">ğŸ”´ æœªé€£ç·š (é»æ“Šé€£ç·š)</div>
    
    <div class="tab-buttons">
        <button class="tab-btn active" onclick="switchTab('profile')">1. è¨­å®šå…¬å¸</button>
        <button class="tab-btn" onclick="switchTab('product')">2. è¨»å†Šç”¢å“</button>
        <button class="tab-btn" onclick="switchTab('record')">3. æ–°å¢ç´€éŒ„</button>
        <button class="tab-btn" onclick="switchTab('check')">4. æª¢æŸ¥ç‹€æ…‹</button>
    </div>

    <div id="section-profile" class="form-section active">
        <h2>ğŸ¢ å…¬å¸/è¾²å ´æª”æ¡ˆè¨­å®š</h2>
        <p style="background:#e3f2fd; padding:10px; border-radius:5px;"><i class="fas fa-exclamation-circle"></i> æ–°åˆç´„å·²éƒ¨ç½²ï¼Œè«‹å…ˆåœ¨æ­¤è¨»å†Šæ‚¨çš„å…¬å¸è³‡è¨Šã€‚</p>
        <label>å…¬å¸åç¨±</label><input type="text" id="f-brand" placeholder="ä¾‹å¦‚: å¿«æ¨‚è¾²å ´">
        <label>è¯çµ¡é›»è©±</label><input type="text" id="f-contact" placeholder="ä¾‹å¦‚: 0912-345-678">
        <label>ç°¡ä»‹</label><textarea id="f-bio" rows="3" placeholder="ç°¡è¿°è¾²å ´ç†å¿µ..."></textarea>
        <label>Logo åœ–ç‰‡ç¶²å€</label><input type="text" id="f-photo" placeholder="https://...">
        <button class="action-btn btn-green" onclick="updateCompanyProfile()">å„²å­˜æª”æ¡ˆä¸Šéˆ</button>
    </div>

    <div id="section-product" class="form-section">
        <h2>ğŸŒ± è¨»å†Šæ–°ç”¢å“</h2>
        <label>æ‰€å±¬å…¬å¸</label><input type="text" id="p-company" placeholder="è«‹å…ˆè¨­å®šå…¬å¸æª”æ¡ˆ" readonly style="background:#eee;">
        <label>ç”¢å“ ID</label><input type="text" id="p-id" placeholder="ä¾‹å¦‚: P001">
        <label>ç”¢å“åç¨±</label><input type="text" id="p-name" placeholder="ä¾‹å¦‚: é«˜å±±é«˜éº—èœ">
        <label>ç”¢åœ°</label><input type="text" id="p-location" placeholder="ä¾‹å¦‚: å°ä¸­å¸‚">
        <label>ç”¢å“ç…§ç‰‡ç¶²å€</label><input type="text" id="p-photo" placeholder="https://...">
        <button class="action-btn btn-green" onclick="registerProduct()">è¨»å†Šç”¢å“ä¸Šéˆ</button>
    </div>

    <div id="section-record" class="form-section">
        <h2>ğŸ“ æ–°å¢ç”Ÿé•·/ç‰©æµç´€éŒ„</h2>
        <label>ç”¢å“ ID</label><input type="text" id="rec-id" placeholder="è¼¸å…¥ç”¢å“ ID">
        <label>å‹•ä½œé¡å‹</label>
        <select id="rec-process" onchange="handleProcessChange()">
            <option value="è€•åœ°ç®¡ç†">è€•åœ°ç®¡ç†</option>
            <option value="ç¨®æ¤">ç¨®æ¤ / è‚²è‹—</option>
            <option value="æ–½è‚¥">æ–½è‚¥</option>
            <option value="æ–½è—¥">â˜ ï¸ æ–½è—¥ (éœ€å¡«å®‰å…¨æ¡æ”¶æœŸ)</option>
            <option value="æ¡æ”¶">æ¡æ”¶</option>
            <option value="ç‰©æµé…é€">ğŸšš ç‰©æµé…é€</option>
        </select>
        
        <label>åŸ·è¡Œæ—¥æœŸ</label>
        <input type="date" id="rec-date">
        <small id="date-hint" style="color:#666;"></small>

        <div id="normal-inputs" style="margin-top: 15px;">
            <label>è©³ç´°å…§å®¹</label><input type="text" id="rec-detail" placeholder="ä¾‹å¦‚: ä½¿ç”¨æœ‰æ©Ÿè‚¥ / é †è±ç‰©æµ">
        </div>

        <div id="pesticide-inputs" class="pesticide-box">
            <h4 style="margin:0 0 10px 0; color:#e65100;">âš ï¸ æ–½è—¥ç®¡åˆ¶è³‡æ–™</h4>
            <label>è—¥å“åç¨±</label><input type="text" id="pest-name" placeholder="ä¾‹å¦‚: ç´ä¹ƒå¾—">
            <label>ç¨€é‡‹å€æ•¸</label><input type="text" id="pest-dose" placeholder="ä¾‹å¦‚: 1000å€">
            <label>å®‰å…¨æ¡æ”¶æœŸ (PHI å¤©æ•¸)</label><input type="number" id="pest-phi" placeholder="ä¾‹å¦‚: 7">
        </div>
        
        <label>å‚™è¨» (é¸å¡«)</label><input type="text" id="rec-note" placeholder="å…¶ä»–è£œå……äº‹é …...">
        <button class="action-btn btn-blue" onclick="addRecord()">â• æ–°å¢ç´€éŒ„ä¸Šéˆ</button>
    </div>

    <div id="section-check" class="form-section">
        <h2>ğŸ” ç‹€æ…‹è‡ªæˆ‘æª¢æŸ¥</h2>
        <input type="text" id="query-id" placeholder="è¼¸å…¥ç”¢å“ ID">
        <button class="action-btn btn-blue" style="margin-top:10px;" onclick="checkStatus()">æŸ¥è©¢</button>
        <div id="status-result" style="margin-top:20px; padding:15px; background:#fff; border:1px solid #ddd; display:none;"></div>
    </div>
</div>

<script>
    // ğŸ”¥ æ–°åˆç´„åœ°å€
    const contractAddress = "0x305255Adb4F3797F75F1e0a58fC622cF784Ea599";

    const contractABI = [
        { "inputs": [ { "internalType": "string", "name": "_id", "type": "string" }, { "internalType": "string", "name": "_date", "type": "string" }, { "internalType": "string", "name": "_transporter", "type": "string" }, { "internalType": "string", "name": "_action", "type": "string" }, { "internalType": "string", "name": "_note", "type": "string" }, { "internalType": "uint256", "name": "_phi", "type": "uint256" }, { "internalType": "uint256", "name": "_manualTimestamp", "type": "uint256" } ], "name": "addHistory", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
        { "inputs": [ { "internalType": "string", "name": "_id", "type": "string" }, { "internalType": "string", "name": "_name", "type": "string" }, { "internalType": "string", "name": "_loc", "type": "string" }, { "internalType": "string", "name": "_companyName", "type": "string" }, { "internalType": "string", "name": "_photoUrl", "type": "string" } ], "name": "registerProduct", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
        { "inputs": [ { "internalType": "string", "name": "_name", "type": "string" }, { "internalType": "string", "name": "_contact", "type": "string" }, { "internalType": "string", "name": "_bio", "type": "string" }, { "internalType": "string", "name": "_photoUrl", "type": "string" } ], "name": "updateCompanyProfile", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
        { "inputs": [ { "internalType": "string", "name": "_id", "type": "string" } ], "name": "getProduct", "outputs": [ { "internalType": "string", "name": "", "type": "string" }, { "internalType": "string", "name": "", "type": "string" }, { "internalType": "string", "name": "", "type": "string" }, { "internalType": "string", "name": "", "type": "string" }, { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }
    ];

    let web3, contract, userAccount;
    let currentCompanyName = "";

    window.onload = function() { setGeneralDateLimit(); }

   function switchTab(tabName) {
        // 1. å…ˆéš±è—æ‰€æœ‰å€å¡Š
        document.querySelectorAll('.form-section').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        // 2. é¡¯ç¤ºæŒ‡å®šçš„å€å¡Š
        document.getElementById('section-' + tabName).style.display = 'block';
        
        // 3. (ä¿®æ­£é») æ”¹ç”¨ç¬¨æ–¹æ³•ä¾†äº®ç‡ˆï¼Œä¸è¦ç”¨ event.target
        // é€™æ¨£ä¸ç®¡æ˜¯è‡ªå‹•åˆ‡æ›é‚„æ˜¯æ‰‹å‹•é»æ“Šï¼Œéƒ½ä¸æœƒå ±éŒ¯
        if(tabName == 'profile') document.querySelector("button[onclick*='profile']").classList.add('active');
        if(tabName == 'product') document.querySelector("button[onclick*='product']").classList.add('active');
        if(tabName == 'record') document.querySelector("button[onclick*='record']").classList.add('active');
        if(tabName == 'check') document.querySelector("button[onclick*='check']").classList.add('active');

        // 4. è‡ªå‹•å¸¶å…¥å…¬å¸åç¨±
        if(tabName === 'product' && currentCompanyName) {
            document.getElementById('p-company').value = currentCompanyName;
        }
    }

    function setGeneralDateLimit() {
        const d = document.getElementById("rec-date");
        const today = new Date().toISOString().split('T')[0];
        const past = new Date(); past.setDate(new Date().getDate() - 14);
        d.max = today; d.min = past.toISOString().split('T')[0];
        d.value = today; d.disabled = false;
        document.getElementById("date-hint").innerText = "ä¸€èˆ¬ä½œæ¥­å¯è£œç™» 14 å¤©å…§ç´€éŒ„";
    }

    function setPesticideDateLimit() {
        const d = document.getElementById("rec-date");
        const today = new Date().toISOString().split('T')[0];
        d.value = today; d.disabled = true;
        document.getElementById("date-hint").innerHTML = "<b style='color:red'>æ–½è—¥ä½œæ¥­é™åˆ¶åƒ…èƒ½ç™»éŒ„ç•¶æ—¥</b>";
    }

    function handleProcessChange() {
        const val = document.getElementById("rec-process").value;
        if(val === "æ–½è—¥") {
            document.getElementById("pesticide-inputs").style.display = "block";
            document.getElementById("normal-inputs").style.display = "none";
            setPesticideDateLimit();
        } else {
            document.getElementById("pesticide-inputs").style.display = "none";
            document.getElementById("normal-inputs").style.display = "block";
            setGeneralDateLimit();
        }
    }

    async function checkConnection() {
        if (window.ethereum) {
            web3 = new Web3(window.ethereum);
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];
                contract = new web3.eth.Contract(contractABI, contractAddress);
                document.getElementById('wallet-status').innerText = "ğŸŸ¢ å·²é€£ç·š: " + userAccount.substring(0,6) + "...";
                document.getElementById('wallet-status').classList.add('connected');
                return true;
            } catch (e) { alert("ä½¿ç”¨è€…æ‹’çµ•é€£ç·š"); return false; }
        } else { alert("è«‹å®‰è£ MetaMask"); return false; }
    }

    async function updateCompanyProfile() {
        if (!await checkConnection()) return;
        const name = document.getElementById('f-brand').value;
        const contact = document.getElementById('f-contact').value;
        const bio = document.getElementById('f-bio').value;
        const photo = document.getElementById('f-photo').value;

        if(!name) return alert("å…¬å¸åç¨±ç‚ºå¿…å¡«");

        try {
            await contract.methods.updateCompanyProfile(name, contact, bio, photo).send({ from: userAccount });
            alert("âœ… å…¬å¸è³‡æ–™æ›´æ–°æˆåŠŸï¼");
            currentCompanyName = name;
            switchTab('product');
        } catch (e) { alert("äº¤æ˜“å¤±æ•—: " + e.message); }
    }

    async function registerProduct() {
        if (!await checkConnection()) return;
        const id = document.getElementById("p-id").value;
        const name = document.getElementById("p-name").value;
        const loc = document.getElementById("p-location").value;
        const company = document.getElementById("p-company").value;
        const photo = document.getElementById("p-photo").value;

        if(!id || !company) return alert("ID èˆ‡å…¬å¸åç¨±ç‚ºå¿…å¡«");

        try {
            await contract.methods.registerProduct(id, name, loc, company, photo).send({ from: userAccount });
            alert("âœ… ç”¢å“è¨»å†ŠæˆåŠŸï¼");
            document.getElementById("rec-id").value = id; // è‡ªå‹•å¡«å…¥ä¸‹ä¸€é 
            switchTab('record');
        } catch (e) { alert("äº¤æ˜“å¤±æ•—: " + e.message); }
    }

    async function addRecord() {
        if (!await checkConnection()) return;
        
        const id = document.getElementById("rec-id").value;
        const type = document.getElementById("rec-process").value;
        let dateVal = document.getElementById("rec-date").value;
        const note = document.getElementById("rec-note").value;
        
        let actionStr = "";
        let phi = 0;

        // æ ¹æ“šé¡å‹çµ„è£å­—ä¸²
        if (type === "æ–½è—¥") {
            dateVal = new Date().toISOString().split('T')[0]; // å¼·åˆ¶ä»Šå¤©
            const pName = document.getElementById("pest-name").value;
            const pDose = document.getElementById("pest-dose").value;
            phi = document.getElementById("pest-phi").value;
            if(!pName || !phi) return alert("æ–½è—¥åç¨±èˆ‡ PHI å€¼å¿…å¡«");
            actionStr = `æ–½è—¥: ${pName} / å€æ•¸: ${pDose}`;
        } else {
            const detail = document.getElementById("rec-detail").value;
            actionStr = `${type}: ${detail}`;
        }

        // è¨ˆç®— Timestamp
        const timestamp = Math.floor(new Date(dateVal).getTime() / 1000);

        try {
            // æ³¨æ„åƒæ•¸é †åº: id, date, transporter(ç©º), action, note, phi, timestamp
            await contract.methods.addHistory(id, dateVal, "", actionStr, note, phi, timestamp)
                .send({ from: userAccount });
            alert("âœ… ç´€éŒ„ä¸ŠéˆæˆåŠŸï¼");
        } catch (e) { 
            console.error(e);
            alert("äº¤æ˜“å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Console æˆ–ç¢ºèªæ˜¯å¦æ‹’çµ•äº†äº¤æ˜“ã€‚"); 
        }
    }

    async function checkStatus() {
        if (!await checkConnection()) return;
        const id = document.getElementById('query-id').value;
        const box = document.getElementById('status-result');
        try {
            const p = await contract.methods.getProduct(id).call();
            if(!p[0]) {
                box.innerHTML = "<span style='color:red'>æŸ¥ç„¡æ­¤ IDï¼Œè«‹å…ˆè¨»å†Šã€‚</span>";
            } else {
                box.innerHTML = `<span style='color:green'><b>${p[1]}</b> å·²å­˜åœ¨ (å…¬å¸: ${p[3]})</span>`;
            }
            box.style.display = 'block';
        } catch(e) { alert("æŸ¥è©¢éŒ¯èª¤"); }
    }
</script>
</body>
</html>