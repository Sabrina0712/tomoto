<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾²å¤«ç”Ÿç”¢ç®¡ç†ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <style>
        /* === V8 æ¨£å¼ === */
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #f1f8e9; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: #2e7d32; margin-bottom: 10px; }
        .wallet-bar { text-align: center; margin-bottom: 30px; background: #e8f5e9; padding: 10px; border-radius: 8px; }
        .status-badge { font-weight: bold; color: #c62828; }
        .status-badge.connected { color: #2e7d32; }

        h3 { border-left: 5px solid #4caf50; padding-left: 12px; color: #388e3c; margin-top: 40px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        
        label { display: block; margin: 8px 0 5px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        input:focus { border-color: #4caf50; outline: none; }
        
        /* é–å®šæˆ–ç„¡æ•ˆæ—¥æœŸçš„æ¨£å¼ */
        input:disabled { background-color: #e0e0e0; cursor: not-allowed; border: 1px dashed #999; color: #555; font-weight: bold; }
        
        /* ğŸ”¥ é€™æ˜¯ç€è¦½å™¨åŸç”ŸåŠŸèƒ½ï¼šä¸ç¬¦åˆ min/max çš„æ—¥æœŸæœƒé¡¯ç¤ºç´…æ¡† (å¦‚æœç€è¦½å™¨æ”¯æ´) */
        input[type="date"]:invalid { border-color: #c62828; }

        button { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .btn-green { background: #2e7d32; color: white; }
        .btn-green:hover { background: #1b5e20; }
        .btn-blue { background: #1565c0; color: white; }
        .btn-blue:hover { background: #0d47a1; }
        .btn-orange { background: #f57c00; color: white; }
        .btn-orange:hover { background: #ef6c00; }

        .pesticide-box { display: none; background: #ffebee; border: 2px solid #ef5350; padding: 20px; border-radius: 8px; margin-top: 15px; }
        .warning-text { color: #d32f2f; font-size: 0.9em; margin-top: 5px; font-weight: bold; }
        .status-result-box { margin-top: 20px; padding: 20px; border-radius: 8px; background: #f1f8e9; border: 1px solid #c8e6c9; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>è¾²å¤«ç”Ÿç”¢ç®¡ç†ç³»çµ±</h1>
    
    <div class="wallet-bar">
        ç‹€æ…‹ï¼š<span id="wallet-status" class="status-badge">ğŸ”´ æœªé€£ç·š</span>
        <button onclick="checkConnection()" style="width: auto; padding: 5px 15px; margin-left: 10px; background:#4caf50; color:white;">ğŸ”— é€£ç·šéŒ¢åŒ…</button>
    </div>

    <h3>1. è¨»å†Šæ–°ç”¢å“</h3>
    <div class="form-grid">
        <div><label>ç”¢å“ ID</label><input type="text" id="p-id" placeholder="ä¾‹å¦‚: P005"></div>
        <div><label>ç”¢å“åç¨±</label><input type="text" id="p-name" placeholder="ä¾‹å¦‚: ç‰å¥³ç•ªèŒ„"></div>
        <div><label>ç”¢åœ°</label><input type="text" id="p-location" placeholder="å˜‰ç¾©ç¸£å¤ªä¿å¸‚"></div>
        <div><label>ç”Ÿç”¢è€…å§“å</label><input type="text" id="p-farmer"placeholder="é™³å¤§è¾²"></div>
        <div class="full-width"><label>ç”¢å“ç…§ç‰‡ (åœ–ç‰‡ç¶²å€)</label><input type="text" id="p-photo" placeholder="https://..."></div>
    </div>
    <button class="btn-green" onclick="registerProduct()">âœ… å¯«å…¥å€å¡Šéˆ (è¨»å†Š)</button>

    <hr style="margin: 40px 0; border: 0; border-top: 1px dashed #ccc;">

    <h3>2. æ–°å¢ç”Ÿç”¢ / æ–½è—¥ç´€éŒ„</h3>
    <div class="form-grid">
        <div class="full-width"><label>ç›®æ¨™ç”¢å“ ID</label><input type="text" id="rec-id" placeholder="è¼¸å…¥è¦æ›´æ–°çš„ç”¢å“ ID"></div>
        
        <div>
            <label>åŸ·è¡Œå‹•ä½œ</label>
            <select id="rec-process" onchange="handleProcessChange()">
                <option value="è€•åœ°ç®¡ç†">è€•åœ°ç®¡ç†</option>
                <option value="ç¨®æ¤">ç¨®æ¤ / è‚²è‹—</option>
                <option value="æ–½è‚¥">æ–½è‚¥</option>
                <option value="æ–½è—¥">â˜ ï¸ æ–½è—¥</option>
                <option value="æ¡æ”¶">æ¡æ”¶</option>
                <option value="åŠ å·¥/åŒ…è£">åŠ å·¥ / åŒ…è£</option>
            </select>
        </div>
        <div>
            <label>åŸ·è¡Œæ—¥æœŸ</label>
            <input type="date" id="rec-date">
            <small id="date-hint" style="color:#666; font-size:0.8em; display:block; margin-top:5px;">ä¸€èˆ¬ä½œæ¥­åƒ…é™è£œç™» 14 å¤©å…§</small>
        </div>
    </div>

    <div id="normal-inputs" style="margin-top: 15px;">
        <label>ä½œæ¥­å…§å®¹</label>
        <input type="text" id="rec-detail" placeholder="ä¾‹å¦‚: ä½¿ç”¨æœ‰æ©Ÿè‚¥æ–™">
    </div>

    <div id="pesticide-inputs" class="pesticide-box">
        <h4 style="margin:0 0 10px 0; color:#c62828;">æ–½è—¥ç®¡åˆ¶è³‡æ–™</h4>
        <div class="form-grid">
            <div><label>è¾²è—¥åç¨±</label><input type="text" id="pest-name" placeholder="ä¾‹å¦‚: ç´ä¹ƒå¾—"></div>
            <div><label>åŠ‘é‡/å€æ•¸</label><input type="text" id="pest-dose" placeholder="ä¾‹å¦‚: 1000å€"></div>
            <div class="full-width">
                <label>å®‰å…¨æ¡æ”¶æœŸ (PHI å¤©æ•¸)</label>
                <input type="number" id="pest-phi" placeholder="ä¾‹å¦‚: 7 (ä»£è¡¨7å¤©å…§ç¦æ­¢æ¡æ”¶)">
                <div class="warning-text">âš ï¸ ç³»çµ±å°‡ä¾æ“šæ­¤å¤©æ•¸é–å®šæ¡æ”¶åŠŸèƒ½ã€‚</div>
            </div>
        </div>
    </div>

    <div style="margin-top: 15px;">
        <label>å‚™è¨» (é¸å¡«)</label>
        <input type="text" id="rec-note" placeholder="å…¶ä»–è£œå……äº‹é …...">
    </div>

    <button class="btn-blue" onclick="addRecord()">â• æ–°å¢ç´€éŒ„åˆ°å€å¡Šéˆ</button>

    <hr style="margin: 40px 0; border: 0; border-top: 1px dashed #ccc;">

    <h3>3. ç‹€æ…‹æŸ¥è©¢ (ID è‡ªæˆ‘æª¢æŸ¥)</h3>
    <div style="display: flex; gap: 10px;">
        <input type="text" id="query-id" placeholder="è¼¸å…¥ç”¢å“ ID (ä¾‹å¦‚: P005)" style="flex:1;">
        <button class="btn-orange" onclick="checkStatus()" style="margin-top:0; width:auto; padding: 0 30px;">ğŸ” æŸ¥è©¢ç‹€æ…‹</button>
    </div>
    <div id="status-result" class="status-result-box"></div>

</div>

<script>
    // åˆç´„åœ°å€
    const contractAddress = "0xf7ACEF0084b480F240643eaF9e292E7dd4B46d8F"; 

    // ABI
    const contractABI = [
        {"inputs":[{"internalType":"string","name":"_id","type":"string"},{"internalType":"string","name":"_name","type":"string"},{"internalType":"string","name":"_location","type":"string"},{"internalType":"string","name":"_farmer","type":"string"},{"internalType":"string","name":"_photoUrl","type":"string"}],"name":"registerProduct","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"string","name":"_id","type":"string"},{"internalType":"string","name":"_date","type":"string"},{"internalType":"string","name":"_action","type":"string"},{"internalType":"string","name":"_note","type":"string"},{"internalType":"uint256","name":"_phi","type":"uint256"},{"internalType":"uint256","name":"_dateTimestamp","type":"uint256"}],"name":"addHistory","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"getProduct","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    let web3, contract;

    window.onload = function() {
        setGeneralDateLimit();
    }

    async function checkConnection() {
        if (window.ethereum) {
            try {
                web3 = new Web3(window.ethereum);
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                const accounts = await web3.eth.getAccounts();
                contract = new web3.eth.Contract(contractABI, contractAddress);
                document.getElementById('wallet-status').innerText = "ğŸŸ¢ å·²é€£ç·š";
                document.getElementById('wallet-status').className = "status-badge connected";
                return true;
            } catch (error) { console.error(error); alert("é€£ç·šå¤±æ•—"); return false; }
        } else { alert("è«‹å®‰è£ MetaMask"); return false; }
    }

    // ğŸ”¥ é‡é»é‚è¼¯ï¼šè¨­å®šä¸€èˆ¬ä½œæ¥­çš„æ—¥æœŸé™åˆ¶ (é–æœªä¾† + é–é€¾æœŸ) ğŸ”¥
    function setGeneralDateLimit() {
        const dateInput = document.getElementById("rec-date");
        const today = new Date();
        const pastDate = new Date();
        
        // è¨­å®š 14 å¤©å‰
        pastDate.setDate(today.getDate() - 14); 

        // æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD
        // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨æœ¬åœ°æ™‚é–“è½‰æ›ï¼Œé¿å…æ™‚å€å•é¡Œ
        const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const maxStr = formatDate(today);      // ä»Šå¤© (ä¸èƒ½é¸æœªä¾†)
        const minStr = formatDate(pastDate);   // 14å¤©å‰ (ä¸èƒ½é¸æ›´æ—©)

        dateInput.disabled = false;
        dateInput.max = maxStr;  // ğŸ”¥ é–å®šæœªä¾†æ—¥æœŸ (ä½¿ç”¨è€…é»ä¸åˆ°æ˜å¤©)
        dateInput.min = minStr;  // ğŸ”¥ é–å®š14å¤©å‰çš„æ—¥æœŸ
        dateInput.value = maxStr; // é è¨­ç‚ºä»Šå¤©

        document.getElementById("date-hint").innerHTML = `ä¸€èˆ¬ä½œæ¥­å€é–“ï¼š${minStr} è‡³ ${maxStr} (ä»Šå¤©)`;
        document.getElementById("date-hint").style.color = "#666";
    }

    // ğŸ”¥ è¨­å®šæ–½è—¥çš„æ—¥æœŸé™åˆ¶ (åš´æ ¼é–å®šä»Šå¤©)
    function setPesticideDateLimit() {
        const dateInput = document.getElementById("rec-date");
        
        // æ ¼å¼åŒ–ä»Šå¤©
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const todayStr = `${year}-${month}-${day}`;

        dateInput.value = todayStr;
        dateInput.disabled = true; // æ•´æ¬„é–æ­»
        
        // é›–ç„¶é–æ­»äº†ï¼Œä½†æˆ‘å€‘é‚„æ˜¯æŠŠ min/max è¨­ç‚ºä»Šå¤©ï¼Œé›™é‡ä¿éšª
        dateInput.max = todayStr;
        dateInput.min = todayStr;

        document.getElementById("date-hint").innerHTML = "<b style='color:red;'>ğŸš« æ–½è—¥ä½œæ¥­å¿…é ˆç•¶æ—¥ç”³å ±ï¼Œç„¡æ³•ä¿®æ”¹æ—¥æœŸã€‚</b>";
    }

    // è™•ç†ä¸‹æ‹‰é¸å–®åˆ‡æ›
    function handleProcessChange() {
        const type = document.getElementById("rec-process").value;
        const pestBox = document.getElementById("pesticide-inputs");
        const normalBox = document.getElementById("normal-inputs");

        if (type.includes("æ–½è—¥")) {
            pestBox.style.display = "block";
            normalBox.style.display = "none";
            setPesticideDateLimit(); // å¥—ç”¨æ–½è—¥é–å®š
        } else {
            pestBox.style.display = "none";
            normalBox.style.display = "block";
            setGeneralDateLimit(); // å¥—ç”¨ä¸€èˆ¬ä½œæ¥­é™åˆ¶ (14å¤©å€é–“)
        }
    }

    async function registerProduct() {
        if (!await checkConnection()) return;
        const [id, name, loc, farmer, photo] = ["p-id","p-name","p-location","p-farmer","p-photo"].map(x=>document.getElementById(x).value);
        if(!id || !name) return alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™");
        try {
            await contract.methods.registerProduct(id, name, loc, farmer, photo).send({ from: (await web3.eth.getAccounts())[0] });
            alert("âœ… ç”¢å“è¨»å†ŠæˆåŠŸï¼");
        } catch (err) { alert("äº¤æ˜“å¤±æ•—: " + err.message); }
    }

    async function addRecord() {
        if (!await checkConnection()) return;
        const id = document.getElementById("rec-id").value;
        const type = document.getElementById("rec-process").value;
        let dateVal = document.getElementById("rec-date").value;
        const noteRaw = document.getElementById("rec-note").value;

        if(!id) return alert("è«‹è¼¸å…¥ç”¢å“ ID");

        let actionStr = "", phi = 0;

        // é‚è¼¯å±¤æª¢æŸ¥ (é˜²æ­¢ä½¿ç”¨è€…ç¹é UI é™åˆ¶)
        if (type.includes("æ–½è—¥")) {
            dateVal = new Date().toISOString().split('T')[0]; // å¼·åˆ¶ä»Šå¤©
            const [pName, pDose, pPhi] = ["pest-name","pest-dose","pest-phi"].map(x=>document.getElementById(x).value);
            if(!pName || !pDose || !pPhi) return alert("âŒ æ–½è—¥è³‡æ–™ä¸å®Œæ•´");
            actionStr = `æ–½è—¥: ${pName} / åŠ‘é‡: ${pDose}`;
            phi = parseInt(pPhi);
        } else {
            if(!dateVal) return alert("è«‹é¸æ“‡æ—¥æœŸ");
            
            // æª¢æŸ¥æ˜¯å¦è¶…éç¯„åœ
            const selDate = new Date(dateVal);
            const today = new Date();
            const limit = new Date(); 
            limit.setDate(today.getDate() - 14);
            
            // æ­¸é›¶æ™‚é–“éƒ¨åˆ†ä»¥ä¾¿æ¯”è¼ƒ
            selDate.setHours(0,0,0,0); today.setHours(0,0,0,0); limit.setHours(0,0,0,0);

            if (selDate < limit) return alert("âŒ éŒ¯èª¤ï¼šä¸èƒ½è£œç™»è¶…é 14 å¤©å‰çš„ç´€éŒ„");
            if (selDate > today) return alert("âŒ éŒ¯èª¤ï¼šä¸èƒ½è¼¸å…¥æœªä¾†æ—¥æœŸ");
            
            actionStr = `${type}: ${document.getElementById("rec-detail").value}`;
        }

        const timestamp = Math.floor(new Date(dateVal).getTime() / 1000);
        try {
            await contract.methods.addHistory(id, dateVal, actionStr, noteRaw, phi, timestamp).send({ from: (await web3.eth.getAccounts())[0] });
            alert("âœ… ç´€éŒ„å·²ä¸Šéˆï¼" + (phi > 0 ? `\nâš ï¸ é–å®š ${phi} å¤©ã€‚` : ""));
            document.getElementById("rec-detail").value = "";
            document.getElementById("pest-name").value = "";
        } catch (err) { alert("äº¤æ˜“å¤±æ•—: " + err.message); }
    }

    async function checkStatus() {
        if (!await checkConnection()) return;
        const id = document.getElementById("query-id").value.trim();
        if(!id) return alert("è«‹è¼¸å…¥ ID");
        try {
            const p = await contract.methods.getProduct(id).call();
            if(!p[0]) throw new Error("æŸ¥ç„¡æ­¤ ID");
            const resultBox = document.getElementById("status-result");
            resultBox.style.display = "block";
            const unlockTime = parseInt(p[4]); 
            const now = Math.floor(Date.now() / 1000);
            
            let statusHtml = "";
            if (unlockTime > now) {
                const waitDays = ((unlockTime - now) / 86400).toFixed(1);
                statusHtml = `<div style="padding:10px; background:#ffebee; border-left:5px solid #c62828;"><div style="color:#d32f2f; font-weight:bold;">â›” è—¥æª¢é–å®šä¸­</div><div style="color:#c62828;">å°šéœ€ç­‰å¾… ${waitDays} å¤©ã€‚</div></div>`;
            } else {
                statusHtml = `<div style="padding:10px; background:#e8f5e9; border-left:5px solid #2e7d32;"><div style="color:#2e7d32; font-weight:bold;">âœ… å®‰å…¨æœŸå·²é</div></div>`;
            }
            resultBox.innerHTML = `<h3>${p[0]}</h3><p>ç”¢åœ°ï¼š${p[1]} | è¾²å¤«ï¼š${p[2]}</p>${statusHtml}`;
        } catch (err) { console.error(err); alert("æŸ¥è©¢å¤±æ•—ï¼š" + err.message); }
    }
</script>

</body>
</html>
