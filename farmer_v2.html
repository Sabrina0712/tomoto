<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾²å¤«æ™ºæ…§ç®¡ç†å¾Œå°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
 
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 10px; flex-wrap: wrap; }
        .tab-btn { flex: 1; padding: 12px; cursor: pointer; background: #f0f0f0; border: none; border-radius: 8px 8px 0 0; font-weight: bold; font-size: 1rem; color: #555; transition: 0.3s; min-width: 150px; }
        .tab-btn:hover { background: #e0e0e0; }
        .tab-btn.active { background: #2e7d32; color: white; transform: translateY(2px); }

       
        .form-section { display: none; animation: fadeIn 0.4s; }
        .form-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }


        h2 { margin-top: 0; color: #2e7d32; border-left: 5px solid #2e7d32; padding-left: 10px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; margin-top: 15px; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        input:focus, select:focus, textarea:focus { border-color: #2e7d32; outline: none; }
        
        button.action-btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-size: 1.1rem; cursor: pointer; font-weight: bold; margin-top: 20px; transition: 0.2s; }
        .btn-green { background: #2e7d32; color: white; }
        .btn-green:hover { background: #1b5e20; }
        .btn-blue { background: #1565c0; color: white; }
        .btn-blue:hover { background: #0d47a1; }
        .btn-orange { background: #ff9800; color: white; }
        
        .pesticide-box { background: #ffebee; padding: 15px; border-radius: 8px; border: 1px solid #ffcdd2; display: none; margin-top: 15px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        .warning-text { font-size: 0.9em; color: #c62828; margin-top: 5px; }
        
    .status-badge { 
        padding: 5px 10px; 
        border-radius: 20px; 
        float: right;
    }

        .status-badge.connected {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .status-result-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #fafafa;
            border: 1px solid #eee;
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="wallet-status" class="status-badge" onclick="checkConnection()" style="cursor: pointer;">
    ğŸ”´ é»æ“Šé€£ç·š
</div>
    
    <div class="tab-buttons">
        <button class="tab-btn active" onclick="switchTab(this, 'profile')">1. è¨­å®šå€‹äººæª”æ¡ˆ</button>
        <button class="tab-btn" onclick="switchTab(this, 'product')">2. å»ºç«‹æ–°ç”¢å“</button>
        <button class="tab-btn" onclick="switchTab(this, 'record')">3. æ–°å¢ç”Ÿé•·ç´€éŒ„</button>
        <button class="tab-btn" onclick="switchTab(this, 'check')">4. ç‹€æ…‹æŸ¥è©¢</button>
    </div>

    <div id="section-profile" class="form-section active">
        <h2>è¨­å®šè¾²å¤«å±¥æ­·</h2>
        <p style="color:#666; font-size:0.9rem;">è¨­å®šä¸€æ¬¡å³å¯ï¼Œæœªä¾†å»ºç«‹ç”¢å“æ™‚æœƒè‡ªå‹•å¸¶å…¥æ‚¨çš„åå­—ã€‚</p>
        
        <label>æ‚¨çš„å§“å (ID)</label>
        <input type="text" id="f-name" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">

        <label>è¾²å ´åœ°é»</label>
        <input type="text" id="f-loc" placeholder="ä¾‹å¦‚ï¼šå°ä¸­å¸‚å¤ªå¹³å€">

        <label>å¤§é ­è²¼ç¶²å€</label>
        <input type="text" id="f-photo" placeholder="https://...">

        <label>è¯çµ¡é›»è©±</label>
        <input type="text" id="f-contact" placeholder="0912-345-678">

        <label>è‡ªæˆ‘ä»‹ç´¹</label>
        <textarea id="f-desc" rows="4" placeholder="è«‹ä»‹ç´¹æ‚¨çš„ç¨®æ¤ç†å¿µ..."></textarea>

        <button class="action-btn btn-green" onclick="updateProfile()">å„²å­˜å€‹äººæª”æ¡ˆ</button>
    </div>

    <div id="section-product" class="form-section">
        <h2>ğŸŒ± è¨»å†Šæ–°ç”¢å“</h2>
        
        <label>ç”¢å“ ID (å”¯ä¸€ç·¨è™Ÿ)</label>
        <input type="text" id="p-id" placeholder="ä¾‹å¦‚: P005">
        
        <label>ç”¢å“åç¨±</label>
        <input type="text" id="p-name" placeholder="ä¾‹å¦‚: é«˜å±±é«˜éº—èœ">
        
        <label>ç”Ÿç”¢è€…å§“å (è‡ªå‹•å¸¶å…¥)</label>
        <input type="text" id="p-farmer" readonly style="background:#eee; color:#555;">

        <label>ç”¢åœ°</label>
        <input type="text" id="p-location" placeholder="ä¾‹å¦‚: å°ä¸­å¸‚">

        <label>ç”¢å“ç…§ç‰‡ç¶²å€</label>
        <input type="text" id="p-photo" placeholder="https://...">

        <button class="action-btn btn-green" onclick="registerProduct()">è¨»å†Šç”¢å“ä¸Šéˆ</button>
    </div>

    <div id="section-record" class="form-section">
        <h2>ğŸ“æ–°å¢ç”Ÿé•·/æ–½è—¥ç´€éŒ„</h2>
        
        <label>ç”¢å“ ID</label>
        <input type="text" id="rec-id" placeholder="è¼¸å…¥ç”¢å“ ID">

        <div class="form-grid">
            <div>
                <label>åŸ·è¡Œå‹•ä½œ</label>
                <select id="rec-process" onchange="handleProcessChange()">
                    <option value="è€•åœ°ç®¡ç†">è€•åœ°ç®¡ç†</option>
                    <option value="ç¨®æ¤">ç¨®æ¤ / è‚²è‹—</option>
                    <option value="æ–½è‚¥">æ–½è‚¥</option>
                    <option value="æ–½è—¥">â˜ ï¸ æ–½è—¥ (åš´æ ¼ç®¡åˆ¶)</option>
                    <option value="æ¡æ”¶">æ¡æ”¶</option>
                    <option value="åŠ å·¥/åŒ…è£">åŠ å·¥ / åŒ…è£</option>
                </select>
            </div>
            <div>
                <label>åŸ·è¡Œæ—¥æœŸ</label>
                <input type="date" id="rec-date">
                <small id="date-hint" style="color:#666; font-size:0.8em; display:block; margin-top:5px;">ä¸€èˆ¬ä½œæ¥­åƒ…é™è£œç™» 14 å¤©å…§</small>
            </div>
        </div>

        <div id="normal-inputs" style="margin-top: 15px;">
            <label>ä½œæ¥­å…§å®¹</label>
            <input type="text" id="rec-detail" placeholder="ä¾‹å¦‚: ä½¿ç”¨æœ‰æ©Ÿè‚¥æ–™">
        </div>

        <div id="pesticide-inputs" class="pesticide-box">
            <h4 style="margin:0 0 10px 0; color:#c62828;"><i class="fas fa-skull-crossbones"></i> æ–½è—¥ç®¡åˆ¶è³‡æ–™</h4>
            <div class="form-grid">
                <div><label>è¾²è—¥åç¨±</label><input type="text" id="pest-name" placeholder="ä¾‹å¦‚: ç´ä¹ƒå¾—"></div>
                <div><label>åŠ‘é‡/å€æ•¸</label><input type="text" id="pest-dose" placeholder="ä¾‹å¦‚: 1000å€"></div>
                <div class="full-width">
                    <label>å®‰å…¨æ¡æ”¶æœŸ (PHI å¤©æ•¸)</label>
                    <input type="number" id="pest-phi" placeholder="ä¾‹å¦‚: 7 (ä»£è¡¨7å¤©å…§ç¦æ­¢æ¡æ”¶)">
                    <div class="warning-text">âš ï¸ ç³»çµ±å°‡ä¾æ“šæ­¤å¤©æ•¸é–å®šæ¡æ”¶åŠŸèƒ½ã€‚</div>
                </div>
            </div>
        </div>

        <div style="margin-top: 15px;">
            <label>å‚™è¨» (é¸å¡«)</label>
            <input type="text" id="rec-note" placeholder="å…¶ä»–è£œå……äº‹é …...">
        </div>

        <button class="action-btn btn-blue" onclick="addRecord()">â• æ–°å¢ç´€éŒ„åˆ°å€å¡Šéˆ</button>
    </div>

    <div id="section-check" class="form-section">
        <h2>ğŸ” ç”¢å“ç‹€æ…‹è‡ªæˆ‘æª¢æŸ¥</h2>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="query-id" placeholder="è¼¸å…¥ç”¢å“ ID (ä¾‹å¦‚: P005)" style="flex:1;">
            <button class="action-btn btn-orange" onclick="checkStatus()" style="margin-top:0; width:auto; padding: 0 30px;">æŸ¥è©¢</button>
        </div>
        <div id="status-result" class="status-result-box"></div>
    </div>

</div>

<script>
    const contractAddress = "0x0136f45A37d68630e2C33Bd228C61F20b23a27a5";
    const contractABI = [{"inputs":[{"internalType":"string","name":"_id","type":"string"},{"internalType":"string","name":"_date","type":"string"},{"internalType":"string","name":"_action","type":"string"},{"internalType":"string","name":"_note","type":"string"},{"internalType":"uint256","name":"_phi","type":"uint256"},{"internalType":"uint256","name":"_dateTimestamp","type":"uint256"}],"name":"addHistory","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_name","type":"string"},{"internalType":"string","name":"_location","type":"string"},{"internalType":"string","name":"_desc","type":"string"},{"internalType":"string","name":"_photo","type":"string"},{"internalType":"string","name":"_contact","type":"string"}],"name":"updateFarmerProfile","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_id","type":"string"},{"internalType":"string","name":"_name","type":"string"},{"internalType":"string","name":"_loc","type":"string"},{"internalType":"string","name":"_farmer","type":"string"},{"internalType":"string","name":"_photo","type":"string"}],"name":"registerProduct","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"getProduct","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];

    let web3;
    let contract;
    let userAccount;

    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }


    function switchTab(btnElement, tabName) {
        const sections = document.querySelectorAll('.form-section');
        for(let i=0; i<sections.length; i++) {
            sections[i].style.display = 'none';
        }
        
        const buttons = document.querySelectorAll('.tab-btn');
        for(let i=0; i<buttons.length; i++) {
            buttons[i].classList.remove('active');
        }

        document.getElementById('section-' + tabName).style.display = 'block';
        if(btnElement) {
            btnElement.classList.add('active');
        }

        if(tabName === 'product') {
            const fName = document.getElementById('f-name').value;
            document.getElementById('p-farmer').value = fName;
            if(!fName) alert("ğŸ’¡ æç¤ºï¼šå»ºè­°å…ˆåˆ°ç¬¬ä¸€é ã€Œè¨­å®šå€‹äººæª”æ¡ˆã€å¡«å¯«å§“åï¼Œç³»çµ±æœƒè‡ªå‹•å¸¶å…¥ã€‚");
        }
        if(tabName === 'record') {
            const lastId = document.getElementById('p-id').value;
            if(lastId) document.getElementById('rec-id').value = lastId;
        }
    }

    async function checkConnection() {
        if (typeof window.ethereum !== 'undefined') {
            try {
                web3 = new Web3(window.ethereum);
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                const accounts = await web3.eth.getAccounts();
                userAccount = accounts[0];
                contract = new web3.eth.Contract(contractABI, contractAddress);
                
                const badge = document.getElementById('wallet-status');
                badge.innerText = "ğŸŸ¢ å·²é€£ç·š: " + userAccount.substring(0,6) + "...";
                badge.className = "status-badge connected";
                return true;
            } catch (error) { 
                console.error(error); 
                alert("é€£ç·šå¤±æ•—ï¼š" + error.message); 
                return false; 
            }
        } else { 
            alert("è«‹å®‰è£ MetaMask æ“´å……åŠŸèƒ½ï¼"); 
            return false; 
        }
    }

    window.onload = function() {
        setGeneralDateLimit(); 
    }

    async function updateProfile() {
        if (!await checkConnection()) return;
        
        const name = document.getElementById('f-name').value;
        const loc = document.getElementById('f-loc').value;
        const photo = document.getElementById('f-photo').value;
        const desc = document.getElementById('f-desc').value;
        const contact = document.getElementById('f-contact').value;

        if(!name) return alert("å§“åç‚ºå¿…å¡«é …ç›®");

        try {
            await contract.methods.updateFarmerProfile(name, loc, desc, photo, contact)
                .send({ from: userAccount });
            alert("âœ… å€‹äººæª”æ¡ˆå·²æ›´æ–°ï¼");
        } catch (err) { alert("âŒ å¤±æ•—ï¼š" + err.message); }
    }


    async function registerProduct() {
        if (!await checkConnection()) return;
        
        const id = document.getElementById("p-id").value;
        const name = document.getElementById("p-name").value;
        const loc = document.getElementById("p-location").value;
        const farmer = document.getElementById("p-farmer").value;
        const photo = document.getElementById("p-photo").value;

        if(!id || !name || !farmer) return alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™ (å§“åéœ€å¾ç¬¬ä¸€é è¨­å®š)");
        
        try {
            await contract.methods.registerProduct(id, name, loc, farmer, photo).send({ from: userAccount });
            alert("âœ… ç”¢å“è¨»å†ŠæˆåŠŸï¼è«‹åˆ‡æ›åˆ°ç¬¬ä¸‰é è¼¸å…¥ç”Ÿé•·ç´€éŒ„ã€‚");
        } catch (err) { alert("äº¤æ˜“å¤±æ•—: " + err.message); }
    }

    function setGeneralDateLimit() {
        const dateInput = document.getElementById("rec-date");
        const today = new Date();
        const pastDate = new Date();
        pastDate.setDate(today.getDate() - 14);
        
        const maxStr = formatDate(today);
        const minStr = formatDate(pastDate);
        
        dateInput.disabled = false;
        dateInput.max = maxStr; 
        dateInput.min = minStr;
        dateInput.value = maxStr;
        
        const hint = document.getElementById("date-hint");
        hint.innerHTML = `ä¸€èˆ¬ä½œæ¥­å€é–“ï¼š${minStr} è‡³ ${maxStr} (ä»Šå¤©)`;
        hint.style.color = "#666";
    }

    function setPesticideDateLimit() {
        const dateInput = document.getElementById("rec-date");
        const today = new Date();
        const todayStr = formatDate(today);
        
        dateInput.value = todayStr;
        dateInput.disabled = true;
        
        const hint = document.getElementById("date-hint");
        hint.innerHTML = "<b style='color:red;'>ğŸš« æ–½è—¥ä½œæ¥­å¿…é ˆç•¶æ—¥ç”³å ±ï¼Œç„¡æ³•ä¿®æ”¹æ—¥æœŸã€‚</b>";
    }

    function handleProcessChange() {
        const type = document.getElementById("rec-process").value;
        const pestBox = document.getElementById("pesticide-inputs");
        const normalBox = document.getElementById("normal-inputs");
        
        if (type.includes("æ–½è—¥")) {
            pestBox.style.display = "block";
            normalBox.style.display = "none";
            setPesticideDateLimit();
        } else {
            pestBox.style.display = "none";
            normalBox.style.display = "block";
            setGeneralDateLimit();
        }
    }

    async function addRecord() {
        if (!await checkConnection()) return;
        
        const id = document.getElementById("rec-id").value;
        const type = document.getElementById("rec-process").value;
        let dateVal = document.getElementById("rec-date").value;
        const noteRaw = document.getElementById("rec-note").value;

        if(!id) return alert("è«‹è¼¸å…¥ç”¢å“ ID");

        let actionStr = "";
        let phi = 0;

        if (type.includes("æ–½è—¥")) {
            dateVal = new Date().toISOString().split('T')[0]; // å¼·åˆ¶ç•¶å¤©
            const pName = document.getElementById("pest-name").value;
            const pDose = document.getElementById("pest-dose").value;
            const pPhiInput = document.getElementById("pest-phi").value;

            if(!pName || !pDose || !pPhiInput) return alert("âŒ æ–½è—¥è³‡æ–™ä¸å®Œæ•´");
            
            actionStr = `æ–½è—¥: ${pName} / åŠ‘é‡: ${pDose}`;
            phi = parseInt(pPhiInput) || 0;
        } else {
            if(!dateVal) return alert("è«‹é¸æ“‡æ—¥æœŸ");
            const selDate = new Date(dateVal);
            const today = new Date();
            const limit = new Date();
            limit.setDate(today.getDate() - 14);
            
            selDate.setHours(0,0,0,0); today.setHours(0,0,0,0); limit.setHours(0,0,0,0);
            
            if (selDate < limit) return alert("âŒ éŒ¯èª¤ï¼šä¸èƒ½è£œç™»è¶…é 14 å¤©å‰çš„ç´€éŒ„");
            if (selDate > today) return alert("âŒ éŒ¯èª¤ï¼šä¸èƒ½è¼¸å…¥æœªä¾†æ—¥æœŸ");
            
            const detail = document.getElementById("rec-detail").value;
            actionStr = `${type}: ${detail}`;
        }

        const timestamp = Math.floor(new Date(dateVal).getTime() / 1000);
        
        try {
            await contract.methods.addHistory(id, dateVal, actionStr, noteRaw, phi, timestamp).send({ from: userAccount });
            
            let msg = "âœ… ç´€éŒ„å·²ä¸Šéˆï¼";
            if (phi > 0) msg += `\nâš ï¸ ä¾æ“š PHI è¦å®šï¼Œæ­¤ç”¢å“å°‡é–å®š ${phi} å¤©ç¦æ­¢æ¡æ”¶ã€‚`;
            alert(msg);
            
            document.getElementById("rec-detail").value = "";
            document.getElementById("pest-name").value = "";
            document.getElementById("rec-note").value = "";
        } catch (err) { alert("äº¤æ˜“å¤±æ•—: " + err.message); }
    }


    async function checkStatus() {
        if (!await checkConnection()) return;
        const id = document.getElementById("query-id").value.trim();
        if(!id) return alert("è«‹è¼¸å…¥ ID");
        
        try {
            const p = await contract.methods.getProduct(id).call();
            if(!p[0]) throw new Error("æŸ¥ç„¡æ­¤ IDï¼Œè«‹ç¢ºèªæ˜¯å¦å·²è¨»å†Šã€‚");
            
            const resultBox = document.getElementById("status-result");
            resultBox.style.display = "block";
            
            const unlockTime = parseInt(p[4]);
            const now = Math.floor(Date.now() / 1000);
            
            let statusHtml = "";
            if (unlockTime > now) {
                const waitDays = ((unlockTime - now) / 86400).toFixed(1);
                statusHtml = `<div style="padding:10px; background:#ffebee; border-left:5px solid #c62828; margin-top:10px;">
                    <div style="color:#d32f2f; font-weight:bold;">â›” è—¥æª¢ç®¡åˆ¶é–å®šä¸­</div>
                    <div style="color:#c62828;">å°šéœ€ç­‰å¾… ${waitDays} å¤©æ‰å¯æ¡æ”¶ã€‚</div>
                </div>`;
            } else {
                statusHtml = `<div style="padding:10px; background:#e8f5e9; border-left:5px solid #2e7d32; margin-top:10px;">
                    <div style="color:#2e7d32; font-weight:bold;">âœ… å®‰å…¨æœŸå·²éï¼Œå¯æ­£å¸¸å‡ºè²¨</div>
                </div>`;
            }
            
            resultBox.innerHTML = `<h3>${p[0]}</h3>
                                   <p><b>ç”¢åœ°ï¼š</b>${p[1]} <br> <b>è¾²å¤«ï¼š</b>${p[2]}</p>
                                   ${statusHtml}`;
        } catch (err) { 
            console.error(err); 
            alert("æŸ¥è©¢å¤±æ•—ï¼š" + err.message); 
        }
    }
</script>
</body>
</html>
