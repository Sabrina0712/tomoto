<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©æµæ›´æ–°ç³»çµ± (V3)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; padding: 20px; background: #e3f2fd; }
        .container { max-width: 600px; margin: 30px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        h2 { text-align: center; color: #1565c0; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; }
        button { width: 100%; padding: 15px; background: #1565c0; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 18px; }
        button:hover { background: #0d47a1; }
        #status { margin-top: 20px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h2>ğŸšš ç‰©æµç‹€æ…‹æ›´æ–°</h2>
        
        <div class="form-group">
            <label>ç”¢å“ ID</label>
            <input type="text" id="p-id" placeholder="ä¾‹å¦‚: P001">
        </div>

        <div class="form-group">
            <label>é‹è¼¸æ¥­è€…åç¨± (å…¬å¸å)</label>
            <input type="text" id="l-company" placeholder="ä¾‹å¦‚: é †é¢¨é€Ÿé‹">
        </div>

        <div class="form-group">
            <label>æ›´æ–°æ—¥æœŸ</label>
            <input type="date" id="l-date">
        </div>

        <div class="form-group">
            <label>ç‰©æµç‹€æ…‹</label>
            <select id="l-action">
                <option value="ç‰©æµï¼šå·²æ”¶è²¨">ğŸ“¦ å·²æ”¶è²¨</option>
                <option value="ç‰©æµï¼šé‹é€ä¸­">ğŸšš é‹é€ä¸­</option>
                <option value="ç‰©æµï¼šé›†è²¨ä¸­å¿ƒ">ğŸ­ é›†è²¨ä¸­å¿ƒ</option>
                <option value="ç‰©æµï¼šå·²é€é”">âœ… å·²é€é”</option>
            </select>
        </div>

        <div class="form-group">
            <label>å‚™è¨» / æº«åº¦</label>
            <input type="text" id="l-note" placeholder="ä¾‹å¦‚: è»Šè™Ÿ 888-TG (æº«åº¦ 18Â°C)">
        </div>

        <button onclick="updateLogistics()">ä¸Šå‚³ç‰©æµè³‡è¨Š</button>
        <div id="status"></div>
    </div>

    <script>
        // ğŸ”¥ V3 æ–°åˆç´„åœ°å€
        const contractAddress = "0x3984025D6BfaecC4bFDFb9B3b3889427f4764F4D";
        
        const contractABI = [
            { "inputs": [ { "internalType": "string", "name": "_id", "type": "string" }, { "internalType": "string", "name": "_date", "type": "string" }, { "internalType": "string", "name": "_transporter", "type": "string" }, { "internalType": "string", "name": "_action", "type": "string" }, { "internalType": "string", "name": "_note", "type": "string" }, { "internalType": "uint256", "name": "_phi", "type": "uint256" }, { "internalType": "uint256", "name": "_manualTimestamp", "type": "uint256" } ], "name": "addHistory", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
        ];

        let web3, contract, userAccount;

        window.onload = async function() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(contractABI, contractAddress);
                document.getElementById('l-date').value = new Date().toISOString().split('T')[0];
                
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    userAccount = accounts[0];
                    document.getElementById('status').innerHTML = "<span style='color:green'>ğŸŸ¢ å·²é€£ç·šéŒ¢åŒ…</span>";
                } catch (e) {
                    document.getElementById('status').innerText = "ğŸ”´ é€£ç·šè¢«æ‹’çµ•";
                }
            } else { alert("è«‹å®‰è£ MetaMask"); }
        };

        async function updateLogistics() {
            const id = document.getElementById('p-id').value;
            const company = document.getElementById('l-company').value;
            const date = document.getElementById('l-date').value;
            const action = document.getElementById('l-action').value;
            const note = document.getElementById('l-note').value;

            if (!id || !company) return alert("è³‡æ–™ä¸å®Œæ•´");

            const timestamp = Math.floor(new Date(date).getTime() / 1000);

            try {
                document.getElementById('status').innerText = "â³ ä¸Šå‚³ä¸­...";
                // ç‰©æµç«¯ä¸éœ€è¦ phi (è¨­ç‚º0)
                await contract.methods.addHistory(id, date, company, action, note, 0, timestamp).send({ from: userAccount });
                document.getElementById('status').innerText = "âœ… ä¸Šå‚³æˆåŠŸï¼";
                alert("ç‰©æµè³‡è¨Šå·²ä¸Šéˆ");
            } catch (error) {
                console.error(error);
                document.getElementById('status').innerText = "âŒ å¤±æ•—ï¼š" + error.message;
            }
        }
    </script>
</body>
</html>
