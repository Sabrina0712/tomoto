<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©æµç‹€æ…‹æ›´æ–° - AgriTrace V6</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            alert("âš ï¸ ç¶²é ç™¼ç”ŸéŒ¯èª¤ï¼š\n" + message + "\nè¡Œæ•¸ï¼š" + lineno);
        };
    </script>

    <style>
        /* å…¨åŸŸè¨­å®š */
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #e3f2fd; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 30px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-top: 8px solid #1976d2; }
        
        /* æ¨™é¡Œèˆ‡åœ–ç¤º */
        .icon-header { font-size: 3em; display: block; text-align: center; margin-bottom: 10px; }
        h1 { text-align: center; color: #1565c0; margin-bottom: 30px; font-weight: bold; }

        /* è¡¨å–®å€åŸŸ */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        input, select { 
            width: 100%; padding: 12px; border: 2px solid #ddd; 
            border-radius: 8px; font-size: 16px; box-sizing: border-box; 
            background: #fafafa; transition: 0.3s;
        }
        input:focus, select:focus { border-color: #2196f3; outline: none; background: #fff; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-submit { 
            width: 100%; padding: 15px; background: #1976d2; color: white; 
            border: none; border-radius: 50px; cursor: pointer; 
            font-size: 1.2em; font-weight: bold; margin-top: 10px;
            box-shadow: 0 4px 10px rgba(25, 118, 210, 0.3); transition: 0.2s;
        }
        .btn-submit:hover { background: #1565c0; transform: translateY(-2px); }
        .btn-submit:disabled { background: #b0bec5; cursor: not-allowed; transform: none; box-shadow: none; }

        /* è¨Šæ¯æ¡†æ¨£å¼ */
        .status-box { margin-top: 25px; padding: 15px; border-radius: 8px; display: none; text-align: center; font-weight: bold; line-height: 1.6; word-break: break-all;}
        .error { background: #ffebee; color: #c62828; border: 2px solid #ef5350; }
        .success { background: #e8f5e9; color: #2e7d32; border: 2px solid #4caf50; }
        
        /* è¼‰å…¥å‹•ç•« */
        .loading { color: #1976d2; font-weight: bold; display: none; text-align: center; margin-top: 20px;}
        
        /* è¿”å›é€£çµ */
        .nav-links { text-align: center; margin-top: 25px; }
        .nav-links a { text-decoration: none; color: #78909c; font-size: 0.9em; }
        .nav-links a:hover { color: #1976d2; }
    </style>
</head>
<body>

<div class="container">
    <span class="icon-header">ğŸšš</span>
    <h1>ç‰©æµç‹€æ…‹æ›´æ–° (V6)</h1>
    
    <div class="form-group">
        <label>ğŸ“¦ ç”¢å“ ID (Product ID)</label>
        <input type="text" id="log-id" placeholder="è«‹è¼¸å…¥æ‰¹è™Ÿ (ä¾‹å¦‚ï¼šP005)">
    </div>

    <div class="form-group">
        <label>ğŸ“… æ›´æ–°æ—¥æœŸ</label>
        <input type="date" id="log-date">
    </div>

    <div class="form-group">
        <label>ğŸ”„ ç•¶å‰ç‹€æ…‹</label>
        <select id="log-status">
            <option value="ç‰©æµæ”¶ä»¶: æº–å‚™é‹é€">ğŸ“¦ ç‰©æµæ”¶ä»¶ (Picked Up)</option>
            <option value="é‹é€ä¸­: å‰å¾€é›†è²¨ä¸­å¿ƒ">ğŸš› é‹é€ä¸­ (In Transit)</option>
            <option value="å·²é€é”: é–€å¸‚ç°½æ”¶">âœ… å·²é€é” (Delivered)</option>
            <option value="é€€è²¨: ç”¢å“æå£">â†©ï¸ é€€è²¨è™•ç† (Returned)</option>
        </select>
    </div>

    <div class="form-group">
        <label>ğŸ“ å‚™è¨» (è»Šè™Ÿ/æº«åº¦/å–®è™Ÿ)</label>
        <input type="text" id="log-note" placeholder="ä¾‹å¦‚ï¼šè»Šè™Ÿ ABC-1234, å†·è— 4Â°C">
    </div>

    <button class="btn-submit" onclick="submitLogistics()" id="submitBtn">ç¢ºèªæ›´æ–°ä¸Šéˆ</button>
    
    <div id="loading-msg" class="loading">
        <div style="font-size: 20px;">â³</div>
        æ­£åœ¨é€£æ¥å€å¡Šéˆ...<br>è«‹ç•™æ„ MetaMask æ˜¯å¦æœ‰è·³å‡ºè¦–çª—
    </div>
    
    <div id="msg-box" class="status-box"></div>

    <div class="nav-links">
        <a href="index.html">â† å›åˆ°é¦–é </a>
    </div>
</div>

<script>
    // === 0. åŸºç¤è¨­å®š ===
    console.log("ğŸš€ ç‰©æµé é¢é‡æ–°è¼‰å…¥æˆåŠŸ");
    document.getElementById('log-date').valueAsDate = new Date();

    // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
    // é—œéµï¼šè«‹å¡«å…¥èˆ‡ Farmer é é¢ç›¸åŒçš„ V6 åˆç´„åœ°å€
    const contractAddress = "0x786b118e72075f6a3b7d5E7Db8C6F78933494298"; 
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
    
    // V6 çš„ ABI (æ³¨æ„ï¼šé€™è£¡å¿…é ˆç”¨ addHistoryï¼Œå› ç‚º V6 æ²’æœ‰ addRecord äº†)
    const contractABI = [
        {"inputs":[{"internalType":"string","name":"_id","type":"string"},{"internalType":"string","name":"_name","type":"string"},{"internalType":"string","name":"_location","type":"string"},{"internalType":"string","name":"_farmer","type":"string"},{"internalType":"string","name":"_photoUrl","type":"string"}],"name":"registerProduct","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"string","name":"_id","type":"string"},{"internalType":"string","name":"_date","type":"string"},{"internalType":"string","name":"_action","type":"string"},{"internalType":"string","name":"_note","type":"string"},{"internalType":"uint256","name":"_phi","type":"uint256"},{"internalType":"uint256","name":"_dateTimestamp","type":"uint256"}],"name":"addHistory","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"getProduct","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    let web3;
    let contract;

    // === 1. é€£æ¥éŒ¢åŒ… ===
    async function initWeb3() {
        if (typeof window.ethereum !== 'undefined') {
            web3 = new Web3(window.ethereum);
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                console.log("å·²é€£æ¥å¸³æˆ¶:", accounts[0]);
                contract = new web3.eth.Contract(contractABI, contractAddress);
                return true;
            } catch (error) {
                console.error(error);
                alert("âŒ MetaMask é€£æ¥å¤±æ•—: " + error.message);
                return false;
            }
        } else {
            alert("âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° MetaMask");
            return false;
        }
    }

    // === 2. é¡¯ç¤ºè¨Šæ¯å·¥å…· ===
    function showMsg(text, type) {
        const box = document.getElementById('msg-box');
        if (type === 'none') {
            box.style.display = 'none';
        } else {
            box.style.display = 'block';
            box.innerHTML = text;
            box.className = "status-box " + type;
        }
    }

    // === 3. ä¸»æµç¨‹ï¼šæäº¤æŒ‰éˆ• ===
    async function submitLogistics() {
        const id = document.getElementById('log-id').value.trim();
        const dateStr = document.getElementById('log-date').value;
        const status = document.getElementById('log-status').value;
        const note = document.getElementById('log-note').value;

        if (!id) return alert("âš ï¸ è«‹è¼¸å…¥ç”¢å“ ID");

        // ğŸ”¥ é—œéµä¿®æ”¹ 1ï¼šè¨ˆç®—æ—¥æœŸçš„ç§’æ•¸ (Timestamp)
        const dateObj = new Date(dateStr);
        const dateTimestamp = Math.floor(dateObj.getTime() / 1000);

        // é–å®šç•«é¢
        const btn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading-msg');
        btn.disabled = true;
        loading.style.display = 'block';
        showMsg("", "none");

        try {
            // A. é€£æ¥éŒ¢åŒ…
            const connected = await initWeb3();
            if (!connected) throw new Error("éŒ¢åŒ…é€£æ¥å¤±æ•—");

            // B. æª¢æŸ¥è—¥æª¢ç‹€æ…‹
            console.log("æ­£åœ¨æª¢æŸ¥ ID:", id);
            let productData;
            try {
                productData = await contract.methods.getProduct(id).call();
            } catch (e) {
                throw new Error("ç„¡æ³•è®€å–è³‡æ–™ï¼Œè«‹ç¢ºèªåˆç´„åœ°å€æ­£ç¢ºä¸” ID å­˜åœ¨ã€‚");
            }

            if (!productData[0]) throw new Error("æŸ¥ç„¡æ­¤ ID");

            const unlockTime = parseInt(productData[4]); 
            const now = Math.floor(Date.now() / 1000);

            // é€™è£¡çš„é‚è¼¯æ˜¯ï¼šå¦‚æœè—¥æª¢é–å®šä¸­ï¼Œç‰©æµä¸èƒ½å‡ºè²¨
            if (now < unlockTime) {
                const waitDays = ((unlockTime - now) / 86400).toFixed(1);
                throw new Error(`â›” ç¦æ­¢å‡ºè²¨ï¼(è—¥æª¢ç®¡åˆ¶ä¸­)\né‚„éœ€ç­‰å¾… ${waitDays} å¤©`);
            }

            // C. é€å‡ºäº¤æ˜“
            const accounts = await web3.eth.getAccounts();
            console.log("æº–å‚™é€å‡º:", id, dateStr, status, note, 0, dateTimestamp);
            
            // ğŸ”¥ é—œéµä¿®æ”¹ 2ï¼šæ”¹ç”¨ addHistoryï¼Œä¸¦è£œä¸Š PHI=0 å’Œ Timestamp
            await contract.methods.addHistory(id, dateStr, status, note, 0, dateTimestamp)
                .send({ from: accounts[0] })
                .on('transactionHash', function(hash){
                    loading.innerHTML = "äº¤æ˜“æ‰“åŒ…ä¸­...<br>Hash: " + hash.substring(0,10) + "...";
                });

            // D. æˆåŠŸ
            showMsg(`âœ… æˆåŠŸï¼ç‰©æµç‹€æ…‹å·²æ›´æ–°ï¼š<br>${status}`, "success");
            document.getElementById('log-note').value = ""; 

        } catch (err) {
            console.error("éŒ¯èª¤:", err);
            let errorText = err.message;
            if (err.message.includes("User denied")) errorText = "æ‚¨å–æ¶ˆäº†äº¤æ˜“";
            
            showMsg("âŒ " + errorText, "error");
            alert("ç™¼ç”ŸéŒ¯èª¤:\n" + errorText);
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
        }
    }
</script>

</body>
</html>