<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©æµç‹€æ…‹æ›´æ–°ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: #eef2f5; 
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh;
        }
        
        .main-card {
            background: white;
            width: 100%;
            max-width: 600px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.08);
            padding: 40px;
            position: relative;
            margin-top: 20px;
        }

        /* æ¨™é¡Œå€ */
        .header { text-align: center; margin-bottom: 30px; }
        .header h2 { margin: 0; color: #1565c0; font-size: 1.8rem; }
        .header p { color: #888; margin-top: 5px; font-size: 0.9rem; }
        .icon-circle {
            width: 60px; height: 60px; background: #e3f2fd; color: #1565c0;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; margin: 0 auto 15px auto;
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #444; font-size: 0.95rem; }
        
        /* è¼¸å…¥æ¡†ç¾åŒ– */
        .input-wrapper { position: relative; }
        .input-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; }
        
        input, select { 
            width: 100%; padding: 12px 12px 12px 40px; /* ç•™ä½ç½®çµ¦ icon */
            border: 2px solid #e0e0e0; border-radius: 10px; 
            font-size: 1rem; box-sizing: border-box; transition: 0.3s;
            font-family: inherit;
        }
        input:focus, select:focus { border-color: #1565c0; outline: none; background: #fdfdfd; }
        
        /* æŒ‰éˆ•ç¾åŒ– */
        button.submit-btn { 
            width: 100%; padding: 15px; background: linear-gradient(90deg, #1565c0, #0d47a1); 
            color: white; border: none; border-radius: 10px; cursor: pointer; 
            font-size: 1.1rem; font-weight: bold; margin-top: 10px;
            box-shadow: 0 5px 15px rgba(21, 101, 192, 0.3); transition: 0.3s;
        }
        button.submit-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(21, 101, 192, 0.4); }

        /* ç‹€æ…‹åˆ— */
        .status-bar {
            position: absolute; top: -15px; right: 20px;
            background: #ffebee; color: #c62828; padding: 6px 15px;
            border-radius: 20px; font-size: 0.85rem; font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 5px;
        }
        .status-bar.connected { background: #e8f5e9; color: #2e7d32; }

        /* å…©æ¬„æ’ç‰ˆ (æ—¥æœŸèˆ‡ç‹€æ…‹) */
        .row { display: flex; gap: 15px; }
        .col { flex: 1; }
    </style>
</head>
<body>

    <div class="main-card">
        <div id="wallet-status" class="status-bar">
            <i class="fas fa-circle" style="font-size:8px;"></i> å°šæœªé€£ç·š
        </div>

        <div class="header">
            <div class="icon-circle"><i class="fas fa-shipping-fast"></i></div>
            <h2>ç‰©æµç‹€æ…‹æ›´æ–°</h2>
            <p>è«‹è¼¸å…¥ç”¢å“é‹é€çš„æœ€æ–°ç¯€é»è³‡è¨Š</p>
        </div>
        
        <div class="form-group">
            <label>ğŸ“¦ ç”¢å“ ID</label>
            <div class="input-wrapper">
                <i class="fas fa-barcode"></i>
                <input type="text" id="p-id" placeholder="ä¾‹å¦‚: P001">
            </div>
        </div>

        <div class="form-group">
            <label>ğŸ¢ é‹è¼¸æ¥­è€…åç¨±</label>
            <div class="input-wrapper">
                <i class="fas fa-building"></i>
                <input type="text" id="l-company" placeholder="ä¾‹å¦‚: é †é¢¨é€Ÿé‹">
            </div>
        </div>

        <div class="row">
            <div class="col form-group">
                <label>ğŸ“… æ›´æ–°æ—¥æœŸ</label>
                <div class="input-wrapper">
                    <i class="fas fa-calendar-alt"></i>
                    <input type="date" id="l-date">
                </div>
            </div>
            <div class="col form-group">
                <label>ğŸ“ ç‰©æµç‹€æ…‹</label>
                <div class="input-wrapper">
                    <i class="fas fa-map-marker-alt"></i>
                    <select id="l-action">
                        <option value="ç‰©æµï¼šå·²æ”¶è²¨">ğŸ“¦ å·²æ”¶è²¨</option>
                        <option value="ç‰©æµï¼šé‹é€ä¸­">ğŸšš é‹é€ä¸­</option>
                        <option value="ç‰©æµï¼šé›†è²¨ä¸­å¿ƒ">ğŸ­ é›†è²¨ä¸­å¿ƒ</option>
                        <option value="ç‰©æµï¼šå·²é€é”">âœ… å·²é€é”</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>ğŸ“ å‚™è¨» / æº«åº¦ç›£æ§</label>
            <div class="input-wrapper">
                <i class="fas fa-thermometer-half"></i>
                <input type="text" id="l-note" placeholder="ä¾‹å¦‚: è»Šè™Ÿ 888-TG (æº«åº¦ 18Â°C)">
            </div>
        </div>

        <button class="submit-btn" onclick="updateLogistics()">
            <i class="fas fa-cloud-upload-alt"></i> ä¸Šå‚³ç‰©æµè³‡è¨Š
        </button>
    </div>

    <script>
        // âš ï¸ åˆç´„åœ°å€ (V3)
        const contractAddress = "0x305255Adb4F3797F75F1e0a58fC622cF784Ea599";
        
        const contractABI = [
            { "inputs": [ { "internalType": "string", "name": "_id", "type": "string" }, { "internalType": "string", "name": "_date", "type": "string" }, { "internalType": "string", "name": "_transporter", "type": "string" }, { "internalType": "string", "name": "_action", "type": "string" }, { "internalType": "string", "name": "_note", "type": "string" }, { "internalType": "uint256", "name": "_phi", "type": "uint256" }, { "internalType": "uint256", "name": "_manualTimestamp", "type": "uint256" } ], "name": "addHistory", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
        ];

        let web3, contract, userAccount;

        window.onload = async function() {
            document.getElementById('l-date').value = new Date().toISOString().split('T')[0];
            
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(contractABI, contractAddress);
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    userAccount = accounts[0];
                    updateStatus(true);
                } catch (e) {
                    updateStatus(false);
                }
            } else { alert("è«‹å®‰è£ MetaMask"); }
        };

        function updateStatus(isConnected) {
            const el = document.getElementById('wallet-status');
            if(isConnected) {
                el.innerHTML = `<i class="fas fa-circle" style="font-size:8px;"></i> å·²é€£ç·š: ${userAccount.substring(0,6)}...`;
                el.classList.add('connected');
            } else {
                el.innerText = "å°šæœªé€£ç·š / æ‹’çµ•å­˜å–";
                el.classList.remove('connected');
            }
        }

        async function updateLogistics() {
            const id = document.getElementById('p-id').value;
            const company = document.getElementById('l-company').value;
            const date = document.getElementById('l-date').value;
            const action = document.getElementById('l-action').value;
            const note = document.getElementById('l-note').value;

            if (!id || !company) return alert("è³‡æ–™ä¸å®Œæ•´");

            const timestamp = Math.floor(new Date(date).getTime() / 1000);
            const btn = document.querySelector('.submit-btn');

            try {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¸Šå‚³ä¸­...';
                btn.style.background = '#888';
                
                // ç‰©æµç«¯ä¸éœ€è¦ phi (è¨­ç‚º0)
                await contract.methods.addHistory(id, date, company, action, note, 0, timestamp).send({ from: userAccount });
                
                alert("âœ… ç‰©æµè³‡è¨Šå·²æˆåŠŸå¯«å…¥å€å¡Šéˆï¼");
                // é‡ç½®æŒ‰éˆ•
                btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> ä¸Šå‚³ç‰©æµè³‡è¨Š';
                btn.style.background = 'linear-gradient(90deg, #1565c0, #0d47a1)';
            } catch (error) {
                console.error(error);
                alert("âŒ å¤±æ•—ï¼š" + error.message);
                btn.innerHTML = 'é‡è©¦ä¸Šå‚³';
            }
        }
    </script>
</body>
</html>