<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©æµç‹€æ…‹æ›´æ–°ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #e3f2fd; } /* è—è‰²èƒŒæ™¯ä»£è¡¨ç‰©æµ */
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #1565c0; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
        
        button { width: 100%; padding: 12px; background: #1565c0; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; }
        button:hover { background: #0d47a1; }

        .status-msg { margin-top: 20px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h2>ğŸšš ç‰©æµç‹€æ…‹æ›´æ–°</h2>
        
        <div class="form-group">
            <label>ç”¢å“ ID </label>
            <input type="text" id="p-id" placeholder="ä¾‹å¦‚: P003">
        </div>

        <div class="form-group">
            <label>æ›´æ–°æ—¥æœŸ</label>
            <input type="date" id="l-date">
        </div>

        <div class="form-group">
            <label>ç‰©æµç‹€æ…‹ (Action)</label>
            <select id="l-action">
                <option value="ç‰©æµï¼šå·²æ”¶è²¨ (In Transit)">ğŸ“¦ ç‰©æµï¼šå·²æ”¶è²¨</option>
                <option value="ç‰©æµï¼šé‹é€ä¸­ (Shipping)">ğŸšš ç‰©æµï¼šé‹é€ä¸­</option>
                <option value="ç‰©æµï¼šé›†è²¨ä¸­å¿ƒåˆ†ç† (Sorting)">ğŸ­ ç‰©æµï¼šé›†è²¨ä¸­å¿ƒ</option>
                <option value="ç‰©æµï¼šå·²é€é” (Arrived)">âœ… ç‰©æµï¼šå·²é€é”</option>
            </select>
        </div>

        <div class="form-group">
            <label>å‚™è¨» (è»Šè™Ÿ / æº«åº¦ / ç¶“æ‰‹äºº)</label>
            <input type="text" id="l-note" placeholder="ä¾‹å¦‚: å†·è—è»Š 888-TG, æº«åº¦4åº¦C">
        </div>

        <button onclick="updateLogistics()">ä¸Šå‚³ç‰©æµè³‡è¨Š</button>
        <div id="status" class="status-msg"></div>
    </div>

    <script>
        const contractAddress = "0x0136f45A37d68630e2C33Bd228C61F20b23a27a5";
        
        const contractABI = [
            { "inputs": [ { "internalType": "string", "name": "_id", "type": "string" }, { "internalType": "string", "name": "_date", "type": "string" }, { "internalType": "string", "name": "_action", "type": "string" }, { "internalType": "string", "name": "_note", "type": "string" } ], "name": "addHistory", "outputs": [], "stateMutability": "nonpayable", "type": "function" }
        ];

        let web3, contract, userAccount;

        window.onload = async function() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(contractABI, contractAddress);
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('l-date').value = today;

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];
            } else {
                alert("è«‹å®‰è£ MetaMaskï¼");
            }
        };

        async function updateLogistics() {
            const id = document.getElementById('p-id').value.trim();
            const date = document.getElementById('l-date').value;
            const action = document.getElementById('l-action').value;
            const note = document.getElementById('l-note').value;
            const statusDiv = document.getElementById('status');

            if (!id) return alert("è«‹è¼¸å…¥ç”¢å“ ID");

            statusDiv.innerHTML = "â³ ç­‰å¾… MetaMask ç¢ºèªä¸­...";
            statusDiv.style.color = "blue";

            try {
                await contract.methods.addHistory(id, date, action, note)
                    .send({ from: userAccount });

                statusDiv.innerHTML = "âœ… ç‰©æµè³‡è¨Šæ›´æ–°æˆåŠŸï¼";
                statusDiv.style.color = "green";
                

                document.getElementById('l-note').value = ""; 

            } catch (error) {
                console.error(error);
                if (error.message.includes("Product ID not found")) {
                    statusDiv.innerHTML = "âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æ­¤ç”¢å“ IDï¼Œè«‹ç¢ºèªè¾²å¤«æ˜¯å¦å·²å»ºç«‹è³‡æ–™ã€‚";
                } else {
                    statusDiv.innerHTML = "âŒ æ›´æ–°å¤±æ•—ï¼š" + error.message;
                }
                statusDiv.style.color = "red";
            }
        }
    </script>
</body>
</html>
