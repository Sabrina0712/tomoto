<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¢å“å±¥æ­·æŸ¥è©¢ - AgriTrace</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* ä¸ŠåŠéƒ¨ï¼šæœå°‹å€ (ç¶­æŒåŸæ¨£) */
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        .search-box { display: flex; gap: 10px; margin-bottom: 30px; }
        input { flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 50px; font-size: 16px; outline: none; transition: 0.3s; }
        input:focus { border-color: #3498db; }
        button { padding: 15px 30px; background: #3498db; color: white; border: none; border-radius: 50px; font-size: 16px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: #2980b9; transform: scale(1.05); }

        /* ä¸‹åŠéƒ¨ï¼šè³‡æ–™é¡¯ç¤ºå€ (å¹«ä½ æ”¹æˆå‹•æ…‹è®€å–) */
        #result-area { display: none; animation: fadeIn 0.5s; }
        
        .product-card { text-align: center; margin-bottom: 25px; }
        .product-img { width: 100%; max-height: 300px; object-fit: cover; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .info-group { text-align: left; padding: 15px; background: #f8f9fa; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid #bdc3c7; }
        .info-label { color: #7f8c8d; font-size: 0.9em; margin-bottom: 5px; }
        .info-value { color: #2c3e50; font-weight: bold; font-size: 1.1em; }

        /* ç‰©æµèˆ‡ç‹€æ…‹å°ˆç”¨æ¨£å¼ */
        .status-card { 
            background: #e3f2fd; 
            border: 2px solid #2196f3; 
            padding: 20px; 
            border-radius: 12px; 
            margin-top: 20px; 
            text-align: left;
        }
        .status-title { font-weight: bold; color: #1565c0; margin-bottom: 10px; display: flex; align-items: center; }
        .status-date { float: right; font-size: 0.8em; color: #555; background: white; padding: 2px 8px; border-radius: 10px; }
        
        /* è—¥æª¢è­¦ç¤º */
        .safe-badge { background: #d4edda; color: #155724; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; margin-top: 20px; }
        .warning-badge { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; margin-top: 20px; border: 2px solid #f5c6cb; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ” ç”¢éŠ·å±¥æ­·æŸ¥è©¢</h1>
    
    <div class="search-box">
        <input type="text" id="search-id" placeholder="è«‹è¼¸å…¥ç”¢å“ ID (ä¾‹å¦‚ P005)">
        <button onclick="searchProduct()">æŸ¥è©¢</button>
    </div>

    <div id="result-area">
        <div class="product-card">
            <img id="d-photo" class="product-img" src="" onerror="this.style.display='none'">
            <h2 id="d-name" style="margin: 10px 0;"></h2>
        </div>

        <div class="info-group" style="border-left-color: #2ecc71;">
            <div class="info-label">ğŸ‘¨â€ğŸŒ¾ ç”Ÿç”¢è€… (Farmer)</div>
            <div id="d-farmer" class="info-value"></div>
        </div>

        <div class="info-group" style="border-left-color: #f1c40f;">
            <div class="info-label">ğŸ“ç”¢åœ° (Location)</div>
            <div id="d-location" class="info-value"></div>
        </div>

        <div class="status-card">
            <div class="status-title">
                ğŸ“¢ æœ€æ–°ç‹€æ…‹ / ç‰©æµè³‡è¨Š
                <span id="d-date" class="status-date"></span>
            </div>
            <div id="d-action" style="font-size: 1.2em; font-weight: bold; color: #333;"></div>
            <div id="d-note" style="margin-top: 5px; color: #666; font-size: 0.95em;"></div>
        </div>

        <div id="safety-box"></div>
    </div>
</div>

<script>
    // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
    // é—œéµï¼šè«‹ç¢ºèªé€™è£¡ä¹Ÿæ˜¯å¡«å…¥ V6 çš„åˆç´„åœ°å€
    const contractAddress = "0x786b118e72075f6a3b7d5E7Db8C6F78933494298"; 
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    // V6 çš„ ABI
    const contractABI = [
        {"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"getProduct","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"}
    ];

    // åˆå§‹åŒ– Web3 (ä½¿ç”¨å…¬é–‹ç¯€é»ï¼Œè®“æ¶ˆè²»è€…ä¸ç”¨å®‰è£ MetaMask ä¹Ÿèƒ½çœ‹)
    // å¦‚æœé€™è£¡å ±éŒ¯ï¼Œå¯ä»¥æ”¹å› window.ethereum
    const web3 = new Web3(new Web3.providers.HttpProvider("https://sepolia.infura.io/v3/ä½ çš„INFURA_KEY")); 
    // âš ï¸ ç°¡å–®èµ·è¦‹ï¼Œæˆ‘å€‘ç›´æ¥ç”¨ä½¿ç”¨è€…ç€è¦½å™¨çš„ MetaMask (å¦‚æœæœ‰) æˆ–è€…ç›´æ¥å˜—è©¦é€£ç·š
    // ç‚ºäº†ç¢ºä¿ä½ èƒ½ç”¨ï¼Œæˆ‘å€‘å…ˆç”¨æœ€ç°¡å–®çš„ window.ethereum æ¨¡å¼
    
    async function searchProduct() {
        const id = document.getElementById('search-id').value.trim();
        if(!id) return alert("è«‹è¼¸å…¥ ID");

        // æª¢æŸ¥ä½¿ç”¨è€…æœ‰æ²’æœ‰ Web3 ç’°å¢ƒ
        let tempWeb3;
        if (window.ethereum) {
            tempWeb3 = new Web3(window.ethereum);
        } else {
            alert("âš ï¸ ç‚ºäº†è®€å–å€å¡Šéˆè³‡æ–™ï¼Œè«‹ä½¿ç”¨å®‰è£æœ‰ MetaMask çš„ç€è¦½å™¨ï¼Œæˆ–æ‰‹æ©ŸéŒ¢åŒ… App é–‹å•Ÿæ­¤é é¢ã€‚");
            return;
        }

        const contract = new tempWeb3.eth.Contract(contractABI, contractAddress);
        
        try {
            // è®€å–è³‡æ–™
            const p = await contract.methods.getProduct(id).call();
            
            // p[0]: Name, p[1]: Location, p[2]: Farmer, p[3]: Photo
            // p[4]: UnlockTime, p[5]: LastAction, p[6]: LastNote, p[7]: LastDate

            if (!p[0]) {
                alert("âŒ æŸ¥ç„¡æ­¤ç”¢å“ IDï¼Œè«‹ç¢ºèªæ˜¯å¦è¼¸å…¥æ­£ç¢ºã€‚");
                return;
            }

            // å¡«å…¥è³‡æ–™
            document.getElementById('result-area').style.display = 'block';
            
            document.getElementById('d-name').innerText = p[0];
            document.getElementById('d-farmer').innerText = p[2];
            document.getElementById('d-location').innerText = p[1];
            
            // åœ–ç‰‡è™•ç†
            const img = document.getElementById('d-photo');
            if(p[3] && (p[3].startsWith('http'))) {
                img.src = p[3];
                img.style.display = 'block';
            } else {
                img.style.display = 'none';
            }

            // ğŸ”¥ æ›´æ–°æœ€æ–°ç‹€æ…‹ (åŒ…å«ç‰©æµè³‡è¨Š)
            document.getElementById('d-action').innerText = p[5]; // å‹•ä½œ (ä¾‹å¦‚ï¼šç‰©æµæ”¶ä»¶)
            document.getElementById('d-note').innerText = p[6] ? "å‚™è¨»: " + p[6] : "";     // å‚™è¨»
            document.getElementById('d-date').innerText = p[7];   // æ—¥æœŸ

            // è—¥æª¢å®‰å…¨è¨ˆç®—
            const unlockTime = parseInt(p[4]);
            const now = Math.floor(Date.now() / 1000);
            const safetyBox = document.getElementById('safety-box');

            if (now < unlockTime) {
                const waitDays = ((unlockTime - now) / 86400).toFixed(1);
                safetyBox.innerHTML = `<div class="warning-badge">â›” æ­¤ç”¢å“å°šåœ¨è—¥æª¢å®‰å…¨æœŸå…§ (å‰©é¤˜ ${waitDays} å¤©) <br>è«‹å‹¿é£Ÿç”¨</div>`;
            } else {
                safetyBox.innerHTML = `<div class="safe-badge">âœ… è—¥æª¢åˆæ ¼ / å®‰å…¨å¯é£Ÿç”¨</div>`;
            }

        } catch (err) {
            console.error(err);
            alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªåˆç´„åœ°å€æ­£ç¢ºï¼Œæˆ–ç¶²è·¯é€£ç·šæ­£å¸¸ã€‚");
        }
    }
</script>

</body>
</html>

