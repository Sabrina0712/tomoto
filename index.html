<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥¬ ç”¢å“å±¥æ­·æŸ¥è©¢ - V6</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <style>
        /* === æ²¿ç”¨è¾²å¤«ç«¯çš„ç¶ è‰²é¢¨æ ¼ === */
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #f1f8e9; padding: 20px; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: #2e7d32; margin-bottom: 20px; }

        /* æŸ¥è©¢å€å¡Š */
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        input { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; outline: none; }
        input:focus { border-color: #4caf50; }
        
        button { padding: 12px 25px; background: #2e7d32; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        button:hover { background: #1b5e20; }

        /* çµæœé¡¯ç¤ºå€ */
        #result-area { display: none; animation: fadeIn 0.5s; }
        
        /* åœ–ç‰‡ */
        .product-img { width: 100%; max-height: 250px; object-fit: cover; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background-color: #f5f5f5; }

        /* è³‡æ–™æ¬„ä½æ¨£å¼ */
        .info-row { margin-bottom: 12px; font-size: 1.1em; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .label { color: #2e7d32; font-weight: bold; display: inline-block; width: 90px; }
        .value { color: #333; font-weight: 500; }

        /* æœ€æ–°ç‹€æ…‹å€å¡Š (ç‰©æµ/æ–½è—¥) */
        .status-card { 
            background: #e8f5e9; /* æ·ºç¶ åº•è‰² */
            border: 2px solid #4caf50; 
            padding: 15px; 
            border-radius: 8px; 
            margin-top: 20px; 
        }
        .status-header { font-weight: bold; color: #1b5e20; border-bottom: 1px solid #a5d6a7; padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        
        /* å®‰å…¨ç‹€æ…‹æ¨™ç±¤ */
        .badge { display: block; text-align: center; padding: 10px; border-radius: 50px; margin-top: 20px; font-weight: bold; color: white; }
        .badge-safe { background: #4caf50; }
        .badge-danger { background: #d32f2f; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ” ç”¢å“å±¥æ­·æŸ¥è©¢</h1>

    <div class="search-box">
        <input type="text" id="query-id" placeholder="è«‹è¼¸å…¥ç”¢å“ ID (ä¾‹å¦‚: P005)">
        <button onclick="searchProduct()">æŸ¥è©¢</button>
    </div>

    <div id="result-area">
        
        <img id="d-photo" class="product-img" src="" onerror="this.style.display='none'">

        <h2 id="d-name" style="text-align:center; color:#333; margin-top:0;"></h2>
        
        <div class="info-row">
            <span class="label">ğŸ‘¨â€ğŸŒ¾ ç”Ÿç”¢è€…:</span> 
            <span id="d-farmer" class="value"></span>
        </div>
        <div class="info-row">
            <span class="label">ğŸ“ ç”¢åœ°:</span> 
            <span id="d-location" class="value"></span>
        </div>

        <div class="status-card">
            <div class="status-header">
                <span>ğŸšš æœ€æ–°å‹•æ…‹ / ç‰©æµ</span>
                <span id="d-date" style="font-size:0.9em; opacity:0.8;"></span>
            </div>
            <div style="font-size: 1.2em; font-weight: bold; color: #2e7d32; margin-bottom: 5px;" id="d-action"></div>
            <div style="color: #555; font-size: 0.95em;" id="d-note"></div>
        </div>

        <div id="safety-badge" class="badge"></div>

    </div>
</div>

<script>
    // â–¼â–¼â–¼ åˆç´„åœ°å€ (V6) â–¼â–¼â–¼
    const contractAddress = "0x786b118e72075f6a3b7d5E7Db8C6F78933494298"; 
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    const contractABI = [
        {"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"getProduct","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"}
    ];

    async function searchProduct() {
        const id = document.getElementById("query-id").value.trim();
        if(!id) return alert("è«‹è¼¸å…¥ ID");

        if (typeof window.ethereum === 'undefined') {
            alert("è«‹ä½¿ç”¨å®‰è£æœ‰ MetaMask çš„ç€è¦½å™¨");
            return;
        }

        const web3 = new Web3(window.ethereum);
        const contract = new web3.eth.Contract(contractABI, contractAddress);

        try {
            // è®€å–å€å¡Šéˆè³‡æ–™
            const p = await contract.methods.getProduct(id).call();

            // å¦‚æœæ²’æœ‰åç¨±ï¼Œä»£è¡¨ ID ä¸å­˜åœ¨
            if (!p[0]) {
                alert("âŒ æŸ¥ç„¡æ­¤ ID è³‡æ–™");
                document.getElementById("result-area").style.display = "none";
                return;
            }

            // é¡¯ç¤ºçµæœå€
            document.getElementById("result-area").style.display = "block";

            // === A. å¡«å…¥è¾²å¤«åŸºæœ¬è³‡æ–™ ===
            document.getElementById("d-name").innerText = p[0];
            document.getElementById("d-farmer").innerText = p[2];
            document.getElementById("d-location").innerText = p[1];
            
            // åœ–ç‰‡è™•ç†
            const img = document.getElementById("d-photo");
            if(p[3] && p[3].startsWith("http")) {
                img.src = p[3];
                img.style.display = "block";
            } else {
                img.style.display = "none";
            }

            // === B. å¡«å…¥æœ€æ–°ç‹€æ…‹ (ç‰©æµ/å‹•ä½œ) ===
            // p[5]: å‹•ä½œåç¨± (ä¾‹å¦‚: "é‹é€ä¸­: å‰å¾€é›†è²¨ä¸­å¿ƒ")
            // p[6]: å‚™è¨» (ä¾‹å¦‚: "è»Šè™Ÿ ABC-1234")
            // p[7]: æ—¥æœŸ (ä¾‹å¦‚: "2023-10-27")
            document.getElementById("d-action").innerText = p[5]; 
            document.getElementById("d-note").innerText = p[6] ? "å‚™è¨»: " + p[6] : "ç„¡å‚™è¨»";
            document.getElementById("d-date").innerText = p[7];

            // === C. è—¥æª¢å®‰å…¨è¨ˆç®— ===
            const unlockTime = parseInt(p[4]);
            const now = Math.floor(Date.now() / 1000);
            const badge = document.getElementById("safety-badge");

            if (now < unlockTime) {
                const waitDays = ((unlockTime - now) / 86400).toFixed(1);
                badge.className = "badge badge-danger";
                badge.innerHTML = `â›” è—¥æª¢ç®¡åˆ¶ä¸­ (é‚„éœ€ ${waitDays} å¤©)`;
            } else {
                badge.className = "badge badge-safe";
                badge.innerHTML = `âœ… å®‰å…¨å¯é£Ÿç”¨ / å…è¨±å‡ºè²¨`;
            }

        } catch (err) {
            console.error(err);
            alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª ID æ˜¯å¦æ­£ç¢º");
        }
    }
</script>

</body>
</html>
