<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¢å“å±¥æ­·æŸ¥è©¢ç³»çµ± </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #f0f2f5; padding: 20px; color:#333; }
        .container { max-width: 800px; margin: 0 auto; }
        
        .search-box { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; margin-bottom: 20px; }
        .input-group { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
        input { width: 60%; padding: 12px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 25px; outline: none; padding-left: 20px; }
        input:focus { border-color: #2e7d32; }
        button.search-btn { padding: 12px 25px; font-size: 16px; background: #2e7d32; color: white; border: none; border-radius: 25px; cursor: pointer; }
        button.search-btn:hover { background: #1b5e20; }
        
        .toggle-btns { margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; }
        .t-btn { background: #ddd; color: #555; padding: 8px 16px; border-radius: 20px; cursor: pointer; border:none; }
        .t-btn.active { background: #1565c0; color: white; transform: scale(1.05); }

        /* å…¬å¸ç°¡ä»‹å¡ç‰‡ */
        .company-profile-card { background: #e3f2fd; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #bbdefb; display: flex; gap: 15px; align-items: start; animation: fadeIn 0.5s; }
        .cp-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; background: white; border: 2px solid white; }
        
        /* ç”¢å“çµæœå¡ç‰‡ */
        .result-card { background: white; border-radius: 12px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); animation: fadeIn 0.5s; }
        .card-header { background: #2e7d32; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 20px; display: flex; gap: 20px; flex-wrap: wrap; }
        .product-img { width: 120px; height: 120px; object-fit: cover; border-radius: 10px; background: #eee; }
        .timeline { padding: 0 20px 20px 20px; margin-top: 10px; border-top: 1px dashed #eee; padding-top: 15px; }
        .t-item { border-left: 2px solid #ddd; padding-left: 20px; position: relative; padding-bottom: 20px; }
        .t-item::before { content: ''; width: 12px; height: 12px; background: #2e7d32; border-radius: 50%; position: absolute; left: -7px; top: 0; }
        .t-date { font-size: 0.85em; color: #888; margin-bottom: 5px; font-weight: bold; }
        .t-action { font-weight: bold; color: #333; font-size: 1.1em; }
        .t-detail { margin-top: 5px; font-size: 0.95em; color: #666; background: #f9f9f9; padding: 10px; border-radius: 6px; }

        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="toggle-btns">
        <button class="t-btn active" onclick="setMode('company')">ğŸ¢ ä¾å…¬å¸æŸ¥è©¢</button>
        <button class="t-btn" onclick="setMode('id')">ğŸ” ä¾ ID æŸ¥è©¢</button>
    </div>

    <div class="search-box">
        <h2 id="search-title">æŸ¥è©¢å…¬å¸ç”¢å“</h2>
        <div class="input-group">
            <input type="text" id="query-input" placeholder="ä¾‹å¦‚: å¿«æ¨‚è¾²å ´">
            <button class="search-btn" onclick="handleSearch()">æŸ¥è©¢</button>
        </div>
        <div id="loading" style="display:none; color:#666; margin-top:15px;"><i class="fas fa-spinner fa-spin"></i> è³‡æ–™è®€å–ä¸­...</div>
    </div>

    <div id="company-info-area"></div>
    <div id="results-area"></div>
</div>

<script>
    // ğŸ”¥ V3 æ–°åˆç´„åœ°å€
    const contractAddress = "0x3984025D6BfaecC4bFDFb9B3b3889427f4764F4D";
    
    // ğŸ”¥ V3 ABI
    const contractABI = [
        { "inputs": [ { "internalType": "string", "name": "_companyName", "type": "string" } ], "name": "getProductsByCompany", "outputs": [ { "internalType": "string[]", "name": "", "type": "string[]" } ], "stateMutability": "view", "type": "function" },
        { "inputs": [ { "internalType": "string", "name": "_id", "type": "string" } ], "name": "getProduct", "outputs": [ { "internalType": "string", "name": "", "type": "string" }, { "internalType": "string", "name": "", "type": "string" }, { "internalType": "string", "name": "", "type": "string" }, { "internalType": "string", "name": "", "type": "string" }, { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" },
        { "inputs": [ { "internalType": "string", "name": "_id", "type": "string" } ], "name": "getHistory", "outputs": [ { "components": [ { "internalType": "string", "name": "date", "type": "string" }, { "internalType": "string", "name": "transporter", "type": "string" }, { "internalType": "string", "name": "action", "type": "string" }, { "internalType": "string", "name": "note", "type": "string" }, { "internalType": "uint256", "name": "phi", "type": "uint256" }, { "internalType": "uint256", "name": "timestamp", "type": "uint256" } ], "internalType": "struct AgProductV3.Record[]", "name": "", "type": "tuple[]" } ], "stateMutability": "view", "type": "function" },
        { "inputs": [ { "internalType": "string", "name": "_name", "type": "string" } ], "name": "getCompanyInfo", "outputs": [ { "internalType": "string", "name": "", "type": "string" }, { "internalType": "string", "name": "", "type": "string" }, { "internalType": "string", "name": "", "type": "string" }, { "internalType": "bool", "name": "", "type": "bool" } ], "stateMutability": "view", "type": "function" }
    ];

    // ä½¿ç”¨å…¬é–‹ç¯€é» (Binance Testnet)
    let web3 = new Web3("https://data-seed-prebsc-1-s1.binance.org:8545");
    let contract = new web3.eth.Contract(contractABI, contractAddress);
    let searchMode = 'company';

    function setMode(mode) {
        searchMode = mode;
        document.querySelectorAll('.t-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('results-area').innerHTML = "";
        document.getElementById('company-info-area').innerHTML = "";
        document.getElementById('query-input').value = "";
        
        if(mode === 'company') {
            document.getElementById('search-title').innerText = "æŸ¥è©¢å…¬å¸ç”¢å“";
            document.getElementById('query-input').placeholder = "è¼¸å…¥å…¬å¸åç¨± (ä¾‹å¦‚: å¿«æ¨‚è¾²å ´)";
        } else {
            document.getElementById('search-title').innerText = "æŸ¥è©¢å–®ä¸€ç”¢å“ ID";
            document.getElementById('query-input').placeholder = "è¼¸å…¥ç”¢å“ ID (ä¾‹å¦‚: P001)";
        }
    }

    async function handleSearch() {
        const query = document.getElementById('query-input').value.trim();
        if(!query) return alert("è«‹è¼¸å…¥å…§å®¹");
        
        document.getElementById('loading').style.display = 'block';
        document.getElementById('results-area').innerHTML = "";
        document.getElementById('company-info-area').innerHTML = "";

        try {
            if (searchMode === 'company') {
                // 1. é¡¯ç¤ºå…¬å¸è³‡æ–™ (V3æ–°åŠŸèƒ½)
                const compInfo = await contract.methods.getCompanyInfo(query).call();
                if(compInfo[3]) { // isRegistered
                    document.getElementById('company-info-area').innerHTML = `
                        <div class="company-profile-card">
                            <img src="${compInfo[2] || 'https://via.placeholder.com/100?text=Logo'}" class="cp-img" onerror="this.src='https://via.placeholder.com/100?text=Logo'">
                            <div>
                                <h3 style="margin:0; color:#1565c0;">${query}</h3>
                                <p style="margin:5px 0; font-size:0.9em; color:#555;"><i class="fas fa-phone"></i> ${compInfo[0]}</p>
                                <p style="margin:5px 0; color:#333;">${compInfo[1]}</p>
                            </div>
                        </div>`;
                }

                // 2. æ‰¾ç”¢å“åˆ—è¡¨
                const ids = await contract.methods.getProductsByCompany(query).call();
                if(ids.length === 0) {
                    document.getElementById('results-area').innerHTML = `<p style='text-align:center;'>æ‰¾ä¸åˆ°ã€Œ${query}ã€çš„ç”¢å“ã€‚</p>`;
                } else {
                    for(let id of ids) await loadProductData(id);
                }
            } else {
                await loadProductData(query);
            }
        } catch (e) {
            console.error(e);
            alert("æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– ID");
        }
        document.getElementById('loading').style.display = 'none';
    }

    async function loadProductData(id) {
        try {
            const p = await contract.methods.getProduct(id).call();
            const history = await contract.methods.getHistory(id).call();

            let html = `
            <div class="result-card">
                <div class="card-header">
                    <div style="font-weight:bold;"><i class="fas fa-building"></i> ${p[3]}</div>
                    <div style="background:rgba(255,255,255,0.2); padding:3px 10px; border-radius:10px;">ID: ${p[0]}</div>
                </div>
                <div class="card-body">
                    <img src="${p[4] || 'https://via.placeholder.com/150'}" class="product-img" onerror="this.src='https://via.placeholder.com/150'">
                    <div style="flex:1;">
                        <h3 style="margin:0 0 10px 0;">${p[1]}</h3>
                        <div style="color:#555;"><i class="fas fa-map-marker-alt"></i> ç”¢åœ°: ${p[2]}</div>
                        <div style="color:#555; margin-top:5px;"><i class="fas fa-clock"></i> ç‹€æ…‹: ${history.length > 0 ? history[history.length-1].action : 'å‰›è¨»å†Š'}</div>
                    </div>
                </div>
                <div class="timeline">
                    ${history.length === 0 ? '<div style="padding-left:20px; color:#999;">å°šç„¡å±¥æ­·ç´€éŒ„</div>' : ''}
                    ${history.map(h => `
                        <div class="t-item">
                            <div class="t-date">${h.date}</div>
                            <div class="t-action">${h.action}</div>
                            <div class="t-detail">
                                ${h.transporter ? `ğŸšš é‹è¼¸: ${h.transporter}<br>` : ''}
                                ${h.note ? `ğŸ“ å‚™è¨»: ${h.note}` : ''}
                                ${h.phi > 0 ? `â˜ ï¸ å®‰å…¨æ¡æ”¶æœŸ: ${h.phi} å¤©` : ''}
                            </div>
                        </div>
                    `).reverse().join('')} 
                </div>
            </div>`;
            document.getElementById('results-area').insertAdjacentHTML('beforeend', html);
        } catch (err) {
            console.log("ID error", id);
        }
    }
</script>
</body>
</html>
