<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¨â€ğŸŒ¾ å…¨æ­·ç¨‹ç”Ÿç”¢å±¥æ­· - V7</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <style>
        /* === æ¨£å¼ä¿æŒåŸæ¨£ï¼Œé‡å°åˆ—è¡¨å„ªåŒ– === */
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #f1f8e9; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: #2e7d32; margin-bottom: 10px; }
        .wallet-bar { text-align: center; margin-bottom: 30px; }
        .status-badge { background: #ffebee; color: #c62828; padding: 8px 15px; border-radius: 20px; font-weight: bold; display: inline-block; }
        .status-badge.connected { background: #e8f5e9; color: #2e7d32; }

        h3 { border-left: 5px solid #4caf50; padding-left: 12px; color: #388e3c; margin-top: 40px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        
        label { display: block; margin: 8px 0 5px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        
        button { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: 0.3s; }
        .btn-green { background: #2e7d32; color: white; }
        .btn-blue { background: #1565c0; color: white; }
        .btn-orange { background: #f57c00; color: white; }

        /* æ™‚é–“è»¸æ¨£å¼ */
        .result-box { margin-top: 20px; padding: 25px; background: white; border-radius: 12px; display: none; border: 1px solid #e0e0e0; }
        .product-header { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .product-img { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; background: #eee; }

        .timeline { position: relative; padding-left: 30px; margin-top: 20px; list-style: none; }
        .timeline:before { content: ''; position: absolute; left: 6px; top: 0; bottom: 0; width: 2px; background: #e0e0e0; }
        
        .timeline-item { position: relative; margin-bottom: 30px; }
        .timeline-dot { 
            position: absolute; left: -31px; top: 0; 
            width: 14px; height: 14px; border-radius: 50%; 
            background: #bdbdbd; border: 3px solid white; 
            box-shadow: 0 0 0 2px #e0e0e0; 
        }

        /* ä¸åŒå‹•ä½œçš„é¡è‰² */
        .t-plant .timeline-dot { background: #8d6e63; box-shadow: 0 0 0 3px #d7ccc8; } /* ç¨®æ¤-å’–å•¡è‰² */
        .t-fert .timeline-dot { background: #ffca28; box-shadow: 0 0 0 3px #ffecb3; } /* æ–½è‚¥-é»ƒè‰² */
        .t-pest .timeline-dot { background: #ef5350; box-shadow: 0 0 0 3px #ffcdd2; } /* æ–½è—¥-ç´…è‰² */
        .t-harvest .timeline-dot { background: #66bb6a; box-shadow: 0 0 0 3px #c8e6c9; } /* æ¡æ”¶-ç¶ è‰² */
        .t-logistics .timeline-dot { background: #42a5f5; box-shadow: 0 0 0 3px #bbdefb; } /* ç‰©æµ-è—è‰² */

        .timeline-date { font-size: 0.85em; color: #888; margin-bottom: 4px; }
        .timeline-title { font-weight: bold; font-size: 1.1em; color: #333; }
        .timeline-desc { font-size: 0.95em; color: #666; margin-top: 4px; background: #f9f9f9; padding: 8px; border-radius: 6px; display: inline-block;}
        
        .pesticide-box { display: none; background: #ffebee; border: 2px solid #ef5350; padding: 20px; border-radius: 8px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ‘¨â€ğŸŒ¾ è¾²å¤«ç”Ÿç”¢ç®¡ç† - å…¨æ­·ç¨‹ (V7)</h1>
    
    <div class="wallet-bar">
        <span id="wallet-status" class="status-badge">ğŸ”´ éŒ¢åŒ…æœªé€£ç·š</span>
        <button onclick="checkConnection()" style="width: auto; padding: 5px 15px; margin-left: 10px;">ğŸ”— é€£ç·šéŒ¢åŒ…</button>
    </div>

    <h3>1. è¨»å†Šæ–°ç”¢å“</h3>
    <div class="form-grid">
        <div><label>ç”¢å“ ID</label><input type="text" id="p-id" placeholder="P001"></div>
        <div><label>ç”¢å“åç¨±</label><input type="text" id="p-name" placeholder="ç‰å¥³ç•ªèŒ„"></div>
        <div><label>ç”¢åœ°</label><input type="text" id="p-location" value="å˜‰ç¾©å¤ªä¿"></div>
        <div><label>ç”Ÿç”¢è€…</label><input type="text" id="p-farmer" value="é™³å¤§è¾²"></div>
        <div class="full-width"><label>ç…§ç‰‡é€£çµ</label><input type="text" id="p-photo" placeholder="https://..."></div>
    </div>
    <button class="btn-green" onclick="registerProduct()">âœ… è¨»å†Šç”¢å“</button>

    <h3>2. æ–°å¢ç´€éŒ„ (æœƒä¸€ç›´ç–ŠåŠ )</h3>
    <div class="form-grid">
        <div class="full-width"><label>ç”¢å“ ID</label><input type="text" id="rec-id"></div>
        <div>
            <label>ä½œæ¥­ç¨®é¡</label>
            <select id="rec-process" onchange="handleProcessChange()">
                <option value="ç¨®æ¤">ğŸŒ± ç¨®æ¤</option>
                <option value="æ–½è‚¥">ğŸ’© æ–½è‚¥</option>
                <option value="æ–½è—¥">â˜ ï¸ æ–½è—¥</option>
                <option value="æ¡æ”¶">ğŸŒ¾ æ¡æ”¶</option>
                <option value="ç‰©æµ">ğŸšš ç‰©æµå‡ºè²¨</option>
            </select>
        </div>
        <div><label>æ—¥æœŸ</label><input type="date" id="rec-date"></div>
    </div>

    <div id="normal-inputs" style="margin-top: 15px;">
        <label>è©³ç´°å…§å®¹</label><input type="text" id="rec-detail" placeholder="ä¾‹å¦‚: ä½¿ç”¨æœ‰æ©Ÿè‚¥">
    </div>

    <div id="pesticide-inputs" class="pesticide-box">
        <h4 style="margin:0 0 10px 0; color:#c62828;">âš ï¸ æ–½è—¥è³‡æ–™</h4>
        <div class="form-grid">
            <div><label>è—¥å</label><input type="text" id="pest-name"></div>
            <div><label>PHI (å¤©)</label><input type="number" id="pest-phi" placeholder="å®‰å…¨æ¡æ”¶æœŸ"></div>
        </div>
    </div>

    <div style="margin-top:15px;"><label>å‚™è¨»</label><input type="text" id="rec-note"></div>
    <button class="btn-blue" onclick="addRecord()">â• æ–°å¢ç´€éŒ„</button>

    <h3>3. å®Œæ•´å±¥æ­·æŸ¥è©¢</h3>
    <div style="display:flex; gap:10px;">
        <input type="text" id="query-id" placeholder="è¼¸å…¥ ID æŸ¥è©¢å®Œæ•´æµç¨‹">
        <button class="btn-orange" style="width: 150px;" onclick="checkHistory()">ğŸ” æŸ¥è©¢æ­·å²</button>
    </div>
    
    <div id="result-box" class="result-box"></div>
</div>

<script>
    // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
    // è«‹å¡«å…¥ä½ å‰›å‰›éƒ¨ç½²çš„ V7 åˆç´„åœ°å€
    const contractAddress = "0xf7ACEF0084b480F240643eaF9e292E7dd4B46d8F"; 
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    const contractABI = [
        {"inputs":[{"internalType":"string","name":"_id","type":"string"},{"internalType":"string","name":"_name","type":"string"},{"internalType":"string","name":"_location","type":"string"},{"internalType":"string","name":"_farmer","type":"string"},{"internalType":"string","name":"_photoUrl","type":"string"}],"name":"registerProduct","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"string","name":"_id","type":"string"},{"internalType":"string","name":"_date","type":"string"},{"internalType":"string","name":"_action","type":"string"},{"internalType":"string","name":"_note","type":"string"},{"internalType":"uint256","name":"_phi","type":"uint256"},{"internalType":"uint256","name":"_dateTimestamp","type":"uint256"}],"name":"addHistory","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"getProductInfo","outputs":[{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"},{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"string","name":"_id","type":"string"}],"name":"getProductHistory","outputs":[{"components":[{"internalType":"string","name":"date","type":"string"},{"internalType":"string","name":"action","type":"string"},{"internalType":"string","name":"note","type":"string"},{"internalType":"uint256","name":"phi","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"internalType":"struct AgroChainV7.Record[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"}
    ];

    let web3, contract;

    async function checkConnection() {
        if (window.ethereum) {
            web3 = new Web3(window.ethereum);
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            const accounts = await web3.eth.getAccounts();
            contract = new web3.eth.Contract(contractABI, contractAddress);
            document.getElementById('wallet-status').innerText = "ğŸŸ¢ å·²é€£ç·š";
            document.getElementById('wallet-status').className = "status-badge connected";
            return true;
        } else {
            alert("è«‹å®‰è£ MetaMask");
            return false;
        }
    }

    async function registerProduct() {
        if (!await checkConnection()) return;
        const id = document.getElementById("p-id").value;
        const name = document.getElementById("p-name").value;
        const location = document.getElementById("p-location").value;
        const farmer = document.getElementById("p-farmer").value;
        const photo = document.getElementById("p-photo").value;
        const accounts = await web3.eth.getAccounts();
        
        try {
            await contract.methods.registerProduct(id, name, location, farmer, photo).send({ from: accounts[0] });
            alert("è¨»å†ŠæˆåŠŸï¼");
        } catch(e) { alert("å¤±æ•—: " + e.message); }
    }

    async function addRecord() {
        if (!await checkConnection()) return;
        const id = document.getElementById("rec-id").value;
        const type = document.getElementById("rec-process").value;
        const date = document.getElementById("rec-date").value;
        const noteRaw = document.getElementById("rec-note").value;
        
        let actionStr = "", phi = 0;
        if (type === "æ–½è—¥") {
            const pName = document.getElementById("pest-name").value;
            const pPhi = document.getElementById("pest-phi").value;
            actionStr = `æ–½è—¥: ${pName}`;
            phi = parseInt(pPhi);
        } else {
            const detail = document.getElementById("rec-detail").value;
            actionStr = `${type}: ${detail}`;
        }
        
        const timestamp = Math.floor(new Date(date).getTime() / 1000);
        const accounts = await web3.eth.getAccounts();

        try {
            await contract.methods.addHistory(id, date, actionStr, noteRaw, phi, timestamp).send({ from: accounts[0] });
            alert("ç´€éŒ„æ–°å¢æˆåŠŸï¼");
        } catch(e) { alert("å¤±æ•—: " + e.message); }
    }

    // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šè®€å–ä¸¦é¡¯ç¤ºæ‰€æœ‰æ­·å²ç´€éŒ„
    async function checkHistory() {
        if (!await checkConnection()) return;
        const id = document.getElementById("query-id").value;
        const box = document.getElementById("result-box");
        
        try {
            // 1. æŠ“åŸºæœ¬è³‡æ–™
            const info = await contract.methods.getProductInfo(id).call();
            // 2. æŠ“æ­·å²åˆ—è¡¨ (Array)
            const history = await contract.methods.getProductHistory(id).call();
            
            // å¦‚æœæ²’è³‡æ–™
            if (!info[0]) return alert("æŸ¥ç„¡æ­¤ ID");
            
            box.style.display = "block";

            // çµ„åˆåŸºæœ¬è³‡æ–™ HTML
            let html = `
                <div class="product-header">
                    <img src="${info[3]}" class="product-img" onerror="this.src='https://via.placeholder.com/100'">
                    <div>
                        <h2 style="margin:0; color:#2e7d32;">${info[0]}</h2>
                        <p>ç”Ÿç”¢è€…: ${info[2]}</p>
                        <p>ç”¢åœ°: ${info[1]}</p>
                    </div>
                </div>
                <ul class="timeline">
                    <li class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-date">---</div>
                        <div class="timeline-title">ğŸ“ ç”¢å“è¨»å†Š</div>
                        <div class="timeline-desc">å»ºç«‹å±¥æ­·æª”æ¡ˆ</div>
                    </li>
            `;

            // ç”¨è¿´åœˆ (Loop) æŠŠæ¯ä¸€ç­†æ­·å²ç´€éŒ„åŠ é€²å»
            // å…ˆå° history æŒ‰æ™‚é–“æ’åº (ä»¥å…å€å¡Šéˆå›å‚³é †åºäº‚æ‰ï¼Œé›–é€šå¸¸ä¸æœƒ)
            // history æ˜¯ Solidity struct array, è½‰æˆ JS array
            
            history.forEach(rec => {
                // æ ¹æ“šå‹•ä½œåˆ¤æ–·é¡è‰²æ¨£å¼
                let cssClass = "";
                if(rec.action.includes("ç¨®æ¤")) cssClass = "t-plant";
                else if(rec.action.includes("æ–½è‚¥")) cssClass = "t-fert";
                else if(rec.action.includes("æ–½è—¥")) cssClass = "t-pest";
                else if(rec.action.includes("æ¡æ”¶")) cssClass = "t-harvest";
                else if(rec.action.includes("ç‰©æµ")) cssClass = "t-logistics";

                html += `
                    <li class="timeline-item ${cssClass}">
                        <div class="timeline-dot"></div>
                        <div class="timeline-date">${rec.date}</div>
                        <div class="timeline-title">${rec.action}</div>
                        <div class="timeline-desc">${rec.note || "ç„¡å‚™è¨»"}</div>
                    </li>
                `;
            });

            html += `</ul>`;
            box.innerHTML = html;

        } catch(e) {
            console.error(e);
            alert("æŸ¥è©¢éŒ¯èª¤ï¼Œè«‹ç¢ºèª ID æ˜¯å¦æ­£ç¢º");
        }
    }

    function handleProcessChange() {
        const type = document.getElementById("rec-process").value;
        if (type === "æ–½è—¥") {
            document.getElementById("pesticide-inputs").style.display = "block";
            document.getElementById("normal-inputs").style.display = "none";
        } else {
            document.getElementById("pesticide-inputs").style.display = "none";
            document.getElementById("normal-inputs").style.display = "block";
        }
    }
</script>

</body>
</html>

